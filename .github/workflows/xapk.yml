name: Make Universal APK (x86 & ARM)

on:
  workflow_dispatch:

jobs:
  universal-repack:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Build Tools & Apktool
        run: |
          # 1. 设置 Android Build Tools
          BUILD_TOOLS_PATH=$(ls -d $ANDROID_HOME/build-tools/* | sort -V | tail -n 1)
          echo "$BUILD_TOOLS_PATH" >> $GITHUB_PATH
          
          # 2. 安装最新版 Apktool (处理 Split APK 需要较新版本)
          APKTOOL_VER="2.10.0"
          wget -q https://raw.githubusercontent.com/iBotPeaches/Apktool/master/scripts/linux/apktool
          wget -q https://bitbucket.org/iBotPeaches/apktool/downloads/apktool_$APKTOOL_VER.jar -O apktool.jar
          chmod +x apktool apktool.jar
          sudo mv apktool /usr/local/bin/
          sudo mv apktool.jar /usr/local/bin/

      - name: Prepare & Unzip XAPK
        id: unzip_xapk
        run: |
          # 合并分卷
          echo "Merging split files..."
          cat $(ls res/*.00* | sort) > temp_combined.zip
          
          # 解压最外层
          unzip -o temp_combined.zip -d xapk_content
          
          # 找到里面的 .xapk 文件
          XAPK_FILE=$(find xapk_content -name "*.xapk" | head -n 1)
          echo "Found XAPK: $XAPK_FILE"
          
          # 解压 .xapk 到 workspace 目录 (XAPK 本质是 ZIP)
          unzip -o "$XAPK_FILE" -d workspace
          
          # 检查是否是 Split APK 结构 (含有 base.apk 和 config.*.apk)
          if [ -f "workspace/base.apk" ]; then
            echo "Detected Split APK structure."
          else
            echo "Error: This looks like an OBB XAPK or unrecognized format. This script handles Split APKs."
            ls -R workspace
            exit 1
          fi

      - name: Merge Splits into Universal APK
        run: |
          cd workspace
          
          echo "=== 1. Decompiling Base APK ==="
          apktool d base.apk -o decoded_base
          
          echo "=== 2. Merging Libraries and Assets from Splits ==="
          # 遍历所有 config 开头的 apk
          for split in config.*.apk; do
            [ -e "$split" ] || continue
            echo "Processing split: $split"
            
            # 临时解包分片
            apktool d "$split" -o "decoded_$split"
            
            # A. 合并 Native Libraries (.so 文件) - 关键步骤！
            # 将 x86, x86_64, arm64-v8a 等所有库都拷进去
            if [ -d "decoded_$split/lib" ]; then
              echo "  Found libs in $split, copying..."
              cp -r "decoded_$split/lib/"* "decoded_base/lib/" || true
            fi
            
            # B. 合并 Assets (部分游戏把资源放在 assets 分片里)
            if [ -d "decoded_$split/assets" ]; then
              echo "  Found assets in $split, copying..."
              cp -r "decoded_$split/assets/"* "decoded_base/assets/" || true
            fi
            
            # C. 合并未知的 APK 根目录文件 (如 kotlin 文件夹等)
            # 注意：不要覆盖 AndroidManifest.xml 和 apktool.yml
            # 这里简单处理，如果不是 lib/assets/res 就不动，防止冲突
            
            # 清理临时解包
            rm -rf "decoded_$split"
          done
          
          echo "=== 3. Patching AndroidManifest.xml ==="
          # 去除 isSplitRequired="true" 属性，否则单 APK 无法安装
          # 去除 splitTypes 等元数据
          sed -i 's/android:isSplitRequired="true"//g' decoded_base/AndroidManifest.xml
          sed -i 's/android:extractNativeLibs="false"/android:extractNativeLibs="true"/g' decoded_base/AndroidManifest.xml
          
          # (可选) 如果有 Application 节点包含 android:name="com.google.android.play.core.splitcompat.SplitCompatApplication"
          # 可能需要移除或替换，但在纯 APK 环境下通常保留也没事
          
          echo "=== 4. Rebuilding APK ==="
          apktool b decoded_base -o universal.apk --use-aapt2
          
          # 移动到上层准备签名
          mv universal.apk ../universal.apk

      - name: Sign APK
        run: |
          # 生成 Keystore
          keytool -genkey -v -keystore debug.keystore \
            -storepass android -alias androiddebugkey -keypass android \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -dname "CN=Android Debug,O=Android,C=US"

          # 签名
          apksigner sign --ks debug.keystore \
            --ks-key-alias androiddebugkey \
            --ks-pass pass:android \
            --key-pass pass:android \
            universal.apk
            
          apksigner verify universal.apk

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: universal-apk-x86-arm
          path: universal.apk
