name: Unzip, Repack XAPK to APK

on:
  workflow_dispatch:
  push:
    paths:
      - 'res/*.00*'       # 监听分卷文件变化
      - 'res/*.zip'       
      - '.github/workflows/*.yml'

jobs:
  convert-and-sign:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true # 开启 LFS 以防分卷文件很大

      - name: Checkout xapk-to-apk Tool
        uses: actions/checkout@v4
        with:
          repository: LuigiVampa92/xapk-to-apk
          path: tools/xapk-to-apk

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Dependencies
        run: |
          # 配置 Android Build Tools
          BUILD_TOOLS_PATH=$(ls -d $ANDROID_HOME/build-tools/* | sort -V | tail -n 1)
          echo "Using Android Build Tools: $BUILD_TOOLS_PATH"
          echo "$BUILD_TOOLS_PATH" >> $GITHUB_PATH
          
          # 安装 Apktool
          APKTOOL_VER="2.10.0"
          wget -q https://raw.githubusercontent.com/iBotPeaches/Apktool/master/scripts/linux/apktool
          wget -q https://bitbucket.org/iBotPeaches/apktool/downloads/apktool_$APKTOOL_VER.jar -O apktool.jar
          chmod +x apktool apktool.jar
          sudo mv apktool /usr/local/bin/
          sudo mv apktool.jar /usr/local/bin/

      - name: Process Files (Merge -> Unzip -> Locate XAPK)
        id: prepare_file
        run: |
          # 1. 合并分卷文件
          echo "Merging split files..."
          # 将所有 .00* 文件合并为一个临时 zip
          cat $(ls res/*.00* | sort) > combined_outer.zip
          
          # 2. 解压外层 ZIP 提取 XAPK
          echo "Unzipping outer archive..."
          unzip -o combined_outer.zip -d extracted_files
          
          # 3. 查找解压出来的 .xapk 文件
          # find 命令查找 extracted_files 目录下的 .xapk 文件
          XAPK_PATH=$(find extracted_files -name "*.xapk" | head -n 1)
          
          if [ -z "$XAPK_PATH" ]; then
            echo "Error: No .xapk file found inside the zip archive!"
            ls -R extracted_files
            exit 1
          fi
          
          echo "Found XAPK at: $XAPK_PATH"
          
          # 将找到的 xapk 路径保存到环境变量，供后续步骤使用
          echo "XAPK_PATH=$XAPK_PATH" >> $GITHUB_ENV

      - name: Convert XAPK to APK
        run: |
          echo "Converting $XAPK_PATH ..."
          python tools/xapk-to-apk/xapktoapk.py "$XAPK_PATH"

      - name: Sign APK
        run: |
          # 脚本通常会在 xapk 同级目录下生成同名的 .apk 文件
          # 例如：xxx.xapk -> xxx.apk
          # 我们利用 bash 字符串替换获取预期的 APK 路径
          INPUT_XAPK="${{ env.XAPK_PATH }}"
          OUTPUT_APK="${INPUT_XAPK%.*}.apk"
          
          if [ ! -f "$OUTPUT_APK" ]; then
            echo "Error: Output APK not found at $OUTPUT_APK"
            exit 1
          fi

          echo "Signing $OUTPUT_APK..."

          # 生成 Debug Keystore
          keytool -genkey -v -keystore debug.keystore \
            -storepass android -alias androiddebugkey -keypass android \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -dname "CN=Android Debug,O=Android,C=US"

          # 签名
          apksigner sign --ks debug.keystore \
            --ks-key-alias androiddebugkey \
            --ks-pass pass:android \
            --key-pass pass:android \
            "$OUTPUT_APK"
          
          # 将最终的 APK 路径保存，供上传步骤使用
          echo "FINAL_APK_PATH=$OUTPUT_APK" >> $GITHUB_ENV

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: final-converted-apk
          path: ${{ env.FINAL_APK_PATH }}
