name: Repack XAPK to APK

on:
  workflow_dispatch: # 允许手动触发

jobs:
  repack-and-sign:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java (Required for apktool & signer)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install dependencies (7z & Apktool)
        run: |
          # 更新 apt 并安装 7zip
          sudo apt-get update
          sudo apt-get install -y p7zip-full
          
          # 安装最新版 Apktool (apt源的版本通常太旧)
          wget https://raw.githubusercontent.com/iBotPeaches/Apktool/master/scripts/linux/apktool -O apktool
          wget https://bitbucket.org/iBotPeaches/apktool/downloads/apktool_2.9.3.jar -O apktool.jar
          chmod +x apktool
          sudo mv apktool /usr/local/bin/
          sudo mv apktool.jar /usr/local/bin/
          
          # 验证 apktool 安装
          apktool -version

      - name: Setup Android Build Tools Path
        run: |
          # 查找已安装的 build-tools 路径并添加到 PATH
          BUILD_TOOLS_DIR=$(find $ANDROID_HOME/build-tools -maxdepth 1 -type d | sort -V | tail -n 1)
          echo "Found build-tools at: $BUILD_TOOLS_DIR"
          echo "$BUILD_TOOLS_DIR" >> $GITHUB_PATH
          
          # 验证 zipalign 和 apksigner 是否可用
          $BUILD_TOOLS_DIR/zipalign --version || echo "zipalign found"

      - name: Extract XAPK from Split Zip
        run: |
          # 确保 res 目录存在
          if [ ! -d "res" ]; then
            echo "Error: res directory not found!"
            exit 1
          fi
          
          # 解压分卷 zip (只需指定第一个文件 .001，7z 会自动处理后续部分)
          # -o 指定输出目录为当前工作目录
          7z x res/6.1.0.zip.001 -o./
          
          # 检查解压结果
          if [ -f "6.1.0.xapk" ]; then
            echo "Successfully extracted 6.1.0.xapk"
          else
            echo "Error: 6.1.0.xapk not found after extraction!"
            ls -R
            exit 1
          fi

      - name: Checkout Converter Tool
        uses: actions/checkout@v4
        with:
          repository: LuigiVampa92/xapk-to-apk
          path: xapk-tool-repo

      - name: Run XAPK to APK Conversion
        run: |
          # 运行转换脚本
          # 脚本依赖：apktool, zipalign (已在 PATH 中)
          python3 xapk-tool-repo/xapktoapk.py 6.1.0.xapk
          
          echo "Conversion finished. Checking files..."
          ls -lh

      - name: Sign APK (Default Debug Keystore)
        run: |
          # 查找转换生成的 APK (通常同名，但后缀为 .apk)
          INPUT_APK="6.1.0.apk"
          SIGNED_APK="6.1.0-signed.apk"
          
          if [ ! -f "$INPUT_APK" ]; then
            echo "Error: $INPUT_APK not found. Conversion might have failed."
            exit 1
          fi

          # 1. 生成默认 Debug Keystore
          echo "Generating debug keystore..."
          keytool -genkey -v -keystore debug.keystore \
            -storepass android -alias androiddebugkey -keypass android \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -dname "CN=Android Debug,O=Android,C=US"

          # 2. 签名 (apksigner 会自动处理 zip 对齐检查，但为了保险我们也可以先手动对齐)
          echo "Signing APK..."
          apksigner sign --ks debug.keystore --ks-pass pass:android \
            --key-pass pass:android --out "$SIGNED_APK" "$INPUT_APK"
            
          echo "Verify signature..."
          apksigner verify "$SIGNED_APK"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Repacked-APK-6.1.0
          path: 6.1.0-signed.apk
