name: System Chrome Playwright Bot
on: 
  workflow_dispatch:

jobs:
  playwright-bot:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:22.04
      options: --privileged --shm-size=2gb
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. å®‰è£…ç³»ç»Ÿç¯å¢ƒã€Chrome å’Œ Python
      - name: Install System & Dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          apt-get update
          # å®‰è£…åŸºç¡€å·¥å…· + Python3
          apt-get install -y wget curl git net-tools sudo vim unzip xz-utils \
                             python3 python3-pip xvfb x11vnc \
                             libgbm1 libnss3 libasound2 libatk-bridge2.0-0 libgtk-3-0
          
          # === æ ¸å¿ƒï¼šå®‰è£…ç³»ç»Ÿçº§ Google Chrome ===
          wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          apt-get install -y ./google-chrome-stable_current_amd64.deb
          rm google-chrome-stable_current_amd64.deb
          
          # === ä»…å®‰è£… Python åº“ï¼Œä¸è¿è¡Œ playwright install ===
          pip3 install playwright tf-playwright-stealth
          
          # å®‰è£… XFCE4 (VNCæ¡Œé¢)
          apt-get install -y dbus-x11 xfce4 xfce4-goodies xfce4-terminal
          
          # å‡†å¤‡ç”¨æˆ·ç›®å½•
          useradd -m -s /bin/bash appuser
          echo "appuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers
          su appuser -c "mkdir -p /home/appuser/Downloads"

      # 2. å¯åŠ¨ XFCE æ¡Œé¢
      - name: Start Virtual Desktop (Xvfb)
        run: |
          service dbus start || true
          
          cat <<EOF > /home/appuser/run_desktop.sh
          #!/bin/bash
          export DISPLAY=:99
          # 1440x900 åˆ†è¾¨ç‡
          Xvfb :99 -screen 0 1440x900x24 &
          sleep 2
          startxfce4 &
          x11vnc -display :99 -forever -bg -noxdamage
          EOF
          
          chmod +x /home/appuser/run_desktop.sh
          su appuser -c "/home/appuser/run_desktop.sh"
          
          # é˜²æ­¢é”å±
          su appuser -c "export DISPLAY=:99; xset s off; xset -dpms; xset s noblank"

      # 3. ç¼–å†™ Python è‡ªåŠ¨åŒ–è„šæœ¬ (æŒ‡å®š executable_path)
      - name: Create Python Automation Script
        run: |
          cat <<EOF > /home/appuser/bot.py
          import time
          import os
          from playwright.sync_api import sync_playwright
          from playwright_stealth import stealth_sync

          TARGET_URL = "https://decrypt.day/app/id1489932710"
          DOWNLOAD_DIR = "/home/appuser/Downloads"

          def run():
              with sync_playwright() as p:
                  print("ğŸš€ Launching System Google Chrome...")
                  
                  # === æ ¸å¿ƒä¿®æ”¹ï¼šæŒ‡å®š executable_path ===
                  browser = p.chromium.launch(
                      # å¼ºåˆ¶ä½¿ç”¨ç³»ç»Ÿå®‰è£…çš„ Chrome è·¯å¾„
                      executable_path="/usr/bin/google-chrome", 
                      
                      headless=False, # å¿…é¡»ä¸º False æ‰èƒ½é…åˆ Xvfb ç»•è¿‡æ£€æµ‹
                      
                      # é˜²æ£€æµ‹å‚æ•°
                      args=[
                          "--disable-blink-features=AutomationControlled",
                          "--start-maximized",
                          "--no-sandbox",
                          "--disable-infobars",
                          "--disable-dev-shm-usage" # å®¹å™¨ç¯å¢ƒæ¨èåŠ ä¸Šè¿™ä¸ª
                      ]
                  )
                  
                  context = browser.new_context(
                      viewport={"width": 1440, "height": 900},
                      user_agent="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
                      accept_downloads=True
                  )
                  
                  page = context.new_page()
                  
                  # åº”ç”¨ Stealth (æ©ç›–æŒ‡çº¹)
                  stealth_sync(page)

                  print(f"ğŸŒ Navigating to {TARGET_URL}...")
                  
                  try:
                      page.goto(TARGET_URL, timeout=90000)
                      
                      # æˆªå›¾è°ƒè¯• 1
                      page.screenshot(path="/home/appuser/Downloads/1_loaded.png")
                      
                      # === ä½ çš„ä¸šåŠ¡é€»è¾‘ ===
                      # è¿™é‡Œä»…ä»…æ˜¯ç­‰å¾…ç¤ºä¾‹ï¼Œä½ éœ€è¦æ ¹æ®å®é™…é¡µé¢è¡¥å……ç‚¹å‡»é€»è¾‘
                      # ä¾‹å¦‚: page.get_by_text("Download").click()
                      
                      # ç¤ºä¾‹ï¼šæ£€æµ‹æ ‡é¢˜
                      print(f"Page Title: {page.title()}")
                      
                      # æ¨¡æ‹Ÿé¼ æ ‡ç§»åŠ¨
                      page.mouse.move(200, 200)
                      time.sleep(1)
                      page.mouse.move(500, 400)
                      
                      # å¦‚æœé¡µé¢æœ‰è‡ªåŠ¨ä¸‹è½½ï¼Œæˆ–è€…ä½ ç‚¹å‡»äº†ä¸‹è½½æŒ‰é’®ï¼Œç­‰å¾…ä¸‹è½½å®Œæˆ
                      # è¿™é‡Œè®¾ç½®ä¸€ä¸ªé•¿æ—¶é—´ç­‰å¾…æ–¹ä¾¿ä½ åœ¨ VNC é‡Œè§‚å¯Ÿ
                      time.sleep(1000)
                      
                      page.screenshot(path="/home/appuser/Downloads/2_finished.png")
                      
                  except Exception as e:
                      print(f"âŒ Error: {e}")
                      page.screenshot(path="/home/appuser/Downloads/error.png")
                  finally:
                      browser.close()

          if __name__ == "__main__":
              run()
          EOF

      # 4. å»ºç«‹ VNC è¿æ¥ (å¯é€‰)
      - name: Setup Cloudflare Tunnel (VNC)
        run: |
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          dpkg -i cloudflared.deb
          cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          echo "Waiting for Tunnel..."
          for i in $(seq 1 10); do
            TUNNEL_URL=$(grep -oE "https://[a-zA-Z0-9-]+\.trycloudflare\.com" tunnel.log | head -1)
            if [ -n "$TUNNEL_URL" ]; then
                echo "Found Tunnel URL: $TUNNEL_URL"
                break
            fi
            sleep 1
          done
          
          echo "=========================================================="
          echo "ğŸ–¥ï¸  XFCE Desktop Ready!"
          echo "ğŸ”—  VNC Link: $TUNNEL_URL/vnc.html?autoconnect=true"
          echo "=========================================================="

      # 5. è¿è¡Œ Python è„šæœ¬
      - name: Run Playwright Bot
        run: |
          export DISPLAY=:99
          # æ— éœ€è¿è¡Œ playwright installï¼Œç›´æ¥è·‘è„šæœ¬
          su appuser -c "python3 /home/appuser/bot.py > /home/appuser/chrome.log 2>&1 &" 
          tail -f /home/appuser/chrome.log

      # 6. ä¸Šä¼ æˆªå›¾å’Œä¸‹è½½æ–‡ä»¶
      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bot-results
          path: /home/appuser/Downloads/
