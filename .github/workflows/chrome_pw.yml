name: Chrome XFCE Desktop VNC + Playwright CDP
on: 
  workflow_dispatch:

jobs:
  chrome-user:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:22.04
      options: --privileged --shm-size=2gb
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. å®‰è£…åŸºç¡€ç¯å¢ƒ + XFCE4 + Chrome + Python Pip
      - name: Install System & Desktop & Chrome
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          apt-get update
          # ğŸ” å¢åŠ  python3-pip ç”¨äºå®‰è£… playwright
          apt-get install -y wget curl git net-tools sudo vim unzip xz-utils libgbm1 libnss3 libasound2 python3-pip
          
          # === å®‰è£… Google Chrome ===
          wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          apt-get install -y ./google-chrome-stable_current_amd64.deb
          rm google-chrome-stable_current_amd64.deb
          
          # å®‰è£…å­—ä½“
          apt-get install -y fonts-liberation fonts-noto-color-emoji fontconfig ttf-mscorefonts-installer
          
          # === å®‰è£… XFCE4 ===
          apt-get install -y xvfb x11vnc python3 pulseaudio dbus-x11 xfce4 xfce4-goodies xfce4-terminal
          
          echo "ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true" | debconf-set-selections
          fc-cache -f -v
          
          # å®‰è£… noVNC
          git clone https://github.com/novnc/noVNC.git /opt/noVNC
          git clone https://github.com/novnc/websockify /opt/noVNC/utils/websockify
          ln -s /opt/noVNC/vnc.html /opt/noVNC/index.html
          chmod -R 777 /opt/noVNC

      # 2. å®‰è£… Playwright åº“ (ä¸éœ€è¦ install-deps æˆ– install chromeï¼Œå› ä¸ºæˆ‘ä»¬åªç”¨ client)
      - name: Install Python Playwright
        run: |
          pip3 install playwright
          # è¿™ä¸€æ­¥ä¸æ˜¯å¿…é¡»çš„ï¼Œå› ä¸ºæˆ‘ä»¬ç”¨æœ¬åœ° Chromeï¼Œä½†å®‰è£…å®ƒå¯ä»¥é˜²æ­¢ç¼ºå°‘æŸäº›åº•å±‚ä¾èµ–
          playwright install-deps chromium 

      # 3. åˆ›å»ºç”¨æˆ· & é…ç½® Chrome åçˆ¬ç­–ç•¥
      - name: Setup User & Chrome Preferences
        run: |
          useradd -m -s /bin/bash appuser
          echo "appuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers
          
          su appuser -c "mkdir -p /home/appuser/Downloads"
          su appuser -c "mkdir -p /home/appuser/Desktop"
          
          # === Chrome æ ¸å¿ƒé…ç½® ===
          CONFIG_DIR="/home/appuser/.config/google-chrome/Default"
          su appuser -c "mkdir -p $CONFIG_DIR"
          
          su appuser -c "cat <<EOF > $CONFIG_DIR/Preferences
          {
            \"download\": {
              \"default_directory\": \"/home/appuser/Downloads\",
              \"prompt_for_download\": false,
              \"directory_upgrade\": true
            },
            \"savefile\": {
              \"default_directory\": \"/home/appuser/Downloads\"
            },
            \"profile\": {
              \"default_content_settings\": {
                \"popups\": 1,
                \"notifications\": 1
              },
              \"content_settings\": {
                \"exceptions\": {
                  \"automatic_downloads\": {
                    \"https://decrypt.day,*\": { \"setting\": 1 }
                  }
                }
              }
            },
            \"credentials_enable_service\": false,
            \"password_manager_enabled\": false
          }
          EOF"

      # 4. å¯åŠ¨ XFCE æ¡Œé¢
      - name: Start XFCE Desktop
        run: |
          service dbus start || true
          
          cat <<EOF > /home/appuser/run_desktop.sh
          #!/bin/bash
          export DISPLAY=:99
          export HOME=/home/appuser
          
          Xvfb :99 -screen 0 1440x900x24 &
          sleep 2
          
          export XFCE_PANEL_MIGRATE_DEFAULT=true
          startxfce4 &
          
          x11vnc -display :99 -forever -bg -noxdamage
          /opt/noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
          EOF
          
          chmod +x /home/appuser/run_desktop.sh
          su appuser -c "/home/appuser/run_desktop.sh"
          
          sleep 5
          su appuser -c "export DISPLAY=:99; xset s off; xset -dpms; xset s noblank"

      # 5. å¯åŠ¨ Chrome (å¸¦é˜²æ£€æµ‹å‚æ•° + è°ƒè¯•ç«¯å£)
      - name: Launch Chrome & Cloudflare Tunnel
        run: |
          cat <<EOF > /home/appuser/run_chrome.sh
          #!/bin/bash
          export DISPLAY=:99
          export HOME=/home/appuser
          
          # === ğŸ” æ ¸å¿ƒä¿®æ”¹ï¼šå¢åŠ  --remote-debugging-port=9222 ===
          # è¿™å…è®¸ Playwright é€šè¿‡ CDP åè®®è¿æ¥åˆ°è¿™ä¸ªå·²ç»å¯åŠ¨çš„æµè§ˆå™¨å®ä¾‹
          
          nohup google-chrome-stable \\
            --no-first-run \\
            --no-default-browser-check \\
            --disable-infobars \\
            --disable-blink-features=AutomationControlled \\
            --password-store=basic \\
            --start-maximized \\
            --remote-debugging-port=9222 \\
            --user-data-dir=/home/appuser/.config/google-chrome \\
            "https://decrypt.day/app/id1489932710" > /home/appuser/chrome.log 2>&1 &
          EOF
          
          chmod +x /home/appuser/run_chrome.sh
          su appuser -c "/home/appuser/run_chrome.sh"
          
          echo "Chrome launching..."
          sleep 10 # ç­‰å¾… Chrome å®Œå…¨å¯åŠ¨å¹¶ç›‘å¬ç«¯å£
          
          # Cloudflare Tunnel
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          dpkg -i cloudflared.deb
          cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          echo "Waiting for Tunnel..."
          for i in $(seq 1 10); do
            TUNNEL_URL=$(grep -oE "https://[a-zA-Z0-9-]+\.trycloudflare\.com" tunnel.log | head -1)
            if [ -n "$TUNNEL_URL" ]; then
                echo "Found Tunnel URL: $TUNNEL_URL"
                break
            fi
            sleep 1
          done
          
          echo "=========================================================="
          echo "ğŸ–¥ï¸  XFCE Desktop Ready!"
          echo "ğŸ”—  VNC Link: $TUNNEL_URL/vnc.html?autoconnect=true"
          echo "=========================================================="

      # 6. ğŸ” æ–°å¢æ­¥éª¤ï¼šPlaywright CDP è¿æ¥éªŒè¯
      - name: Run Playwright PoC Script
        run: |
          # åˆ›å»º Python è„šæœ¬
          cat <<EOF > poc_script.py
          from playwright.sync_api import sync_playwright
          import time

          def run():
              try:
                  print(">>> æ­£åœ¨å°è¯•è¿æ¥æœ¬åœ° Chrome (Port 9222)...")
                  with sync_playwright() as p:
                      # 1. è¿æ¥åˆ°å·²å­˜åœ¨çš„æµè§ˆå™¨ (ä¸å¯åŠ¨æ–°å®ä¾‹)
                      browser = p.chromium.connect_over_cdp("http://localhost:9222")
                      
                      # 2. è·å–å½“å‰çš„ä¸Šä¸‹æ–‡å’Œé¡µé¢
                      context = browser.contexts[0]
                      # è¿™é‡Œçš„ page å°±æ˜¯åˆšæ‰è„šæœ¬å¯åŠ¨æ—¶æ‰“å¼€çš„ decrypt.day é¡µé¢
                      page = context.pages[0] 
                      
                      print(f">>> è¿æ¥æˆåŠŸ! å½“å‰é¡µé¢æ ‡é¢˜: {page.title()}")
                      
                      # 3. å¯ä»¥åœ¨è¿™é‡Œåšä¸€äº›è‡ªåŠ¨åŒ–çš„æ“ä½œéªŒè¯
                      # ä¾‹å¦‚ï¼šç­‰å¾…æŸä¸ªå…ƒç´ å‡ºç°ï¼Œæˆ–è€…æˆªå›¾
                      page.wait_for_load_state("domcontentloaded")
                      
                      # æˆªå›¾éªŒè¯ (ä¿å­˜åˆ°ä¸‹è½½ç›®å½•æ–¹ä¾¿æŸ¥çœ‹ artifact)
                      screenshot_path = "/home/appuser/Downloads/poc_proof.png"
                      page.screenshot(path=screenshot_path)
                      print(f">>> æˆªå›¾å·²ä¿å­˜è‡³: {screenshot_path}")

                      # 4. è·å–ä¸€äº›åçˆ¬æ£€æµ‹æ‰€éœ€çš„æŒ‡çº¹ä¿¡æ¯æ¥éªŒè¯æ˜¯å¦ç”Ÿæ•ˆ
                      webdriver_flag = page.evaluate("navigator.webdriver")
                      print(f">>> navigator.webdriver çŠ¶æ€: {webdriver_flag}")
                      
                      # æ³¨æ„ï¼šä¸è¦è°ƒç”¨ browser.close()ï¼Œå¦åˆ™ä¼šæŠŠ VNC é‡Œçš„æµè§ˆå™¨å…³æ‰
                      # åªéœ€è¦æ–­å¼€ CDP è¿æ¥
                      time.sleep(1000)
                      browser.disconnect()
                      print(">>> Playwright è„šæœ¬æ‰§è¡Œå®Œæ¯•ï¼Œæµè§ˆå™¨ä¿æŒè¿è¡Œã€‚")
                      
              except Exception as e:
                  print(f"!!! è„šæœ¬æ‰§è¡Œå‡ºé”™: {e}")
                  exit(1)

          if __name__ == "__main__":
              run()
          EOF

          # æ‰§è¡Œè„šæœ¬ (æ³¨æ„ï¼šå› ä¸º Chrome æ˜¯ appuser å¯åŠ¨çš„ï¼Œä½†ç«¯å£æ˜¯ localhostï¼Œroot ä¹Ÿå¯ä»¥è¿)
          # ä¸ºäº†æ–‡ä»¶æƒé™ç»Ÿä¸€ï¼Œå»ºè®®ç”¨ su appuser æ‰§è¡Œï¼Œæˆ–è€… root æ‰§è¡Œä½†æ³¨æ„å†™å…¥è·¯å¾„
          # è¿™é‡Œç›´æ¥è¿è¡Œ python3 å³å¯
          tail -n 20 /home/appuser/chrome.log
          su appuser -c "python3 poc_script.py"

      # 7. ç›‘æ§ä¸‹è½½ (ä¿æŒä¸å˜)
      - name: Monitor Download (Wait for IPA)
        timeout-minutes: 30
        run: |
          TARGET_DIR="/home/appuser/Downloads"
          MAX_SIZE_MB=100
          
          echo "Starting monitoring loop in $TARGET_DIR"
          
          while true; do
            FILE=$(find "$TARGET_DIR" -name "*.ipa" -print -quit)
            
            if [ -n "$FILE" ]; then
              BASENAME=$(basename "$FILE")
              if [ -f "${FILE}.crdownload" ]; then
                 echo "â³ Downloading (crdownload present): $BASENAME..."
              else
                 SIZE_MB=$(du -m "$FILE" | cut -f1)
                 if [ "$SIZE_MB" -le "$MAX_SIZE_MB" ]; then
                   echo "âš ï¸ Found $BASENAME ($SIZE_MB MB), waiting for full file..."
                 else
                   echo "âœ… Success: $BASENAME ($SIZE_MB MB)"
                   break
                 fi
              fi
            else
               echo "Waiting for download..."
            fi
            sleep 5
          done
          
          echo "Download confirmed."

      # 8. ä¸Šä¼ äº§ç‰© (åŒ…å« IPA å’Œ PoC æˆªå›¾)
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: downloaded-files
          path: |
            /home/appuser/Downloads/*.ipa
            /home/appuser/Downloads/*.png