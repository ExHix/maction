name: Chrome XFCE Desktop VNC (Auto)
on: 
  workflow_dispatch:

jobs:
  chrome-user:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:22.04
      # å¢åŠ  --shm-size é˜²æ­¢ Chrome å´©æºƒ (Chrome å¯¹å†…å­˜å…±äº«è¦æ±‚å¾ˆé«˜)
      options: --privileged --shm-size=2gb
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. å®‰è£…åŸºç¡€ç¯å¢ƒ + XFCE4 + Chrome
      - name: Install System & Desktop (XFCE4) & Chrome
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          apt-get update
          # å®‰è£…åŸºç¡€å·¥å…· (æ·»åŠ äº† python3-pip)
          apt-get install -y wget curl git net-tools sudo vim unzip xz-utils libgbm1 libnss3 libasound2 python3-pip
          
          # === ä»¥ä¸‹ä¿æŒä¸å˜ ===
          wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          apt-get install -y ./google-chrome-stable_current_amd64.deb
          rm google-chrome-stable_current_amd64.deb
          apt-get install -y fonts-liberation fonts-noto-color-emoji fontconfig ttf-mscorefonts-installer
          apt-get install -y xvfb x11vnc python3 pulseaudio dbus-x11 xfce4 xfce4-goodies xfce4-terminal
          echo "ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true" | debconf-set-selections
          fc-cache -f -v
          git clone https://github.com/novnc/noVNC.git /opt/noVNC
          git clone https://github.com/novnc/websockify /opt/noVNC/utils/websockify
          ln -s /opt/noVNC/vnc.html /opt/noVNC/index.html
          chmod -R 777 /opt/noVNC

          # å®‰è£… DrissionPage
          pip3 install playwright tf-playwright-stealth
          playwright install-deps chromium

      # 2. åˆ›å»ºç”¨æˆ· & é…ç½® Chrome åçˆ¬ç­–ç•¥
      - name: Setup User & Chrome Preferences
        run: |
          useradd -m -s /bin/bash appuser
          echo "appuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers
          
          # åˆ›å»ºç›®å½•
          su appuser -c "mkdir -p /home/appuser/Downloads"
          su appuser -c "mkdir -p /home/appuser/Desktop"
          
          # === Chrome æ ¸å¿ƒé…ç½® ===
          # åˆ›å»º Chrome é»˜è®¤é…ç½®ç›®å½•
          CONFIG_DIR="/home/appuser/.config/google-chrome/Default"
          su appuser -c "mkdir -p $CONFIG_DIR"
          
          # å†™å…¥ Preferences æ–‡ä»¶ (JSONæ ¼å¼)
          # 1. è®¾ç½®ä¸‹è½½ç›®å½•å¹¶ç¦æ­¢å¼¹çª—
          # 2. ç¦ç”¨å‡­è¯æœåŠ¡
          # 3. å…è®¸å¼¹å‡ºçª—å£ (é˜²æ­¢ä¸‹è½½è¢«æ‹¦æˆª)
          su appuser -c "cat <<EOF > $CONFIG_DIR/Preferences
          {
            \"download\": {
              \"default_directory\": \"/home/appuser/Downloads\",
              \"prompt_for_download\": false,
              \"directory_upgrade\": true
            },
            \"savefile\": {
              \"default_directory\": \"/home/appuser/Downloads\"
            },
            \"profile\": {
              \"default_content_settings\": {
                \"popups\": 1,
                \"notifications\": 1
              },
              \"content_settings\": {
                \"exceptions\": {
                  \"automatic_downloads\": {
                    \"https://decrypt.day,*\": { \"setting\": 1 }
                  }
                }
              }
            },
            \"credentials_enable_service\": false,
            \"password_manager_enabled\": false
          }
          EOF"

      # 3. å¯åŠ¨ XFCE æ¡Œé¢
      - name: Start XFCE Desktop
        run: |
          service dbus start || true
  
          cat <<EOF > /home/appuser/run_desktop.sh
          #!/bin/bash
          export DISPLAY=:99
          export HOME=/home/appuser
          Xvfb :99 -screen 0 1440x900x24 &
          sleep 2
          export XFCE_PANEL_MIGRATE_DEFAULT=true
          startxfce4 &
          x11vnc -display :99 -forever -bg -noxdamage
          /opt/noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
          EOF
          
          chmod +x /home/appuser/run_desktop.sh
          su appuser -c "/home/appuser/run_desktop.sh"
          
          sleep 5
          su appuser -c "export DISPLAY=:99; xset s off; xset -dpms; xset s noblank"

      # 4. å¯åŠ¨ Chrome (é€šè¿‡ Playwright è‡ªåŠ¨åŒ–) & Cloudflare Tunnel
      - name: Cloudflare Tunnel
        run: |
          # Cloudflare Tunnel
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          dpkg -i cloudflared.deb
          cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          echo "Waiting for Tunnel..."
          for i in $(seq 1 10); do
            TUNNEL_URL=$(grep -oE "https://[a-zA-Z0-9-]+\.trycloudflare\.com" tunnel.log | head -1)
            if [ -n "$TUNNEL_URL" ]; then
                echo "Found Tunnel URL: $TUNNEL_URL"
                break
            fi
            sleep 1
          done
          
          echo "=========================================================="
          echo "ğŸ–¥ï¸  XFCE Desktop Ready!"
          echo "ğŸ”—  VNC Link: $TUNNEL_URL/vnc.html?autoconnect=true"
          echo "=========================================================="
      
      - name: Launch Chrome
        run: |
        
          cat <<'EOF' > /home/appuser/get_ipa.py
          from playwright.sync_api import sync_playwright
          from playwright_stealth import stealth_sync
          import playwright.sync_api
          import time
          import os, json

          # \u5b9a\u4e49\u914d\u7f6e\u8def\u5f84\uff08\u4e0e\u4e4b\u524d Shell \u811a\u672c\u4fdd\u6301\u4e00\u81f4\uff09
          USER_DATA_DIR = '/home/appuser/.config/google-chrome'
          EXECUTABLE_PATH = '/usr/bin/google-chrome-stable'
          base_url = "https://decrypt.day/app/id1489932710"

          ENABLE_DEBUG_PAUSE = False
          def debug_pause(msg: str):
              global ENABLE_DEBUG_PAUSE
              if not ENABLE_DEBUG_PAUSE:
                  return
              
              input(f"[DEBUG PAUSE] {msg}")

          with sync_playwright() as p:
              print("\U0001f680 \u6b63\u5728\u542f\u52a8 Playwright (System Chrome)...")
              
              # \u4f7f\u7528 launch_persistent_context \u4ee5\u4fdd\u6301 UserDataDir \u548c\u914d\u7f6e
              browser = p.chromium.launch(
                  #user_data_dir=USER_DATA_DIR,
                  executable_path=EXECUTABLE_PATH,
                  headless=False,  # \u5fc5\u987b\u4e3a False \u624d\u80fd\u5728 VNC \u770b\u5230
                  #viewport=None,   # \u7981\u7528\u9ed8\u8ba4\u89c6\u53e3\u5927\u5c0f\uff0c\u8ddf\u968f\u7a97\u53e3
                  args=[
                      '--no-sandbox',
                      '--disable-gpu',
                      # === \u6838\u5fc3\u53cd\u722c\u53c2\u6570 ===
                      # '--disable-blink-features=AutomationControlled', 
                      # '--start-maximized',
                      # '--no-first-run',
                      # '--no-default-browser-check',
                      # '--disable-dev-shm-usage',
                  ],
                  ignore_default_args=["--enable-automation"],
              )
              
              # \u83b7\u53d6\u9ed8\u8ba4\u9875\u9762\u6216\u65b0\u5efa\u9875\u9762
              # print("New pages...")
              # page = browser.new_page()
              
              # # === \u989d\u5916\u53cd\u722c\u63aa\u65bd\uff1a\u79fb\u9664 navigator.webdriver \u5c5e\u6027 ===
              # # DrissionPage \u9ed8\u8ba4\u4f1a\u81ea\u52a8\u5904\u7406\u8fd9\u4e2a\uff0cPlaywright \u9700\u8981\u624b\u52a8\u6ce8\u5165
              # page.add_init_script("Object.defineProperty(navigator, 'webdriver', {get: () => undefined})")
              
              # print("\U0001f517 \u6b63\u5728\u8bbf\u95ee\u76ee\u6807\u9875\u9762...")
              # try:
              #     page.goto('https://decrypt.day/app/id1489932710', timeout=60000)
              #     print("\u2705 \u9875\u9762\u52a0\u8f7d\u5b8c\u6210")
              # except Exception as e:
              #     print(f"\u26a0\ufe0f \u9875\u9762\u52a0\u8f7d\u53ef\u80fd\u8d85\u65f6: {e}")

              # # \u4fdd\u6301\u8fd0\u884c\uff0c\u7b49\u5f85 VNC \u67e5\u770b\u6216\u540e\u7eed\u64cd\u4f5c
              # while True:
              #     time.sleep(10)
              context = browser.new_context(
                      #user_agent=user_agent,
                      #viewport={"width": 1280, "height": 800},
                      #locale="zh-CN",
                      #timezone_id="Asia/Shanghai"
                  )
              context.add_init_script("""
                  Object.defineProperty(navigator, 'webdriver', {
                      get: () => undefined
                  });
              """)

              # Open info page
              page = context.new_page()
              page.goto(base_url, timeout=60000)

              page.wait_for_load_state("domcontentloaded")
              
              if "Just a moment" in page.title() or "Cloudflare" in page.title() or "cf" in page.url:
                  print("\n" + "="*50)
                  print("[!] ??? Cloudflare ?????")
                  print("[!] ????? Firefox ??????????")
                  print("[!] ????????????????????????...")
                  print("="*50 + "\n")
                  # input(">>> ???????????????...")
              else:
                  print("[-] ?????????????...")

              page.wait_for_load_state("domcontentloaded")

              
              debug_pause(">>> ?????? POST ??...")

              # fetch download link via JS fetch
              result = page.evaluate("""
                  async () => {
                      const formData = new FormData();
                      formData.append('data', '163,101,97,112,112,73,100,120,25,99,108,57,115,101,52,48,116,113,48,48,97,98,100,111,102,119,113,116,103,111,118,48,122,115,103,118,101,114,115,105,111,110,101,54,46,50,46,48,105,105,115,80,114,101,109,105,101,114,247');

                      const resp = await fetch('$BASE_PAGE_URL$?/files', {
                          method: 'POST',
                          body: formData,
                      });
                      return await resp.text();
                  }
              """.replace("$BASE_PAGE_URL$", base_url))
              # print(type(result))
              # print(result)
              assert isinstance(result, str), f"Invalid response type: {type(result)}"

              try:
                  download_page_req = json.loads(result)
                  assert download_page_req.get("type") == "success", f"Failed when request download path: {download_page_req}"
                  dl_page_details: list = json.loads(download_page_req.get("data"))
              except json.JSONDecodeError as e:
                  raise ValueError(f"Invalid JSON: {e}\nRequest result: {result}")
              
              free_dl_path = ""
              try:
                  free_dl_path = dl_page_details[dl_page_details.index("gofile.io") - 3]
              except IndexError:
                  # fallback
                  print("[!] Fallback: scanning for valid download path...")
                  for e in dl_page_details:
                      if not (isinstance(e, str) and len(e) == 21):
                          continue
                      free_dl_path = e
                      break
              
              # goto download page
              if not free_dl_path:
                  raise ValueError(f"Cannot get download page path. Request: {download_page_req}")

              download_page_url = f"{base_url}/dl/{free_dl_path}"
              print(f"[-] Download Page: {download_page_url}")

              dl_page = context.new_page()
              dl_page.goto(download_page_url, referer=base_url)

              btn = dl_page.locator("button.btn-download").filter(has_text="Get download link")

              btn.click()
              # btn.scroll_into_view_if_needed()
              # box = btn.bounding_box()
              # assert box is not None, "No box found"

              # center_x = box["x"] + box["width"] / 2
              # center_y = box["y"] + box["height"] / 2
              # dl_page.mouse.move(center_x, center_y)
              # dl_page.mouse.click(center_x, center_y)

              print("??????...")
              time.sleep(5)

              # click button
              # def handle_response(response: playwright.sync_api.Response):
              #     if "https://decrypt.day/" in response.url and response.request.method == "POST":
              #         print(f"\n[?????]: {response.url}")
              #         try:
              #             # ??????????? JSON?
              #             data = response.json()
              #             print(f"[????]: {json.dumps(data, indent=2, ensure_ascii=False)}")
              #         except Exception:
              #             print("[???? JSON ??]")

              # # ????
              # dl_page.on("response", handle_response)
              
              time.sleep(5)

              print("????...")
              btn = dl_page.locator("button.btn-download")#.filter(has_text="Download")
              
              with dl_page.expect_download() as download_info:
                  btn.click()

              download = download_info.value

              # 3. æŒ‡å®šä½ æƒ³è¦çš„ä¸‹è½½è·¯å¾„
              # æ¯”å¦‚ä½ æƒ³ä¸‹è½½åˆ° /home/appuser/Downloads å¹¶ä¿ç•™åŸå§‹æ–‡ä»¶å
              import re
              regex = r'\d+\.\d+\.\d+'

              match = re.search(regex, download.suggested_filename)
              if match:
                  version = match.group()
                  print(f"æå–ç»“æœ: {version}")
              else:
                  version = f"unknown_{download.suggested_filename}"

              download_path = os.path.join("/home/appuser/Downloads", f"{version}.ipa")
    
              # 4. æ‰§è¡Œä¿å­˜æ“ä½œ
              download.save_as(download_path)

              print(f"âœ… æ–‡ä»¶å·²æˆåŠŸä¿å­˜è‡³: {download_path}")

              debug_pause(">>> ?????????...")

              print("[Script] \u6d4f\u89c8\u5668\u4fdd\u6301\u5f00\u542f\uff0c\u7b49\u5f85 Action \u7ed3\u675f...")
              
              time.sleep(5)
              print("Exited")

          EOF

          chown appuser:appuser /home/appuser/get_ipa.py
          chmod +x /home/appuser/get_ipa.py

          touch /home/appuser/bot.log
          chmod 666 /home/appuser/bot.log

          cat <<EOF > /home/appuser/run_bot.sh
          #!/bin/bash
          export DISPLAY=:99
          export HOME=/home/appuser
          export LIBGL_ALWAYS_SOFTWARE=1
          
          #nohup python3 -u /home/appuser/get_ipa.py > /home/appuser/bot.log 2>&1 &
          python3 -u /home/appuser/get_ipa.py
          EOF
          
          echo "ğŸ¤– Script running..."


          chmod +x /home/appuser/run_bot.sh
          su appuser -c "/home/appuser/run_bot.sh"
          
          
      # 5. ç›‘æ§ä¸‹è½½ (é€»è¾‘ä¸å˜)
      - name: Monitor Download (Wait for IPA)
        timeout-minutes: 30
        run: |
          TARGET_DIR="/home/appuser/Downloads"
          MAX_SIZE_MB=100
          
          echo "Starting monitoring loop in $TARGET_DIR"
          
          while true; do
            # Chrome ä¸‹è½½ä¸´æ—¶æ–‡ä»¶é€šå¸¸æ˜¯ .crdownload
            FILE=$(find "$TARGET_DIR" -name "*.ipa" -print -quit)
            
            if [ -n "$FILE" ]; then
              BASENAME=$(basename "$FILE")
              
              # æ£€æŸ¥ Chrome çš„ä¸´æ—¶æ–‡ä»¶åç¼€
              if [ -f "${FILE}.crdownload" ]; then
                 echo "â³ Downloading (crdownload present): $BASENAME..."
              else
                 # åŒé‡æ£€æŸ¥æ–‡ä»¶å¤§å°å˜åŒ–ï¼Œç¡®ä¿ä¸‹è½½å®Œæˆ
                 SIZE_MB=$(du -m "$FILE" | cut -f1)
                 
                 # ç®€å•çš„é˜²è¯¯åˆ¤ï¼šå¦‚æœæ–‡ä»¶å¤ªå°ï¼Œå¯èƒ½è¿˜æ²¡å¼€å§‹å†™çœŸæ­£çš„æ•°æ®
                 if [ "$SIZE_MB" -le "$MAX_SIZE_MB" ]; then
                   echo "âš ï¸ Found $BASENAME ($SIZE_MB MB), waiting for full file..."
                 else
                   echo "âœ… Success: $BASENAME ($SIZE_MB MB)"
                   break
                 fi
              fi
            else
               echo "Waiting for download..."
            fi
            sleep 5
          done
          
          echo "Download confirmed."

      # 6. ä¸Šä¼ äº§ç‰©
      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: decrypted-app
          path: /home/appuser/Downloads/*.ipa