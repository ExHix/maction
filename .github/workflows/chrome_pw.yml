name: Playwright Chrome Automation
on: 
  workflow_dispatch:

jobs:
  playwright-bot:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:22.04
      options: --privileged --shm-size=2gb
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. å®‰è£…ç³»ç»Ÿç¯å¢ƒã€Chrome å’Œ Python
      - name: Install System & Dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          apt-get update
          # å®‰è£…åŸºç¡€å·¥å…· + Python3
          apt-get install -y wget curl git net-tools sudo vim unzip xz-utils \
                             python3 python3-pip xvfb x11vnc \
                             libgbm1 libnss3 libasound2 libatk-bridge2.0-0 libgtk-3-0
          
          # å®‰è£… Google Chrome (æ­£å¼ç‰ˆæ¯” Chromium æ›´éš¾è¢«æ£€æµ‹)
          wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          apt-get install -y ./google-chrome-stable_current_amd64.deb
          rm google-chrome-stable_current_amd64.deb
          
          # å®‰è£… Python ä¾èµ–
          # playwright: è‡ªåŠ¨åŒ–æ ¸å¿ƒ
          # playwright-stealth: ä¸“é—¨ç”¨äºéšè—è‡ªåŠ¨åŒ–ç‰¹å¾çš„åº“
          pip3 install playwright playwright-stealth
          
          # å®‰è£… Playwright é©±åŠ¨ (è¿™é‡Œåªå®‰è£… chrome ç›¸å…³çš„é©±åŠ¨å³å¯ï¼Œä½†æˆ‘ä»¬éœ€è¦è®© playwright è¯†åˆ«ç³»ç»Ÿ chrome)
          playwright install-deps
          
          # å®‰è£… XFCE4 (ç”¨äº VNC è§‚å¯Ÿï¼Œå¯é€‰ä½†æ¨è)
          apt-get install -y dbus-x11 xfce4 xfce4-goodies xfce4-terminal
          
          # å‡†å¤‡ç”¨æˆ·ç›®å½•
          useradd -m -s /bin/bash appuser
          echo "appuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers
          su appuser -c "mkdir -p /home/appuser/Downloads"

      # 2. å¯åŠ¨ XFCE æ¡Œé¢ (åå°è¿è¡Œ)
      - name: Start Virtual Desktop (Xvfb)
        run: |
          service dbus start || true
          
          # å¯åŠ¨è„šæœ¬
          cat <<EOF > /home/appuser/run_desktop.sh
          #!/bin/bash
          export DISPLAY=:99
          Xvfb :99 -screen 0 1440x900x24 &
          sleep 2
          startxfce4 &
          x11vnc -display :99 -forever -bg -noxdamage
          EOF
          
          chmod +x /home/appuser/run_desktop.sh
          su appuser -c "/home/appuser/run_desktop.sh"
          
          # ä¼˜åŒ–æ˜¾ç¤ºè®¾ç½®é˜²æ­¢é»‘å±
          su appuser -c "export DISPLAY=:99; xset s off; xset -dpms; xset s noblank"

      # 3. ç¼–å†™ Playwright è‡ªåŠ¨åŒ–è„šæœ¬
      - name: Create Python Automation Script
        run: |
          cat <<EOF > /home/appuser/bot.py
          import time
          import os
          from playwright.sync_api import sync_playwright
          from playwright_stealth import stealth_sync

          # é…ç½®
          TARGET_URL = "https://decrypt.day/app/id1489932710"
          DOWNLOAD_DIR = "/home/appuser/Downloads"

          def run():
              with sync_playwright() as p:
                  # === é˜²æ£€æµ‹æ ¸å¿ƒé…ç½® ===
                  # 1. ä½¿ç”¨ 'chrome' é€šé“ï¼Œè°ƒç”¨çœŸå®çš„ Google Chrome
                  # 2. disable-blink-features=AutomationControlled æ˜¯æœ€å…³é”®çš„å‚æ•°
                  # 3. headless=False: åœ¨æœ‰ UI ç¯å¢ƒä¸‹è¿è¡Œï¼Œæéš¾è¢«æ£€æµ‹
                  browser = p.chromium.launch(
                      channel="chrome",
                      headless=False, 
                      args=[
                          "--disable-blink-features=AutomationControlled",
                          "--start-maximized",
                          "--no-sandbox",
                          "--disable-infobars"
                      ]
                  )
                  
                  # åˆ›å»ºä¸Šä¸‹æ–‡ï¼Œæ¨¡æ‹ŸçœŸå® UserAgent å’Œ è§†å£
                  context = browser.new_context(
                      viewport={"width": 1440, "height": 900},
                      user_agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
                      accept_downloads=True
                  )
                  
                  page = context.new_page()
                  
                  # === åº”ç”¨ stealth æ’ä»¶ (ç§»é™¤ navigator.webdriver ç­‰ç‰¹å¾) ===
                  stealth_sync(page)

                  print(f"ğŸš€ Navigating to {TARGET_URL}...")
                  page.goto(TARGET_URL, timeout=60000)
                  
                  # æˆªå›¾ä»¥ä¾¿åœ¨ Artifacts ä¸­è°ƒè¯•æŸ¥çœ‹
                  page.screenshot(path="/home/appuser/Downloads/debug_page_load.png")
                  
                  # === è‡ªåŠ¨åŒ–é€»è¾‘ (ç¤ºä¾‹) ===
                  # è¿™é‡Œéœ€è¦æ ¹æ® decrypt.day çš„å®é™… DOM ç»“æ„ä¿®æ”¹
                  # å‡è®¾æœ‰ä¸€ä¸ª "Download" æŒ‰é’®ï¼Œæˆ–è€…éœ€è¦ç™»å½•
                  
                  print("Waiting for page load...")
                  
                  # ç¤ºä¾‹ï¼šæ£€æµ‹ Cloudflare éªŒè¯
                  if "Just a moment" in page.title():
                      print("âš ï¸ Cloudflare challenge detected, waiting...")
                      time.sleep(10)
                  
                  # --- åœºæ™¯ A: è‡ªåŠ¨è§¦å‘ä¸‹è½½ (ç¤ºä¾‹) ---
                  # ä½¿ç”¨ expect_download æ•è·ä¸‹è½½äº‹ä»¶
                  try:
                      # è¿™é‡Œçš„é€»è¾‘éœ€è¦ä½ æ ¹æ®å®é™…ç½‘é¡µè°ƒæ•´
                      # ä¾‹å¦‚ï¼šç‚¹å‡»é¡µé¢ä¸Šçš„æŸä¸ªæŒ‰é’®
                      # page.get_by_text("Download").click() 
                      
                      # å¦‚æœé¡µé¢åŠ è½½å³è‡ªåŠ¨ä¸‹è½½ï¼Œæˆ–éœ€è¦å¯»æ‰¾ç‰¹å®šæŒ‰é’®ï¼š
                      print("Looking for download triggers...")
                      
                      # æ¨¡æ‹Ÿé¼ æ ‡éšæœºç§»åŠ¨ (å¢åŠ çœŸå®æ„Ÿ)
                      page.mouse.move(100, 100)
                      page.mouse.move(500, 500)
                      
                      # æ³¨æ„ï¼šè¿™é‡Œéœ€è¦ä½ å¡«å…¥çœŸå®çš„ä¸‹è½½æŒ‰é’®é€‰æ‹©å™¨
                      # page.locator("button.download-btn").click()
                      
                      # æš‚æ—¶æŒ‚èµ·ç­‰å¾…äººå·¥è§‚å¯Ÿ (å¦‚æœæœ‰ VNC) æˆ–ç­‰å¾…è‡ªåŠ¨ä¸‹è½½
                      # å¦‚æœæ˜¯ä¸ºäº† decrypt.dayï¼Œé€šå¸¸éœ€è¦ç‚¹å‡»ç™»å½• -> ç‚¹å‡» App -> ç‚¹å‡»ä¸‹è½½
                      # ä¸‹é¢æ˜¯ä¸€ä¸ªé€šç”¨çš„ç­‰å¾…ä¸‹è½½æ¨¡å¼ï¼š
                      
                      print("Waiting for download event...")
                      # å¢åŠ è¶…æ—¶æ—¶é—´ï¼Œç­‰å¾…ä¸‹è½½å¼€å§‹
                      with page.expect_download(timeout=3200000) as download_info:
                          # è§¦å‘ä¸‹è½½çš„åŠ¨ä½œæ”¾åœ¨è¿™é‡Œï¼Œä¾‹å¦‚ç‚¹å‡»:
                          # page.get_by_role("button", name="Download IPA").click()
                          
                          # å¦‚æœä¸åšä»»ä½•æ“ä½œå®ƒå°±ä¼šå¼¹ä¸‹è½½ï¼Œåˆ™ç•™ç©ºï¼Œæˆ–è€…åªæ˜¯ç­‰å¾…
                          # ä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘ä»¬å‡è®¾é¡µé¢åŠ è½½ 5 ç§’åä¼šæœ‰ä¸‹è½½è¡Œä¸ºï¼Œæˆ–è€…ä½ å¯ä»¥é€šè¿‡ VNC æ‰‹åŠ¨ç‚¹
                          pass
                          
                      download = download_info.value
                      print(f"âœ… Download started: {download.suggested_filename}")
                      
                      # ä¿å­˜æ–‡ä»¶
                      save_path = os.path.join(DOWNLOAD_DIR, download.suggested_filename)
                      download.save_as(save_path)
                      print(f"ğŸ’¾ File saved to: {save_path}")
                      
                  except Exception as e:
                      print(f"âŒ Error or Timeout: {e}")
                      # æˆªå›¾æŠ¥é”™
                      page.screenshot(path="/home/appuser/Downloads/error_state.png")

                  # ä¿æŒæµè§ˆå™¨å¼€å¯ä¸€ä¼šï¼Œç¡®ä¿æ•°æ®å†™å…¥
                  time.sleep(5)
                  browser.close()

          if __name__ == "__main__":
              run()
          EOF

      # 4. å»ºç«‹ VNC è¿æ¥ (å¯é€‰ï¼Œæ–¹ä¾¿ä½ åœ¨ GitHub Actions è¿è¡Œæ—¶è¿›å»çœ‹)
      - name: Setup Cloudflare Tunnel (VNC)
        run: |
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          dpkg -i cloudflared.deb
          su appuser -c "cloudflared tunnel --url http://localhost:6080 > /home/appuser/tunnel.log 2>&1 &"
          
          # å®‰è£… noVNC ä»£ç† (ä¸ºäº† Web è®¿é—®)
          git clone https://github.com/novnc/noVNC.git /opt/noVNC
          git clone https://github.com/novnc/websockify /opt/noVNC/utils/websockify
          ln -s /opt/noVNC/vnc.html /opt/noVNC/index.html
          /opt/noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 --daemon

          sleep 5
          echo "ğŸ”— VNC URL (Check tunnel.log inside artifacts if not printed):"
          grep -oE "https://[a-zA-Z0-9-]+\.trycloudflare\.com" /home/appuser/tunnel.log || echo "Tunnel finding..."

      # 5. è¿è¡Œ Python è‡ªåŠ¨åŒ–è„šæœ¬
      - name: Run Playwright Bot
        run: |
          export DISPLAY=:99
          # å®‰è£… Playwright æµè§ˆå™¨ (ä»¥é˜²ä¸‡ä¸€)
          su appuser -c "python3 -m playwright install chromium"
          
          echo "Running automation..."
          su appuser -c "python3 /home/appuser/bot.py"

      # 6. ä¸Šä¼ ç»“æœ
      - name: Upload Artifacts
        if: always() # å³ä½¿å¤±è´¥ä¹Ÿä¸Šä¼ æˆªå›¾
        uses: actions/upload-artifact@v4
        with:
          name: bot-results
          path: /home/appuser/Downloads/