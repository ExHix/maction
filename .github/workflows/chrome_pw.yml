name: Chrome XFCE Desktop VNC (Auto)
on: 
  workflow_dispatch:

jobs:
  chrome-user:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:22.04
      # å¢åŠ  --shm-size é˜²æ­¢ Chrome å´©æºƒ (Chrome å¯¹å†…å­˜å…±äº«è¦æ±‚å¾ˆé«˜)
      options: --privileged --shm-size=2gb
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. å®‰è£…åŸºç¡€ç¯å¢ƒ + XFCE4 + Chrome
      - name: Install System & Desktop (XFCE4) & Chrome
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          apt-get update
          # å®‰è£…åŸºç¡€å·¥å…· (æ·»åŠ äº† python3-pip)
          apt-get install -y wget curl git net-tools sudo vim unzip xz-utils libgbm1 libnss3 libasound2 python3-pip
          
          # å®‰è£… DrissionPage
          pip3 install playwright
          
          # === ä»¥ä¸‹ä¿æŒä¸å˜ ===
          wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          apt-get install -y ./google-chrome-stable_current_amd64.deb
          rm google-chrome-stable_current_amd64.deb
          apt-get install -y fonts-liberation fonts-noto-color-emoji fontconfig ttf-mscorefonts-installer
          apt-get install -y xvfb x11vnc python3 pulseaudio dbus-x11 xfce4 xfce4-goodies xfce4-terminal
          echo "ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true" | debconf-set-selections
          fc-cache -f -v
          git clone https://github.com/novnc/noVNC.git /opt/noVNC
          git clone https://github.com/novnc/websockify /opt/noVNC/utils/websockify
          ln -s /opt/noVNC/vnc.html /opt/noVNC/index.html
          chmod -R 777 /opt/noVNC

          playwright install-deps chromium

      # 2. åˆ›å»ºç”¨æˆ· & é…ç½® Chrome åçˆ¬ç­–ç•¥
      - name: Setup User & Chrome Preferences
        run: |
          useradd -m -s /bin/bash appuser
          echo "appuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers
          
          # åˆ›å»ºç›®å½•
          su appuser -c "mkdir -p /home/appuser/Downloads"
          su appuser -c "mkdir -p /home/appuser/Desktop"
          
          # === Chrome æ ¸å¿ƒé…ç½® ===
          # åˆ›å»º Chrome é»˜è®¤é…ç½®ç›®å½•
          CONFIG_DIR="/home/appuser/.config/google-chrome/Default"
          su appuser -c "mkdir -p $CONFIG_DIR"
          
          # å†™å…¥ Preferences æ–‡ä»¶ (JSONæ ¼å¼)
          # 1. è®¾ç½®ä¸‹è½½ç›®å½•å¹¶ç¦æ­¢å¼¹çª—
          # 2. ç¦ç”¨å‡­è¯æœåŠ¡
          # 3. å…è®¸å¼¹å‡ºçª—å£ (é˜²æ­¢ä¸‹è½½è¢«æ‹¦æˆª)
          su appuser -c "cat <<EOF > $CONFIG_DIR/Preferences
          {
            \"download\": {
              \"default_directory\": \"/home/appuser/Downloads\",
              \"prompt_for_download\": false,
              \"directory_upgrade\": true
            },
            \"savefile\": {
              \"default_directory\": \"/home/appuser/Downloads\"
            },
            \"profile\": {
              \"default_content_settings\": {
                \"popups\": 1,
                \"notifications\": 1
              },
              \"content_settings\": {
                \"exceptions\": {
                  \"automatic_downloads\": {
                    \"https://decrypt.day,*\": { \"setting\": 1 }
                  }
                }
              }
            },
            \"credentials_enable_service\": false,
            \"password_manager_enabled\": false
          }
          EOF"

      # 3. å¯åŠ¨ XFCE æ¡Œé¢
      - name: Start XFCE Desktop
        run: |
          service dbus start || true
          
          cat <<EOF > /home/appuser/run_desktop.sh
          #!/bin/bash
          export DISPLAY=:99
          export HOME=/home/appuser
          
          # å¯åŠ¨ Xvfb (åˆ†è¾¨ç‡ 1440x900)
          Xvfb :99 -screen 0 1440x900x24 &
          sleep 2
          
          # å¯åŠ¨ XFCE4
          export XFCE_PANEL_MIGRATE_DEFAULT=true
          startxfce4 &
          
          # å¯åŠ¨ VNC
          x11vnc -display :99 -forever -bg -noxdamage
          
          # å¯åŠ¨ noVNC
          /opt/noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
          EOF
          
          chmod +x /home/appuser/run_desktop.sh
          su appuser -c "/home/appuser/run_desktop.sh"
          
          sleep 5
          # é˜²æ­¢é»‘å±
          su appuser -c "export DISPLAY=:99; xset s off; xset -dpms; xset s noblank"

      # 4. å¯åŠ¨ Chrome (é€šè¿‡ Playwright è‡ªåŠ¨åŒ–) & Cloudflare Tunnel
      - name: Launch Chrome & Cloudflare Tunnel
        run: |
          cat <<EOF > /home/appuser/automate.py
          from playwright.sync_api import sync_playwright
          import time
          import os

          # å®šä¹‰é…ç½®è·¯å¾„ï¼ˆä¸ä¹‹å‰ Shell è„šæœ¬ä¿æŒä¸€è‡´ï¼‰
          USER_DATA_DIR = '/home/appuser/.config/google-chrome'
          EXECUTABLE_PATH = '/usr/bin/google-chrome-stable'
          
          with sync_playwright() as p:
              print("ğŸš€ æ­£åœ¨å¯åŠ¨ Playwright (System Chrome)...")
              
              # ä½¿ç”¨ launch_persistent_context ä»¥ä¿æŒ UserDataDir å’Œé…ç½®
              browser = p.chromium.launch_persistent_context(
                  user_data_dir=USER_DATA_DIR,
                  executable_path=EXECUTABLE_PATH,
                  headless=False,  # å¿…é¡»ä¸º False æ‰èƒ½åœ¨ VNC çœ‹åˆ°
                  viewport=None,   # ç¦ç”¨é»˜è®¤è§†å£å¤§å°ï¼Œè·Ÿéšçª—å£
                  args=[
                      '--no-sandbox',
                      '--disable-gpu',
                      # === æ ¸å¿ƒåçˆ¬å‚æ•° ===
                      '--disable-blink-features=AutomationControlled', 
                      '--start-maximized',
                      '--no-first-run',
                      '--no-default-browser-check'
                  ],
                  ignore_default_args=["--enable-automation"],
              )
              
              
              # === é¢å¤–åçˆ¬æªæ–½ï¼šç§»é™¤ navigator.webdriver å±æ€§ ===
              # DrissionPage é»˜è®¤ä¼šè‡ªåŠ¨å¤„ç†è¿™ä¸ªï¼ŒPlaywright éœ€è¦æ‰‹åŠ¨æ³¨å…¥
        
              print("ğŸ”— æ­£åœ¨è®¿é—®ç›®æ ‡é¡µé¢...")
              base_url = "https://decrypt.day/app/id1489932710"

              page = browser.pages[0] if browser.pages else browser.new_page()
              page.add_init_script("Object.defineProperty(navigator, 'webdriver', {get: () => undefined})")

              page.goto(base_url, timeout=90000)
              page.wait_for_load_state("domcontentloaded")

              js_code = """
                  async () => {
                      const formData = new FormData();
                      formData.append('data', '163,101,97,112,112,73,100,120,25,99,108,57,115,101,52,48,116,113,48,48,97,98,100,111,102,119,113,116,103,111,118,48,122,115,103,118,101,114,115,105,111,110,101,54,46,50,46,48,105,105,115,80,114,101,109,105,101,114,247');
                      const resp = await fetch('""" + base_url + """?/files', {method: 'POST', body: formData});
                      return await resp.text();
                  }
              """
              result = page.evaluate(js_code)
              data_json = json.loads(result)
              dl_list = json.loads(data_json.get("data", "[]"))
              
              target_path = ""
              for item in dl_list:
                  if isinstance(item, str) and len(item) == 21:
                      target_path = item
                      break
              
              if not target_path and "gofile.io" in dl_list:
                    idx = dl_list.index("gofile.io")
                    target_path = dl_list[idx-3]

              if not target_path:
                  print("[Script] æœªæ‰¾åˆ°è·¯å¾„ï¼Œè¯·æ‰‹åŠ¨æ“ä½œã€‚")
              else:
                  dl_url = f"{base_url}/dl/{target_path}"
                  print(f"[Script] ä¸‹è½½é¡µ: {dl_url}")

              dl_page = browser.new_page()
              dl_page.add_init_script("Object.defineProperty(navigator, 'webdriver', {get: () => undefined})")
              dl_page.goto(dl_url, referer=base_url)

              # ä¿æŒè¿è¡Œï¼Œç­‰å¾… VNC æŸ¥çœ‹æˆ–åç»­æ“ä½œ
              while True:
                  time.sleep(10)
          EOF


          # Cloudflare Tunnel
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          dpkg -i cloudflared.deb
          cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          echo "Waiting for Tunnel..."
          for i in $(seq 1 10); do
            TUNNEL_URL=$(grep -oE "https://[a-zA-Z0-9-]+\.trycloudflare\.com" tunnel.log | head -1)
            if [ -n "$TUNNEL_URL" ]; then
                echo "Found Tunnel URL: $TUNNEL_URL"
                break
            fi
            sleep 1
          done
          
          echo "=========================================================="
          echo "ğŸ–¥ï¸  XFCE Desktop Ready!"
          echo "ğŸ”—  VNC Link: $TUNNEL_URL/vnc.html?autoconnect=true"
          echo "=========================================================="
          
          # åœ¨åå°è¿è¡Œè‡ªåŠ¨åŒ–è„šæœ¬
          export DISPLAY=:99
          su appuser -c "nohup python3 /home/appuser/automate.py > /home/appuser/chrome.log 2>&1 &"
          tail -f /home/appuser/chrome.log

      # 5. ç›‘æ§ä¸‹è½½ (é€»è¾‘ä¸å˜)
      - name: Monitor Download (Wait for IPA)
        timeout-minutes: 30
        run: |
          TARGET_DIR="/home/appuser/Downloads"
          MAX_SIZE_MB=100
          
          echo "Starting monitoring loop in $TARGET_DIR"
          
          while true; do
            # Chrome ä¸‹è½½ä¸´æ—¶æ–‡ä»¶é€šå¸¸æ˜¯ .crdownload
            FILE=$(find "$TARGET_DIR" -name "*.ipa" -print -quit)
            
            if [ -n "$FILE" ]; then
              BASENAME=$(basename "$FILE")
              
              # æ£€æŸ¥ Chrome çš„ä¸´æ—¶æ–‡ä»¶åç¼€
              if [ -f "${FILE}.crdownload" ]; then
                 echo "â³ Downloading (crdownload present): $BASENAME..."
              else
                 # åŒé‡æ£€æŸ¥æ–‡ä»¶å¤§å°å˜åŒ–ï¼Œç¡®ä¿ä¸‹è½½å®Œæˆ
                 SIZE_MB=$(du -m "$FILE" | cut -f1)
                 
                 # ç®€å•çš„é˜²è¯¯åˆ¤ï¼šå¦‚æœæ–‡ä»¶å¤ªå°ï¼Œå¯èƒ½è¿˜æ²¡å¼€å§‹å†™çœŸæ­£çš„æ•°æ®
                 if [ "$SIZE_MB" -le "$MAX_SIZE_MB" ]; then
                   echo "âš ï¸ Found $BASENAME ($SIZE_MB MB), waiting for full file..."
                 else
                   echo "âœ… Success: $BASENAME ($SIZE_MB MB)"
                   break
                 fi
              fi
            else
               echo "Waiting for download..."
            fi
            sleep 5
          done
          
          echo "Download confirmed."

      # 6. ä¸Šä¼ äº§ç‰©
      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: decrypted-app
          path: /home/appuser/Downloads/*.ipa