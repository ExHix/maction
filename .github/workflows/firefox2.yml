name: Firefox XFCE Desktop VNC (Playwright)
on: 
  workflow_dispatch:

jobs:
  firefox-user:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:22.04
      options: --privileged --shm-size=2gb
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. å®‰è£…åŸºç¡€ç¯å¢ƒ + XFCE4 æ¡Œé¢ + Pythonä¾è³´
      - name: Install System & Desktop (XFCE4)
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          apt-get update
          # å¢åŠ  python3-pip ç”¨äºå®‰è£… playwright
          apt-get install -y software-properties-common wget curl git net-tools sudo debconf-utils vim unzip python3-pip
          
          # æ·»åŠ  Firefox PPA
          add-apt-repository -y ppa:mozillateam/ppa
          echo '
          Package: *
          Pin: release o=LP-PPA-mozillateam
          Pin-Priority: 1001
          ' | tee /etc/apt/preferences.d/mozilla-firefox
          
          apt-get update
          
          # å®‰è£… Firefox å’Œ å­—ä½“
          apt-get install -y firefox fonts-liberation fonts-noto-color-emoji fontconfig ttf-mscorefonts-installer
          
          # å®‰è£… XFCE4 å’Œ VNC ç»„ä»¶
          apt-get install -y xvfb x11vnc pulseaudio dbus-x11 xfce4 xfce4-goodies xfce4-terminal
          
          # åŒæ„å¾®è½¯å­—ä½“åè®®
          echo "ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true" | debconf-set-selections
          fc-cache -f -v
          
          # å®‰è£… noVNC
          git clone https://github.com/novnc/noVNC.git /opt/noVNC
          git clone https://github.com/novnc/websockify /opt/noVNC/utils/websockify
          ln -s /opt/noVNC/vnc.html /opt/noVNC/index.html
          chmod -R 777 /opt/noVNC
          

      # 2. åˆ›å»ºç”¨æˆ· & é…ç½® Firefox åçˆ¬ç­–ç•¥ (ä¿æŒä¸å˜ï¼Œå› ä¸º Playwright å°†åŠ è½½æ­¤é…ç½®)
      - name: Setup User & Firefox Profile
        run: |
          useradd -m -s /bin/bash appuser
          echo "appuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers
          
          su appuser -c "mkdir -p /home/appuser/Downloads"
          su appuser -c "mkdir -p /home/appuser/Desktop"
          
          # åˆ›å»ºé…ç½®ç›®å½•ï¼ŒPlaywright å°†ä½œä¸º persistent_context åŠ è½½å®ƒ
          su appuser -c "mkdir -p /home/appuser/.mozilla/firefox/stealth.default"
          
          # profiles.ini å³ä½¿ Playwright ä¸ä¸€å®šè¯»å®ƒï¼Œä¿ç•™å®ƒä»¥é˜²ä¸‡ä¸€éœ€è¦æ‰‹åŠ¨è°ƒè¯•
          su appuser -c "cat <<EOF > /home/appuser/.mozilla/firefox/profiles.ini
          [Profile0]
          Name=default
          IsRelative=1
          Path=stealth.default
          Default=1
          
          [General]
          StartWithLastProfile=1
          Version=2
          EOF"
          
          # å†™å…¥ user.js (Playwright åŠ è½½æ­¤ç›®å½•æ—¶ä¼šè‡ªåŠ¨ç”Ÿæ•ˆè¿™äº›é…ç½®)
          su appuser -c "cat <<EOF > /home/appuser/.mozilla/firefox/stealth.default/user.js
          // 1. åŸºç¡€åçˆ¬ (ä¿æŒä¸å˜)
          user_pref(\"dom.webdriver.enabled\", false);
          user_pref(\"use_automation_extension\", false);
          user_pref(\"general.useragent.override\", \"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:120.0) Gecko/20100101 Firefox/120.0\");
          
          // 2. å¿…é¡»ç¦ç”¨çš„éšç§ä¿æŠ¤ (ä¿®å¤ AdBlock æ£€æµ‹)
          // å…³é—­å¢å¼ºè·Ÿè¸ªä¿æŠ¤
          user_pref(\"privacy.trackingprotection.enabled\", false);
          user_pref(\"privacy.trackingprotection.pbmode.enabled\", false);
          user_pref(\"privacy.trackingprotection.socialtracking.enabled\", false);
          user_pref(\"privacy.trackingprotection.cryptomining.enabled\", false);
          user_pref(\"privacy.trackingprotection.fingerprinting.enabled\", false);
          
          // å…è®¸æ‰€æœ‰ Cookie (å¾ˆå¤šå¹¿å‘Šä¾èµ–ç¬¬ä¸‰æ–¹ Cookie)
          user_pref(\"network.cookie.cookieBehavior\", 0); // 0 = Accept all
          user_pref(\"network.cookie.thirdparty.sessionOnly\", false);
          
          // 3. å…¶ä»–å¯èƒ½è§¦å‘æ£€æµ‹çš„è®¾ç½®
          user_pref(\"dom.popup_allowed_events\", \"change click dblclick mouseup notificationclick reset submit touchend\"); 
          user_pref(\"dom.disable_open_during_load\", false); // å…è®¸å¼¹çª— (æœ‰äº›å¹¿å‘Šæ˜¯å¼¹çª—)
          
          // 4. ä¿æŒ WebRTC å…³é—­ (é˜²æ­¢ IP æ³„éœ²ï¼Œå¦‚æœå¹¿å‘Šä¸€å®šéœ€è¦ WebRTC æ‰èƒ½åŠ è½½ï¼Œè¿™é‡Œå¯èƒ½éœ€è¦æ”¹å› true)
          user_pref(\"media.peerconnection.enabled\", false);
          EOF"

      # 3. å¯åŠ¨ XFCE æ¡Œé¢
      - name: Start XFCE Desktop
        run: |
          service dbus start || true
          
          cat <<EOF > /home/appuser/run_desktop.sh
          #!/bin/bash
          export DISPLAY=:99
          export HOME=/home/appuser
          
          Xvfb :99 -screen 0 1440x900x24 &
          sleep 2
          
          export XFCE_PANEL_MIGRATE_DEFAULT=true
          startxfce4 &
          
          x11vnc -display :99 -forever -bg -noxdamage
          /opt/noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
          EOF
          
          chmod +x /home/appuser/run_desktop.sh
          su appuser -c "/home/appuser/run_desktop.sh"
          
          sleep 5
          su appuser -c "export DISPLAY=:99; xset s off; xset -dpms; xset s noblank"

      # 4. å¯åŠ¨ Playwright æ§åˆ¶çš„ Firefox
      - name: Launch Firefox via Playwright & Tunnel
        run: |
          pip3 install playwright tf-playwright-stealth
  
          cat <<EOF > /home/appuser/launch.py
          import time
          from playwright.sync_api import sync_playwright
          from playwright_stealth import stealth_sync  # å¼•å…¥ä¼ªè£…åº“

          USER_DATA_DIR = "/home/appuser/.mozilla/firefox/stealth.default"
          EXECUTABLE_PATH = "/usr/bin/firefox"
          TARGET_URL = "https://decrypt.day/app/id1489932710"
          
          # ä¸ user.js ä¸­ä¿æŒä¸€è‡´çš„ UA
          USER_AGENT = "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:120.0) Gecko/20100101 Firefox/120.0"

          def run():
              with sync_playwright() as p:
                  print("ğŸš€ Starting Firefox with Stealth Mode...")
                  
                  # å¯åŠ¨å‚æ•°ä¼˜åŒ–
                  args = [
                      "--no-remote", 
                      "--new-instance",
                      "--disable-blink-features=AutomationControlled" # å°è¯•ç¦ç”¨è‡ªåŠ¨åŒ–ç‰¹å¾
                  ]

                  browser = p.firefox.launch_persistent_context(
                      user_data_dir=USER_DATA_DIR,
                      executable_path=EXECUTABLE_PATH,
                      headless=False,
                      #viewport={"width": 1440, "height": 900},
                      user_agent=USER_AGENT,  # æ˜¾å¼è¦†ç›– UA
                      args=args,
                      ignore_default_args=["--enable-automation"], # éšè—è‡ªåŠ¨åŒ–æç¤ºæ¡
                      java_script_enabled=True
                  )
                  
                  # è·å–é¡µé¢ï¼ˆpersistent_context é€šå¸¸ä¼šé»˜è®¤æ‰“å¼€ä¸€ä¸ªç©ºç™½é¡µï¼Œå¦‚æœæ²¡æœ‰åˆ™æ–°å»ºï¼‰
                  page = browser.pages[0] if browser.pages else browser.new_page()

                  # === æ ¸å¿ƒä¼ªè£…æ­¥éª¤ ===
                  
                  # 1. åº”ç”¨ playwright-stealth æ’ä»¶
                  stealth_sync(page)

                  # 2. æ‰‹åŠ¨æ³¨å…¥è„šæœ¬ï¼Œå¼ºè¡ŒæŠ¹é™¤ webdriver å±æ€§
                  # è¿™æ®µ JS ä¼šåœ¨ç½‘é¡µåŠ è½½ä»»ä½•ä»£ç ä¹‹å‰è¿è¡Œ
                  page.add_init_script("""
                      Object.defineProperty(navigator, 'webdriver', {
                          get: () => undefined
                      });
                  """)

                  print(f"ğŸŒ Navigating to {TARGET_URL}")
                  
                  # è®¿é—®ç›®æ ‡ç½‘ç«™
                  try:
                      page.goto(TARGET_URL, timeout=60000, wait_until="domcontentloaded")
                  except Exception as e:
                      print(f"âš ï¸ Page load warning: {e}")

                  # æˆªå›¾ç¡®è®¤æ˜¯å¦çªç ´
                  page.screenshot(path="/home/appuser/Downloads/debug_screenshot.png")
                  print("ğŸ“¸ Debug screenshot saved to Downloads/")

                  # ä¿æŒè¿è¡Œï¼Œç­‰å¾…äººå·¥/åç»­é€»è¾‘
                  while True:
                      time.sleep(120)

          if __name__ == "__main__":
              run()
          EOF

          # åˆ›å»ºå¯åŠ¨è„šæœ¬
          cat <<EOF > /home/appuser/run_playwright.sh
          #!/bin/bash
          export DISPLAY=:99
          export HOME=/home/appuser
          # åœ¨åå°è¿è¡Œ Python è„šæœ¬ï¼Œæ—¥å¿—è¾“å‡ºåˆ°æ–‡ä»¶
          nohup python3 /home/appuser/launch.py > /home/appuser/playwright.log 2>&1 &
          EOF
          
          chmod +x /home/appuser/run_playwright.sh
          su appuser -c "/home/appuser/run_playwright.sh"
          
          echo "Playwright launching..."
          sleep 5
          
          # å¯åŠ¨ Tunnel (ä¿æŒä¸å˜)
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          dpkg -i cloudflared.deb
          cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          echo "Waiting for Tunnel..."
          TUNNEL_URL=$(grep -oE "https://[a-zA-Z0-9-]+\.trycloudflare\.com" tunnel.log | head -1)
          echo $TUNNEL_URL
          if [ $TUNNEL_URL ]; then
            echo "Pass"
          fi
          sleep 3
          
          TUNNEL_URL=$(grep -oE "https://[a-zA-Z0-9-]+\.trycloudflare\.com" tunnel.log | head -1)
          echo $TUNNEL_URL
          if [ $TUNNEL_URL ]; then
            echo "Pass"
          fi
          sleep 3
          
          TUNNEL_URL=$(grep -oE "https://[a-zA-Z0-9-]+\.trycloudflare\.com" tunnel.log | head -1)
          if [ $TUNNEL_URL ]; then
            echo "Pass"
          fi
          echo $TUNNEL_URL
          TUNNEL_URL=$(grep -oE "https://[a-zA-Z0-9-]+\.trycloudflare\.com" tunnel.log | head -1)
          
          echo "=========================================================="
          echo "ğŸ¤– Firefox is running via Playwright"
          echo "ğŸ”— VNC Link: $TUNNEL_URL/vnc.html?autoconnect=true"
          echo "=========================================================="

          tail -f /home/appuser/playwright.log

      # 5. ç›‘æ§ä¸‹è½½ (ä¿æŒä¸å˜)
      - name: Monitor Download (Wait for IPA)
        timeout-minutes: 30
        run: |
          TARGET_DIR="/home/appuser/Downloads"
          MAX_SIZE_MB=100
          
          echo "Starting monitoring loop in $TARGET_DIR"
          
          while true; do
            FILE=$(find "$TARGET_DIR" -name "*.ipa" -print -quit)
            
            if [ -n "$FILE" ]; then
              BASENAME=$(basename "$FILE")
              
              if [ -f "${FILE}.part" ] || [ -f "${FILE}.partjs" ]; then
                 echo "â³ Downloading: $BASENAME..."
              else
                 SIZE_MB=$(du -m "$FILE" | cut -f1)
                 if [ "$SIZE_MB" -le "$MAX_SIZE_MB" ]; then
                   echo "âš ï¸ Found $BASENAME ($SIZE_MB MB), waiting for full file..."
                 else
                   echo "âœ… Success: $BASENAME ($SIZE_MB MB)"
                   break
                 fi
              fi
            else
               echo "Waiting for download..."
            fi
            sleep 5
          done
          
          echo "Download confirmed."

      # 6. ä¸Šä¼ äº§ç‰© (ä¿æŒä¸å˜)
      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: decrypted-app
          path: /home/appuser/Downloads/*.ipa
