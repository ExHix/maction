name: Firefox Allowed-Ads VNC & Playwright

on: 
  workflow_dispatch:

jobs:
  firefox-user:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:22.04
      options: --privileged --shm-size=2gb
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. å®‰è£…åŸºç¡€ç¯å¢ƒ (Root æƒé™)
      - name: Install System & Dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          apt-get update
          # å®‰è£…ç³»ç»Ÿå·¥å…· + Python + Pip + Xterm
          apt-get install -y software-properties-common wget curl git net-tools sudo debconf-utils vim unzip python3-pip xterm
          
          # å®‰è£… noVNC å’Œ VNC Server
          git clone https://github.com/novnc/noVNC.git /opt/noVNC
          git clone https://github.com/novnc/websockify /opt/noVNC/utils/websockify
          ln -s /opt/noVNC/vnc.html /opt/noVNC/index.html
          chmod -R 777 /opt/noVNC
          
          apt-get install -y xvfb fluxbox x11vnc pulseaudio dbus-x11
          
          echo ">>> Installing Playwright Python Lib..."
          pip3 install playwright
          
          echo ">>> Installing System Dependencies for Browsers..."
          # å®‰è£…æ‰€æœ‰æµè§ˆå™¨æ‰€éœ€çš„ç³»ç»Ÿä¾èµ– (Root è¿è¡Œ)
          playwright install-deps

      # 2. é…ç½®ç”¨æˆ· & å®‰è£…æµè§ˆå™¨å†…æ ¸ (å…³é”®ä¿®å¤æ­¥éª¤)
      - name: Setup User & Install Playwright Browsers
        run: |
          useradd -m -s /bin/bash appuser
          
          # å»ºç«‹ä¸‹è½½æ–‡ä»¶å¤¹
          su appuser -c "mkdir -p /home/appuser/Downloads"
          
          # ã€ä¿®å¤æ ¸å¿ƒã€‘ä»¥ appuser èº«ä»½è¿è¡Œ installï¼Œå¹¶å®‰è£…æ‰€æœ‰æµè§ˆå™¨
          # è¿™æ ·æ— è®ºè„šæœ¬æ˜¯ç”¨ chromium è¿˜æ˜¯ firefoxï¼Œéƒ½èƒ½æ‰¾åˆ°äºŒè¿›åˆ¶æ–‡ä»¶
          # ä¸”æ–‡ä»¶ä¼šè¢«æ­£ç¡®æ”¾ç½®åœ¨ /home/appuser/.cache/ms-playwright/ ä¸‹
          echo ">>> Installing All Playwright Browsers for AppUser..."
          su appuser -c "playwright install"
          
          # ç§»åŠ¨è„šæœ¬å¹¶èµ‹äºˆæƒé™
          if [ -f "get_ipa.py" ]; then
            cp get_ipa.py /home/appuser/get_ipa.py
            chown appuser:appuser /home/appuser/get_ipa.py
            chmod +x /home/appuser/get_ipa.py
          else
            echo "âŒ Error: get_ipa.py not found in checkout!"
            exit 1
          fi

      # 3. å¯åŠ¨æ¡Œé¢ç¯å¢ƒ
      - name: Start Desktop Environment
        run: |
          service dbus start || true
          
          cat <<EOF > /home/appuser/run_desktop.sh
          #!/bin/bash
          export DISPLAY=:99
          export HOME=/home/appuser
          
          Xvfb :99 -screen 0 1280x800x24 &
          sleep 2
          fluxbox &
          # VNC å¯†ç : secret
          x11vnc -display :99 -forever -passwd secret -bg -noxdamage
          /opt/noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
          EOF
          
          chmod +x /home/appuser/run_desktop.sh
          su appuser -c "/home/appuser/run_desktop.sh"
          echo "âœ… Desktop Started (Xvfb + Fluxbox + VNC)"

      # 4. å¯åŠ¨ Network Tunnel (å•ç‹¬æ­¥éª¤ + å¿«é€Ÿæ£€æµ‹)
      - name: Start Network Tunnel
        run: |
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          dpkg -i cloudflared.deb
          
          # å¯åŠ¨ tunnel
          cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          echo "Waiting for Tunnel URL..."
          
          FOUND=0
          # ã€ä¿®æ”¹ã€‘å¾ªç¯10æ¬¡ï¼Œæ¯æ¬¡1ç§’ï¼Œå¿«é€Ÿå“åº”
          for i in {1..10}; do
            if grep -q "trycloudflare.com" tunnel.log; then
              FOUND=1
              break
            fi
            echo "Waiting... ($i/10)"
            sleep 1
          done
          
          if [ "$FOUND" -eq 1 ]; then
            TUNNEL_URL=$(grep -oE "https://[a-zA-Z0-9-]+\.trycloudflare\.com" tunnel.log | head -1)
            echo "=========================================================="
            echo "ğŸš€ VNC è¿œç¨‹é“¾æ¥: $TUNNEL_URL/vnc.html?autoconnect=true&password=secret"
            echo "=========================================================="
          else
            echo "âŒ Tunnel failed to start within 10 seconds. Log content:"
            cat tunnel.log
            # è¿™é‡Œä¸ exitï¼Œå…è®¸ä½ å»æ’æŸ¥ï¼Œæˆ–è€…ç¨ååœ¨æ—¥å¿—é‡Œçœ‹åˆ°
          fi

      # 5. è¿è¡Œ Playwright è„šæœ¬ (åŒå‘æ—¥å¿—)
      - name: Run Playwright Script
        run: |
          # é¢„åˆ›å»ºæ—¥å¿—æ–‡ä»¶
          touch /home/appuser/bot.log
          chmod 666 /home/appuser/bot.log

          # åˆ›å»ºå¯åŠ¨è„šæœ¬
          # ä½¿ç”¨ python3 -u ç¦ç”¨ç¼“å­˜
          # ä½¿ç”¨ tee åŒæ—¶è¾“å‡ºåˆ° xterm å±å¹•å’Œ bot.log
          cat <<EOF > /home/appuser/run_bot.sh
          #!/bin/bash
          export DISPLAY=:99
          export HOME=/home/appuser
          export PATH=$PATH:/home/appuser/.local/bin
          
          # å¯åŠ¨ç»ˆç«¯è¿è¡Œ python
          xterm -geometry 100x30 -bg black -fg green -title "Playwright Automation" -hold -e "python3 -u /home/appuser/get_ipa.py 2>&1 | tee /home/appuser/bot.log" &
          EOF
          
          chmod +x /home/appuser/run_bot.sh
          su appuser -c "/home/appuser/run_bot.sh"
          
          echo "ğŸ¤– Script started in background xterm."

      # 6. ç›‘æ§ä¸‹è½½ + å®æ—¶æ˜¾ç¤ºè„šæœ¬æ—¥å¿—
      - name: Monitor Download & Logs
        run: |
          TARGET_DIR="/home/appuser/Downloads"
          LOG_FILE="/home/appuser/bot.log"
          START_TIME=$(date +%s)
          TIMEOUT=1800 # 30åˆ†é’Ÿ
          
          echo "ğŸ“ Syncing logs from VNC to here..."
          
          # åå°å¯åŠ¨ tailï¼Œå®æ—¶æ¬è¿æ—¥å¿—
          tail -f "$LOG_FILE" &
          TAIL_PID=$!
          
          while true; do
            NOW=$(date +%s)
            ELAPSED=$((NOW - START_TIME))
            if [ "$ELAPSED" -ge "$TIMEOUT" ]; then
               echo "âŒ Timeout!"
               kill $TAIL_PID || true
               exit 1
            fi
            
            FILE=$(find "$TARGET_DIR" -name "*.ipa" -print -quit)
            
            if [ -n "$FILE" ]; then
               if [ -f "${FILE}.part" ] || [ -f "${FILE}.partjs" ]; then
                  : # ä¸‹è½½ä¸­
               else
                  SIZE_MB=$(du -m "$FILE" | cut -f1)
                  # å¤§äº 5MB è§†ä¸ºæœ‰æ•ˆ
                  if [ "$SIZE_MB" -gt 5 ]; then
                     echo "âœ… Download finished: $FILE ($SIZE_MB MB)"
                     break
                  fi
               fi
            fi
            sleep 3
          done
          
          kill $TAIL_PID || true

      # 7. ä¸Šä¼ äº§ç‰©
      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: decrypted-app
          path: /home/appuser/Downloads/*.ipa
