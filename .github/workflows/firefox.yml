name: Firefox Allowed-Ads VNC (XFCE4 Desktop)

on: 
  workflow_dispatch:

jobs:
  firefox-xfce:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:22.04
      options: --privileged --shm-size=2gb
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. å®‰è£…åŸºç¡€ç¯å¢ƒ (XFCE4 + Firefox + Playwright)
      - name: Install System & Desktop
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          apt-get update
          # å®‰è£…åŸºç¡€å·¥å…·
          apt-get install -y software-properties-common wget curl git net-tools sudo vim unzip python3-pip psmisc
          
          # å®‰è£… XFCE4 æ¡Œé¢ç¯å¢ƒ (æ¯” Fluxbox å‹å¥½å¾—å¤š) å’Œ Xterm
          apt-get install -y xfce4 xfce4-goodies xfce4-terminal
          
          # å®‰è£… VNC å’Œ XServer
          apt-get install -y xvfb x11vnc dbus-x11 pulseaudio
          
          # å®‰è£… noVNC
          git clone https://github.com/novnc/noVNC.git /opt/noVNC
          git clone https://github.com/novnc/websockify /opt/noVNC/utils/websockify
          ln -s /opt/noVNC/vnc.html /opt/noVNC/index.html
          chmod -R 777 /opt/noVNC
          
          # Playwright ä¾èµ–
          echo ">>> Installing Playwright..."
          pip3 install playwright
          playwright install-deps

      # 2. é…ç½®ç”¨æˆ· & å†™å…¥ Python è„šæœ¬
      - name: Setup User & Script
        run: |
          useradd -m -s /bin/bash appuser
          su appuser -c "mkdir -p /home/appuser/Downloads"
          
          # å®‰è£… Firefox å†…æ ¸ (ç”¨æˆ·çº§)
          echo ">>> Installing Firefox..."
          su appuser -c "playwright install firefox"
          
          # å†™å…¥ä¿®æ”¹åçš„ Python è„šæœ¬
          # ä½¿ç”¨ 'EOF' (å¸¦å¼•å·) é˜²æ­¢ Shell è§£æ $ ç¬¦å·
          cat <<'EOF' > /home/appuser/get_ipa.py
          import json
          import time
          import os
          import sys
          from playwright.sync_api import sync_playwright

          def run():
              base_url = "https://decrypt.day/app/id1489932710"
              print(f"[Script] å¯åŠ¨ Playwright...")
              
              with sync_playwright() as p:
                  # å¯åŠ¨æµè§ˆå™¨ (å¸¦é˜²å´©æºƒå‚æ•°)
                  browser = p.firefox.launch(
                      headless=False,
                      args=["--no-sandbox", "--disable-gpu", "--disable-dev-shm-usage", "--disable-setuid-sandbox"]
                  )
                  context = browser.new_context(
                      user_agent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:120.0) Gecko/20100101 Firefox/120.0",
                      viewport={"width": 1280, "height": 800},
                      ignore_https_errors=True
                  )
                  # å±è”½ WebDriver
                  context.add_init_script("Object.defineProperty(navigator, 'webdriver', {get: () => undefined});")

                  page = context.new_page()
                  print(f"[Script] æ‰“å¼€é¡µé¢: {base_url}")
                  
                  try:
                      page.goto(base_url, timeout=90000)
                      page.wait_for_load_state("domcontentloaded")
                  except Exception as e:
                      print(f"[Script] è­¦å‘Š: é¡µé¢åŠ è½½å¯èƒ½è¶…æ—¶ {e}")

                  if "Just a moment" in page.title() or "Cloudflare" in page.title():
                      print("\n" + "!"*30)
                      print("[!] Cloudflare æ‹¦æˆªï¼è¯·è¿› VNC æ‰‹åŠ¨éªŒè¯ï¼")
                      print("!"*30 + "\n")
                      time.sleep(30)

                  print("[Script] è·å–ä¸‹è½½é“¾æ¥é…ç½®...")
                  # JS æ³¨å…¥è·å–ä¸‹è½½å‚æ•°
                  try:
                      js_code = """
                          async () => {
                              const formData = new FormData();
                              formData.append('data', '163,101,97,112,112,73,100,120,25,99,108,57,115,101,52,48,116,113,48,48,97,98,100,111,102,119,113,116,103,111,118,48,122,115,103,118,101,114,115,105,111,110,101,54,46,50,46,48,105,105,115,80,114,101,109,105,101,114,247');
                              const resp = await fetch('""" + base_url + """?/files', {method: 'POST', body: formData});
                              return await resp.text();
                          }
                      """
                      result = page.evaluate(js_code)
                      data_json = json.loads(result)
                      dl_list = json.loads(data_json.get("data", "[]"))
                      
                      target_path = ""
                      # ç®€å•æŸ¥æ‰¾é€»è¾‘
                      for item in dl_list:
                          if isinstance(item, str) and len(item) == 21:
                              target_path = item
                              break
                      
                      if not target_path and "gofile.io" in dl_list:
                           idx = dl_list.index("gofile.io")
                           target_path = dl_list[idx-3]

                      if not target_path:
                          print("[Script] æœªæ‰¾åˆ°è‡ªåŠ¨ä¸‹è½½è·¯å¾„ï¼Œè¯·æ‰‹åŠ¨ä¸‹è½½ã€‚")
                      else:
                          dl_url = f"{base_url}/dl/{target_path}"
                          print(f"[Script] è·³è½¬ä¸‹è½½é¡µ: {dl_url}")
                          dl_page = context.new_page()
                          dl_page.goto(dl_url, referer=base_url)
                          
                          # ç‚¹å‡»æ­¥éª¤
                          print("[Script] ç‚¹å‡» 'Get download link'...")
                          dl_page.locator("button.btn-download").filter(has_text="Get download link").click()
                          time.sleep(3)
                          
                          print("[Script] ç‚¹å‡» 'Download' å¹¶ç­‰å¾…æ–‡ä»¶...")
                          # å¤„ç†ä¸‹è½½äº‹ä»¶
                          with dl_page.expect_download(timeout=60000) as download_info:
                              dl_page.locator("button.btn-download").filter(has_text="Download").click()
                          
                          download = download_info.value
                          print(f"[Script] ä¸‹è½½å¼€å§‹: {download.suggested_filename}")
                          
                          # ä¿å­˜æ–‡ä»¶
                          final_path = os.path.join("/home/appuser/Downloads", download.suggested_filename)
                          download.save_as(final_path)
                          print(f"[Script] âœ… æ–‡ä»¶ä¿å­˜æˆåŠŸ: {final_path}")

                  except Exception as e:
                      print(f"[Script] é”™è¯¯: {e}")
                      import traceback
                      traceback.print_exc()

                  print("[Script] ä¿æŒæµè§ˆå™¨å¼€å¯...")
                  while True:
                      time.sleep(10)

          if __name__ == "__main__":
              run()
          EOF

          chown appuser:appuser /home/appuser/get_ipa.py
          chmod +x /home/appuser/get_ipa.py

      # 3. å¯åŠ¨ XFCE4 æ¡Œé¢ç¯å¢ƒ
      - name: Start XFCE Desktop
        run: |
          service dbus start || true
          
          cat <<EOF > /home/appuser/run_desktop.sh
          #!/bin/bash
          export DISPLAY=:99
          export HOME=/home/appuser
          
          # å¯åŠ¨ XServer
          Xvfb :99 -screen 0 1280x800x24 &
          sleep 2
          
          # å¯åŠ¨ XFCE4 (æ›´å‹å¥½çš„æ¡Œé¢)
          # ä½¿ç”¨ dbus-launch ç¡®ä¿ session æ­£å¸¸
          dbus-launch --exit-with-session xfce4-session &
          
          # å¯åŠ¨ VNC
          x11vnc -display :99 -forever -passwd secret -bg -noxdamage
          
          # å¯åŠ¨ noVNC
          /opt/noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
          EOF
          
          chmod +x /home/appuser/run_desktop.sh
          su appuser -c "/home/appuser/run_desktop.sh"
          echo "âœ… XFCE4 Desktop Started"

      # 4. å¯åŠ¨ Tunnel
      - name: Start Network Tunnel
        run: |
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          dpkg -i cloudflared.deb
          
          cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          echo "Waiting for Tunnel..."
          sleep 10
          
          TUNNEL_URL=$(grep -oE "https://[a-zA-Z0-9-]+\.trycloudflare\.com" tunnel.log | head -1)
          
          echo "=========================================================="
          echo "ğŸ–¥ï¸  XFCE4 æ¡Œé¢ç¯å¢ƒå·²å°±ç»ª"
          echo "ğŸ”— VNC é“¾æ¥: $TUNNEL_URL/vnc.html?autoconnect=true&password=secret"
          echo "ğŸ’¡ è¿›å…¥åï¼Œä½ ä¼šçœ‹åˆ°ç±»ä¼¼ Windows çš„ä»»åŠ¡æ å’Œå¼€å§‹èœå•ã€‚"
          echo "ğŸ’¡ å¦‚æœéœ€è¦æ‰‹åŠ¨è°ƒè¯•ï¼Œç‚¹å‡»æ¡Œé¢åº•éƒ¨çš„é»‘è‰²ç»ˆç«¯å›¾æ ‡å³å¯ã€‚"
          echo "=========================================================="

      # 5. è¿è¡Œ Python è„šæœ¬
      - name: Run Playwright Script
        run: |
          touch /home/appuser/bot.log
          chmod 666 /home/appuser/bot.log

          cat <<EOF > /home/appuser/run_bot.sh
          #!/bin/bash
          export DISPLAY=:99
          export HOME=/home/appuser
          # å¼ºåˆ¶è½¯ä»¶æ¸²æŸ“
          export LIBGL_ALWAYS_SOFTWARE=1
          
          nohup python3 -u /home/appuser/get_ipa.py > /home/appuser/bot.log 2>&1 &
          EOF
          
          chmod +x /home/appuser/run_bot.sh
          su appuser -c "/home/appuser/run_bot.sh"
          
          echo "ğŸ¤– Script running..."

      # 6. ç›‘æ§
      - name: Monitor & Logs
        run: |
          TARGET_DIR="/home/appuser/Downloads"
          LOG_FILE="/home/appuser/bot.log"
          START_TIME=$(date +%s)
          TIMEOUT=1800 
          
          echo "ğŸ“ Streaming logs..."
          tail -f "$LOG_FILE" &
          TAIL_PID=$!
          
          while true; do
            NOW=$(date +%s)
            if [ $((NOW - START_TIME)) -ge "$TIMEOUT" ]; then
               echo "âŒ Timeout"
               kill $TAIL_PID || true
               exit 1
            fi
            
            FILE=$(find "$TARGET_DIR" -name "*.ipa" -print -quit)
            if [ -n "$FILE" ]; then
               if [ ! -f "${FILE}.part" ] && [ ! -f "${FILE}.partjs" ]; then
                  SIZE_MB=$(du -m "$FILE" | cut -f1)
                  if [ "$SIZE_MB" -gt 5 ]; then
                     echo "âœ… Success: $FILE ($SIZE_MB MB)"
                     break
                  fi
               fi
            fi
            sleep 3
          done
          kill $TAIL_PID || true

      # 7. ä¸Šä¼ 
      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: decrypted-app
          path: /home/appuser/Downloads/*.ipa
