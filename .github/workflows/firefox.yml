name: Firefox Allowed-Ads VNC & Playwright

on: 
  workflow_dispatch:

jobs:
  firefox-user:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:22.04
      # å¿…é¡»å¼€å¯ privileged æ‰èƒ½æ­£å¸¸è¿è¡Œ docker å†…çš„æµè§ˆå™¨æ²™ç®±
      options: --privileged --shm-size=2gb
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. å®‰è£…åŸºç¡€ç¯å¢ƒ (å¢åŠ  Python, pip, xterm)
      - name: Install System & Firefox & Playwright
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          apt-get update
          # æ–°å¢ python3-pip å’Œ xterm
          apt-get install -y software-properties-common wget curl git net-tools sudo debconf-utils vim unzip python3-pip xterm
          
          # 1.1 å®‰è£…ç³»ç»Ÿçº§ Firefox (ä½œä¸ºå¤‡ç”¨æˆ–ä¾èµ–)
          add-apt-repository -y ppa:mozillateam/ppa
          echo '
          Package: *
          Pin: release o=LP-PPA-mozillateam
          Pin-Priority: 1001
          ' | tee /etc/apt/preferences.d/mozilla-firefox
          
          apt-get update
          apt-get install -y firefox fonts-liberation fonts-noto-color-emoji fontconfig ttf-mscorefonts-installer xvfb fluxbox x11vnc pulseaudio dbus-x11
          
          echo "ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true" | debconf-set-selections
          fc-cache -f -v
          
          # 1.2 å®‰è£… noVNC
          git clone https://github.com/novnc/noVNC.git /opt/noVNC
          git clone https://github.com/novnc/websockify /opt/noVNC/utils/websockify
          ln -s /opt/noVNC/vnc.html /opt/noVNC/index.html
          chmod -R 777 /opt/noVNC

          # 1.3 å®‰è£… Playwright åŠå…¶ä¾èµ–
          echo "Installing Playwright..."
          pip3 install playwright
          
          # å®‰è£… Playwright çš„ Firefox (å’Œç³»ç»Ÿä¾èµ–)
          playwright install firefox
          playwright install-deps firefox

      # 2. åˆ›å»ºç”¨æˆ· & å‡†å¤‡è„šæœ¬
      - name: Setup User & Prepare Scripts
        run: |
          useradd -m -s /bin/bash appuser
          
          # åˆ›å»ºä¸‹è½½ç›®å½•
          su appuser -c "mkdir -p /home/appuser/Downloads"
          
          # å°†ä»“åº“é‡Œçš„ get_ipa.py ç§»åŠ¨åˆ°ç”¨æˆ·ç›®å½•ï¼Œå¹¶ä¿®å¤æƒé™
          if [ -f "get_ipa.py" ]; then
            cp get_ipa.py /home/appuser/get_ipa.py
            chown appuser:appuser /home/appuser/get_ipa.py
            chmod +x /home/appuser/get_ipa.py
            echo "âœ… script moved to /home/appuser/get_ipa.py"
          else
            echo "âŒ Error: get_ipa.py not found in checkout!"
            exit 1
          fi

      # 3. å¯åŠ¨æ¡Œé¢ (Xvfb + Fluxbox + VNC + Cloudflared)
      - name: Start Desktop & Network Tunnel
        run: |
          service dbus start || true
          
          # åˆ›å»ºæ¡Œé¢å¯åŠ¨è„šæœ¬
          cat <<EOF > /home/appuser/run_desktop.sh
          #!/bin/bash
          export DISPLAY=:99
          export HOME=/home/appuser
          
          # 1. å¯åŠ¨è™šæ‹Ÿæ˜¾å¡
          Xvfb :99 -screen 0 1280x800x24 &
          sleep 2
          
          # 2. å¯åŠ¨çª—å£ç®¡ç†å™¨ (Fluxbox)
          fluxbox &
          
          # 3. å¯åŠ¨ VNC Server
          x11vnc -display :99 -forever -passwd secret -bg -noxdamage
          
          # 4. å¯åŠ¨ noVNC ä»£ç†
          /opt/noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
          EOF
          
          chmod +x /home/appuser/run_desktop.sh
          su appuser -c "/home/appuser/run_desktop.sh"
          sleep 3
          
          # å¯åŠ¨ Cloudflare Tunnel
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          dpkg -i cloudflared.deb
          cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          echo "Waiting for Tunnel..."
          sleep 8
          
          TUNNEL_URL=$(grep -oE "https://[a-zA-Z0-9-]+\.trycloudflare\.com" tunnel.log | head -1)
          
          echo "=========================================================="
          echo "ğŸš€ VNC è¿œç¨‹é“¾æ¥: $TUNNEL_URL/vnc.html?autoconnect=true&password=secret"
          echo "âš ï¸  æ³¨æ„: Playwright è„šæœ¬å°†åœ¨ VNC å†…çš„é»‘è‰²ç»ˆç«¯çª—å£ä¸­è¿è¡Œã€‚"
          echo "âš ï¸  å¦‚æœé‡åˆ° 'Waiting for user operation'ï¼Œè¯·åœ¨ VNC çš„é»‘è‰²çª—å£ä¸­æŒ‰å›è½¦ã€‚"
          echo "=========================================================="

      # 4. è¿è¡Œ Playwright è„šæœ¬ (åŒå‘æ—¥å¿—æ¨¡å¼)
      - name: Run Playwright Script (Visual + Log Sync)
        run: |
          # 1. é¢„å…ˆåˆ›å»ºæ—¥å¿—æ–‡ä»¶å¹¶èµ‹äºˆæƒé™ï¼Œé˜²æ­¢æƒé™ä¸è¶³
          touch /home/appuser/bot.log
          chmod 666 /home/appuser/bot.log

          # 2. åˆ›å»ºè¿è¡Œè„šæœ¬
          # å…³é”®ä¿®æ”¹ï¼š
          # python3 -u : ç¦ç”¨è¾“å‡ºç¼“å­˜ï¼Œè®©æ—¥å¿—å®æ—¶å‡ºç°
          # 2>&1       : æŠŠé”™è¯¯è¾“å‡º(stderr)ä¹Ÿåˆå¹¶åˆ°æ ‡å‡†è¾“å‡º
          # | tee ...  : ç¥å¥‡çš„å‘½ä»¤ï¼Œæ—¢åœ¨ç»ˆç«¯æ˜¾ç¤ºï¼Œåˆå†™å…¥æ–‡ä»¶
          cat <<EOF > /home/appuser/run_bot.sh
          #!/bin/bash
          export DISPLAY=:99
          export HOME=/home/appuser
          export PATH=$PATH:/home/appuser/.local/bin
          
          xterm -geometry 100x30 -bg black -fg green -title "Playwright Automation" -hold -e "python3 -u /home/appuser/get_ipa.py 2>&1 | tee /home/appuser/bot.log" &
          EOF
          
          chmod +x /home/appuser/run_bot.sh
          su appuser -c "/home/appuser/run_bot.sh"
          
          echo "ğŸ¤– Automation script started."
          echo "ğŸ“„ Logs are being synced to this console via /home/appuser/bot.log"

      # 5. ç›‘æ§ä¸‹è½½ + å®æ—¶æ‰“å°è„šæœ¬æ—¥å¿—
      - name: Monitor Download & Sync Logs
        run: |
          TARGET_DIR="/home/appuser/Downloads"
          LOG_FILE="/home/appuser/bot.log"
          MAX_SIZE_MB=100
          TIMEOUT_SECONDS=1200
          START_TIME=$(date +%s)
          
          # ã€æ–°å¢ã€‘åå°å¯åŠ¨ tailï¼Œå°† Python çš„æ—¥å¿—å®æ—¶è¾“å‡ºåˆ° Action æ§åˆ¶å°
          # & è¡¨ç¤ºåœ¨åå°è¿è¡Œï¼Œä¸ä¼šé˜»å¡ä¸‹é¢çš„ç›‘æ§å¾ªç¯
          tail -f "$LOG_FILE" &
          TAIL_PID=$!
          
          echo "Starting monitoring loop for *.ipa in $TARGET_DIR"
          
          while true; do
            CURRENT_TIME=$(date +%s)
            ELAPSED_TIME=$((CURRENT_TIME - START_TIME))
            
            # 1. è¶…æ—¶æ£€æŸ¥
            if [ "$ELAPSED_TIME" -ge "$TIMEOUT_SECONDS" ]; then
                echo "âŒ Timeout reached. Killing log syncer."
                kill $TAIL_PID || true
                exit 1
            fi
          
            # 2. æŸ¥æ‰¾æ–‡ä»¶
            FILE=$(find "$TARGET_DIR" -name "*.ipa" -print -quit)
            
            if [ -n "$FILE" ]; then
              BASENAME=$(basename "$FILE")
              
              if [ -f "${FILE}.part" ] || [ -f "${FILE}.partjs" ]; then
                 # ä¸‹è½½ä¸­... (æ—¥å¿—é‡Œä¸é‡å¤æ‰“å°ï¼Œä»¥å…åˆ·å±ï¼Œåæ­£ä¸Šé¢æœ‰ tail -f çš„æ—¥å¿—)
                 : 
              else
                 SIZE_MB=$(du -m "$FILE" | cut -f1)
                 
                 if [ "$SIZE_MB" -le "$MAX_SIZE_MB" ]; then
                   echo "âš ï¸ Found $BASENAME but size ($SIZE_MB MB) is too small. Waiting..."
                 else
                   echo "âœ… Found candidate: $BASENAME ($SIZE_MB MB)"
                   break
                 fi
              fi
            fi
            
            sleep 3
          done
          
          # åœæ­¢æ—¥å¿—åŒæ­¥
          kill $TAIL_PID || true
          echo "Download complete."

      # 6. ä¸Šä¼ äº§ç‰©
      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: decrypted-app
          path: /home/appuser/Downloads/*.ipa
