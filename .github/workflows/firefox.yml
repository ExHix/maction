name: Firefox Allowed-Ads VNC & Playwright

on: 
  workflow_dispatch:

jobs:
  firefox-user:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:22.04
      options: --privileged --shm-size=2gb
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. å®‰è£…åŸºç¡€ç¯å¢ƒ
      - name: Install System & Dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          apt-get update
          # å®‰è£…å¸¸ç”¨å·¥å…· + Python + Pip + è¿›ç¨‹ç®¡ç†å·¥å…·(psmisc)
          apt-get install -y software-properties-common wget curl git net-tools sudo debconf-utils vim unzip python3-pip xterm psmisc
          
          # å®‰è£… noVNC
          git clone https://github.com/novnc/noVNC.git /opt/noVNC
          git clone https://github.com/novnc/websockify /opt/noVNC/utils/websockify
          ln -s /opt/noVNC/vnc.html /opt/noVNC/index.html
          chmod -R 777 /opt/noVNC
          
          # å®‰è£… X11 ç¯å¢ƒ
          apt-get install -y xvfb fluxbox x11vnc pulseaudio dbus-x11
          
          echo ">>> Installing Playwright..."
          pip3 install playwright
          
          echo ">>> Installing System Dependencies..."
          playwright install-deps

      # 2. é…ç½®ç”¨æˆ· & å®‰è£… Firefox
      - name: Setup User & Install Firefox
        run: |
          useradd -m -s /bin/bash appuser
          su appuser -c "mkdir -p /home/appuser/Downloads"
          
          # ä»¥ appuser èº«ä»½å®‰è£… Firefox å†…æ ¸
          echo ">>> Installing Firefox for AppUser..."
          su appuser -c "playwright install firefox"
          
          # ç§»åŠ¨å¹¶å¤„ç† Python è„šæœ¬
          if [ -f "get_ipa.py" ]; then
            cp get_ipa.py /home/appuser/get_ipa.py
            # ã€ä¸´æ—¶è¡¥ä¸ã€‘
            # å› ä¸ºæ‚¨çš„è„šæœ¬ç‚¹å‡»ä¸‹è½½åä¼šç«‹åˆ»å…³é—­æµè§ˆå™¨ï¼Œå¯¼è‡´ä¸‹è½½å¤±è´¥ã€‚
            # è¿™é‡Œæˆ‘ç”¨ sed å‘½ä»¤åœ¨è„šæœ¬æœ€åå¼ºè¡Œæ’å…¥ä¸€æ®µ sleep 60ï¼Œ
            # ç¡®ä¿æµè§ˆå™¨åœ¨ä¸‹è½½å¼€å§‹åè‡³å°‘å­˜æ´» 60 ç§’ï¼Œç»™ä¸‹è½½ç•™å‡ºæ—¶é—´ã€‚
            # å¦‚æœä¸éœ€è¦ï¼Œæ‚¨å¯ä»¥æ³¨é‡Šæ‰ä¸‹é¢è¿™è¡Œ sedã€‚
            sed -i '/browser.close()/i \        import time; print("ç­‰å¾…ä¸‹è½½ç¼“å†²..."); time.sleep(60)' /home/appuser/get_ipa.py
            
            chown appuser:appuser /home/appuser/get_ipa.py
            chmod +x /home/appuser/get_ipa.py
            echo "âœ… Script prepared (with 60s wait patch injected)"
          else
            echo "âŒ Error: get_ipa.py not found!"
            exit 1
          fi

      # 3. å¯åŠ¨æ¡Œé¢ (Xvfb + Fluxbox + VNC)
      - name: Start Desktop Environment
        run: |
          service dbus start || true
          
          cat <<EOF > /home/appuser/run_desktop.sh
          #!/bin/bash
          export DISPLAY=:99
          export HOME=/home/appuser
          
          Xvfb :99 -screen 0 1280x800x24 &
          sleep 2
          fluxbox &
          x11vnc -display :99 -forever -passwd secret -bg -noxdamage
          /opt/noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
          EOF
          
          chmod +x /home/appuser/run_desktop.sh
          su appuser -c "/home/appuser/run_desktop.sh"
          echo "âœ… Desktop Started"

      # 4. å¯åŠ¨ Tunnel
      - name: Start Network Tunnel
        run: |
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          dpkg -i cloudflared.deb
          
          cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          echo "Waiting for Tunnel (10s)..."
          sleep 10
          
          TUNNEL_URL=$(grep -oE "https://[a-zA-Z0-9-]+\.trycloudflare\.com" tunnel.log | head -1)
          
          echo "=========================================================="
          echo "ğŸ¦Š Firefox VNC Ready"
          echo "ğŸ”— VNC é“¾æ¥: $TUNNEL_URL/vnc.html?autoconnect=true&password=secret"
          echo "=========================================================="

      # 5. ã€æ–°å¢æ­¥éª¤ã€‘å•ç‹¬å¯åŠ¨ Firefox éªŒè¯ç¯å¢ƒ
      - name: Verify Firefox Standalone
        run: |
          echo "ğŸ§ª Testing Firefox startup before running script..."
          
          # åˆ›å»ºä¸€ä¸ªç®€å•çš„éªŒè¯è„šæœ¬ï¼Œåªæ‰“å¼€ Firefox å¹¶åŠ è½½ Mozilla å®˜ç½‘
          cat <<EOF > /home/appuser/test_firefox.sh
          #!/bin/bash
          export DISPLAY=:99
          export HOME=/home/appuser
          # åœ¨åå°å¯åŠ¨ Firefox
          nohup firefox "https://www.mozilla.org" > firefox_test.log 2>&1 &
          EOF
          
          chmod +x /home/appuser/test_firefox.sh
          su appuser -c "/home/appuser/test_firefox.sh"
          
          echo "â³ Waiting 10 seconds to ensure Firefox GUI renders..."
          sleep 10
          
          # æ£€æŸ¥è¿›ç¨‹æ˜¯å¦å­˜åœ¨
          if pgrep -u appuser firefox > /dev/null; then
             echo "âœ… Firefox process is running correctly!"
             echo "Closing test instance..."
             pkill -u appuser firefox
             sleep 2
          else
             echo "âŒ Firefox failed to start! Check logs:"
             cat /home/appuser/firefox_test.log
             exit 1
          fi

      # 6. è¿è¡Œ Playwright è„šæœ¬
      - name: Run Playwright Script
        run: |
          touch /home/appuser/bot.log
          chmod 666 /home/appuser/bot.log

          cat <<EOF > /home/appuser/run_bot.sh
          #!/bin/bash
          export DISPLAY=:99
          export HOME=/home/appuser
          # ç¦ç”¨ buffering (-u) å¹¶å°†æ—¥å¿—é‡å®šå‘åˆ°æ–‡ä»¶
          nohup python3 -u /home/appuser/get_ipa.py > /home/appuser/bot.log 2>&1 &
          EOF
          
          chmod +x /home/appuser/run_bot.sh
          su appuser -c "/home/appuser/run_bot.sh"
          
          echo "ğŸ¤– Script started in background."

      # 7. ç›‘æ§ä¸‹è½½ + å®æ—¶æ—¥å¿—
      - name: Monitor Download & Logs
        run: |
          TARGET_DIR="/home/appuser/Downloads"
          LOG_FILE="/home/appuser/bot.log"
          START_TIME=$(date +%s)
          TIMEOUT=1800 
          
          echo "ğŸ“ Streaming logs from $LOG_FILE ..."
          
          # å®æ—¶æ‰“å°æ—¥å¿—
          tail -f "$LOG_FILE" &
          TAIL_PID=$!
          
          while true; do
            NOW=$(date +%s)
            ELAPSED=$((NOW - START_TIME))
            
            if [ "$ELAPSED" -ge "$TIMEOUT" ]; then
               echo "âŒ Timeout reached!"
               kill $TAIL_PID || true
               exit 1
            fi
            
            # æŸ¥æ‰¾ ipa æ–‡ä»¶
            FILE=$(find "$TARGET_DIR" -name "*.ipa" -print -quit)
            
            if [ -n "$FILE" ]; then
               # æ’é™¤ä¸´æ—¶æ–‡ä»¶
               if [ -f "${FILE}.part" ] || [ -f "${FILE}.partjs" ]; then
                  :
               else
                  SIZE_MB=$(du -m "$FILE" | cut -f1)
                  if [ "$SIZE_MB" -gt 5 ]; then
                     echo "âœ… Download finished: $FILE ($SIZE_MB MB)"
                     break
                  fi
               fi
            fi
            
            sleep 3
          done
          
          kill $TAIL_PID || true

      # 8. ä¸Šä¼ 
      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: decrypted-app
          path: /home/appuser/Downloads/*.ipa
