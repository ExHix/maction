name: Firefox Allowed-Ads VNC & Playwright

on: 
  workflow_dispatch:

jobs:
  firefox-user:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:22.04
      options: --privileged --shm-size=2gb
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. å®‰è£…åŸºç¡€ç¯å¢ƒ (Root æƒé™)
      - name: Install System & Dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          apt-get update
          # å®‰è£…åŸºç¡€å·¥å…· + Python + Pip
          # å»æ‰äº† xtermï¼Œå› ä¸ºä¸å†éœ€è¦ç»ˆç«¯æ¨¡æ‹Ÿå™¨
          apt-get install -y software-properties-common wget curl git net-tools sudo debconf-utils vim unzip python3-pip
          
          # å®‰è£… noVNC å’Œ VNC Server
          git clone https://github.com/novnc/noVNC.git /opt/noVNC
          git clone https://github.com/novnc/websockify /opt/noVNC/utils/websockify
          ln -s /opt/noVNC/vnc.html /opt/noVNC/index.html
          chmod -R 777 /opt/noVNC
          
          apt-get install -y xvfb fluxbox x11vnc pulseaudio dbus-x11
          
          echo ">>> Installing Playwright Python Lib..."
          pip3 install playwright
          
          echo ">>> Installing System Dependencies for Browsers..."
          # å®‰è£…æ‰€æœ‰æµè§ˆå™¨æ‰€éœ€çš„ç³»ç»Ÿä¾èµ– (Root è¿è¡Œ)
          playwright install-deps

      # 2. é…ç½®ç”¨æˆ· & å®‰è£…æµè§ˆå™¨å†…æ ¸
      - name: Setup User & Install Playwright Browsers
        run: |
          useradd -m -s /bin/bash appuser
          
          # å»ºç«‹ä¸‹è½½æ–‡ä»¶å¤¹
          su appuser -c "mkdir -p /home/appuser/Downloads"
          
          # ã€æ ¸å¿ƒä¿®å¤ã€‘ä»¥ appuser èº«ä»½å®‰è£… Firefox
          # ç¡®ä¿è„šæœ¬è¿è¡Œæ—¶èƒ½åœ¨ /home/appuser/.cache/ms-playwright ä¸‹æ‰¾åˆ°æµè§ˆå™¨
          echo ">>> Installing Firefox for AppUser..."
          su appuser -c "playwright install firefox"
          
          # ç§»åŠ¨è„šæœ¬å¹¶èµ‹äºˆæƒé™
          if [ -f "get_ipa.py" ]; then
            cp get_ipa.py /home/appuser/get_ipa.py
            chown appuser:appuser /home/appuser/get_ipa.py
            chmod +x /home/appuser/get_ipa.py
          else
            echo "âŒ Error: get_ipa.py not found in checkout!"
            exit 1
          fi

      # 3. å¯åŠ¨æ¡Œé¢ç¯å¢ƒ (åå°è¿è¡Œ)
      - name: Start Desktop Environment
        run: |
          service dbus start || true
          
          cat <<EOF > /home/appuser/run_desktop.sh
          #!/bin/bash
          export DISPLAY=:99
          export HOME=/home/appuser
          
          # å¯åŠ¨è™šæ‹Ÿæ˜¾å¡
          Xvfb :99 -screen 0 1280x800x24 &
          sleep 2
          
          # å¯åŠ¨çª—å£ç®¡ç†å™¨
          fluxbox &
          
          # å¯åŠ¨ VNC Server (å¯†ç : secret)
          x11vnc -display :99 -forever -passwd secret -bg -noxdamage
          
          # å¯åŠ¨ noVNC ä»£ç†
          /opt/noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
          EOF
          
          chmod +x /home/appuser/run_desktop.sh
          # åå°è¿è¡Œæ¡Œé¢ç¯å¢ƒ
          su appuser -c "/home/appuser/run_desktop.sh"
          echo "âœ… Desktop Started (Xvfb + Fluxbox + VNC)"

      # 4. å¯åŠ¨ Network Tunnel (ä½¿ç”¨ä½ æŒ‡å®šçš„é€»è¾‘)
      - name: Start Network Tunnel
        run: |
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          dpkg -i cloudflared.deb
          
          # å¯åŠ¨ tunnelï¼Œæ—¥å¿—è¾“å‡ºåˆ°æ–‡ä»¶
          cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          echo "Waiting for Tunnel..."
          
          # å¾ªç¯æ£€æµ‹10æ¬¡ï¼Œæ¯æ¬¡1ç§’
          for i in {1..10}; do
            if grep -oE "https://[a-zA-Z0-9-]+\.trycloudflare\.com" tunnel.log; then
              break
            fi
            echo "Waiting... ($i/10)"
            sleep 1
          done
          
          TUNNEL_URL=$(grep -oE "https://[a-zA-Z0-9-]+\.trycloudflare\.com" tunnel.log | head -1)
          
          echo "=========================================================="
          echo "ğŸ¦Š Firefox (Playwright Mode) å·²å‡†å¤‡å°±ç»ª"
          echo "ğŸ”— VNC é“¾æ¥: $TUNNEL_URL/vnc.html?autoconnect=true&password=secret"
          echo "=========================================================="

      # 5. ç›´æ¥è¿è¡Œ Playwright è„šæœ¬
      - name: Run Playwright Script
        run: |
          echo "ğŸš€ Starting Playwright script directly..."
          
          # å¿…é¡»æŒ‡å®š DISPLAY=:99ï¼Œå¦åˆ™ headless=False ä¼šæŠ¥é”™
          # python3 -u ä¿è¯æ—¥å¿—å®æ—¶è¾“å‡ºåˆ° GitHub Action æ§åˆ¶å°
          su appuser -c "export DISPLAY=:99 && python3 -u /home/appuser/get_ipa.py"

      # 6. ç›‘æ§/æ£€æŸ¥ä¸‹è½½ç»“æœ
      # å¦‚æœä½ çš„è„šæœ¬æ˜¯åŒæ­¥ç­‰å¾…ä¸‹è½½å®Œæˆæ‰é€€å‡ºçš„ï¼Œè¿™ä¸€æ­¥ä¸»è¦èµ·åˆ°ç¡®è®¤ä½œç”¨
      - name: Verify Download
        run: |
          TARGET_DIR="/home/appuser/Downloads"
          echo "ğŸ“‚ Checking directory: $TARGET_DIR"
          ls -lh $TARGET_DIR
          
          FILE=$(find "$TARGET_DIR" -name "*.ipa" -print -quit)
          
          if [ -n "$FILE" ]; then
             SIZE_MB=$(du -m "$FILE" | cut -f1)
             echo "âœ… Success! Found IPA: $FILE ($SIZE_MB MB)"
          else
             echo "âš ï¸ No IPA file found immediately after script finished."
             # å¦‚æœä½ çš„è„šæœ¬ç‚¹å‡»ä¸‹è½½åç«‹é©¬é€€å‡ºäº†ï¼Œå¯èƒ½è¿˜æ²¡ä¸‹è½½å®Œã€‚
             # å¦‚æœéœ€è¦ï¼Œå¯ä»¥åœ¨è¿™é‡ŒåŠ ä¸€ä¸ªç®€å•çš„ç­‰å¾…å¾ªç¯ï¼Œæˆ–è€…åœ¨ python è„šæœ¬é‡ŒåŠ ç­‰å¾…é€»è¾‘ã€‚
          fi

      # 7. ä¸Šä¼ äº§ç‰©
      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: decrypted-app
          path: /home/appuser/Downloads/*.ipa
