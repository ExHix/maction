name: Firefox Allowed-Ads VNC (XFCE4 + Anti-Detect)

on: 
  workflow_dispatch:

jobs:
  firefox-xfce:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:22.04
      options: --privileged --shm-size=2gb
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. å®‰è£…åŸºç¡€ç¯å¢ƒ (XFCE4)
      - name: Install System & Desktop
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          apt-get update
          apt-get install -y software-properties-common wget curl git net-tools sudo vim unzip python3-pip psmisc
          apt-get install -y xfce4 xfce4-goodies xfce4-terminal
          apt-get install -y xvfb x11vnc dbus-x11 pulseaudio
          
          # noVNC
          git clone https://github.com/novnc/noVNC.git /opt/noVNC
          git clone https://github.com/novnc/websockify /opt/noVNC/utils/websockify
          ln -s /opt/noVNC/vnc.html /opt/noVNC/index.html
          chmod -R 777 /opt/noVNC
          
          # Playwright
          pip3 install playwright
          playwright install-deps

      # 2. é…ç½®ç”¨æˆ·ã€æ‰‹åŠ¨Profile & Pythonè„šæœ¬
      - name: Setup User, Profile & Script
        run: |
          useradd -m -s /bin/bash appuser
          su appuser -c "mkdir -p /home/appuser/Downloads"
          
          # å®‰è£… Firefox
          echo ">>> Installing Firefox..."
          su appuser -c "playwright install firefox"

          # -------------------------------------------------------------
          # ã€æ­¥éª¤ Aã€‘ä¸ºæ‰‹åŠ¨ Debug å‡†å¤‡ç‰©ç† Profile (å½“ä½ æ‰‹åŠ¨ç‚¹ Firefox å›¾æ ‡æ—¶ç”Ÿæ•ˆ)
          # -------------------------------------------------------------
          su appuser -c "mkdir -p /home/appuser/.mozilla/firefox/stealth.default"
          
          su appuser -c "cat <<EOF > /home/appuser/.mozilla/firefox/profiles.ini
          [Profile0]
          Name=default
          IsRelative=1
          Path=stealth.default
          Default=1
          [General]
          StartWithLastProfile=1
          Version=2
          EOF"
          
          # å†™å…¥ä½ çš„ user.js é…ç½®åˆ°é»˜è®¤ Profile
          su appuser -c "cat <<EOF > /home/appuser/.mozilla/firefox/stealth.default/user.js
          user_pref(\"dom.webdriver.enabled\", false);
          user_pref(\"use_automation_extension\", false);
          user_pref(\"general.useragent.override\", \"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:120.0) Gecko/20100101 Firefox/120.0\");
          user_pref(\"privacy.trackingprotection.enabled\", false);
          user_pref(\"privacy.trackingprotection.pbmode.enabled\", false);
          user_pref(\"privacy.trackingprotection.socialtracking.enabled\", false);
          user_pref(\"privacy.trackingprotection.cryptomining.enabled\", false);
          user_pref(\"privacy.trackingprotection.fingerprinting.enabled\", false);
          user_pref(\"network.cookie.cookieBehavior\", 0);
          user_pref(\"network.cookie.thirdparty.sessionOnly\", false);
          user_pref(\"dom.popup_allowed_events\", \"change click dblclick mouseup notificationclick reset submit touchend\"); 
          user_pref(\"dom.disable_open_during_load\", false);
          user_pref(\"media.peerconnection.enabled\", false);
          EOF"

          # -------------------------------------------------------------
          # ã€æ­¥éª¤ Bã€‘é›†æˆåˆ° Python è„šæœ¬ (å½“è„šæœ¬è¿è¡Œæ—¶ç”Ÿæ•ˆ)
          # -------------------------------------------------------------
          cat <<'EOF' > /home/appuser/get_ipa.py
          import json
          import time
          import os
          from playwright.sync_api import sync_playwright

          def run():
              base_url = "https://decrypt.day/app/id1489932710"
              print(f"[Script] å¯åŠ¨ Playwright...")
              
              with sync_playwright() as p:
                  # ã€æ ¸å¿ƒé›†æˆã€‘åœ¨è¿™é‡Œç›´æ¥æ³¨å…¥æ‰€æœ‰çš„ user_pref é…ç½®
                  # è¿™æ ·å³ä½¿ä¸ä¾èµ–å¤–éƒ¨ user.js æ–‡ä»¶ï¼Œè„šæœ¬å¯åŠ¨çš„æµè§ˆå™¨ä¹Ÿæ˜¯å®Œå…¨â€œå»æŒ‡çº¹â€ä¸”â€œå…è®¸å¹¿å‘Šâ€çš„
                  browser = p.firefox.launch(
                      headless=False,
                      args=[
                          "--no-sandbox",
                          "--disable-gpu",
                          "--disable-dev-shm-usage",
                          "--disable-setuid-sandbox"
                      ],
                      firefox_user_prefs={
                          # 1. åŸºç¡€åçˆ¬
                          "dom.webdriver.enabled": False,
                          "use_automation_extension": False,
                          
                          # 2. éšç§ä¸è¿½è¸ª (å…¨éƒ¨å…³é—­ä»¥å…è®¸å¹¿å‘ŠåŠ è½½)
                          "privacy.trackingprotection.enabled": False,
                          "privacy.trackingprotection.pbmode.enabled": False,
                          "privacy.trackingprotection.socialtracking.enabled": False,
                          "privacy.trackingprotection.cryptomining.enabled": False,
                          "privacy.trackingprotection.fingerprinting.enabled": False,
                          
                          # 3. Cookie è®¾ç½® (0 = å…è®¸æ‰€æœ‰ï¼ŒåŒ…æ‹¬ç¬¬ä¸‰æ–¹)
                          "network.cookie.cookieBehavior": 0,
                          "network.cookie.thirdparty.sessionOnly": False,
                          
                          # 4. å¼¹çª—ä¸äº¤äº’è®¾ç½® (å…è®¸å¹¿å‘Šå¼¹çª—)
                          "dom.popup_allowed_events": "change click dblclick mouseup notificationclick reset submit touchend",
                          "dom.disable_open_during_load": False,
                          
                          # 5. WebRTC (False = å…³é—­ï¼Œé˜²æ­¢æ¼ IP)
                          "media.peerconnection.enabled": False,
                      }
                  )

                  # ä¸Šä¸‹æ–‡è®¾ç½®
                  context = browser.new_context(
                      # User Agent ä¹Ÿå¯ä»¥åœ¨è¿™é‡Œå†æ¬¡å¼ºåˆ¶æŒ‡å®š
                      user_agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:120.0) Gecko/20100101 Firefox/120.0",
                      viewport={"width": 1280, "height": 800},
                      ignore_https_errors=True,
                      locale="zh-CN",
                      timezone_id="Asia/Shanghai"
                  )
                  
                  # å†æ¬¡ç¡®ä¿ webdriver å±æ€§è¢«æŠ¹é™¤
                  context.add_init_script("Object.defineProperty(navigator, 'webdriver', {get: () => undefined});")

                  page = context.new_page()
                  print(f"[Script] æ‰“å¼€é¡µé¢: {base_url}")
                  
                  try:
                      page.goto(base_url, timeout=90000)
                      page.wait_for_load_state("domcontentloaded")
                  except Exception as e:
                      print(f"[Script] è­¦å‘Š: é¡µé¢åŠ è½½ {e}")

                  # Cloudflare æ£€æµ‹
                  if "Just a moment" in page.title() or "Cloudflare" in page.title():
                      print("\n" + "!"*30)
                      print("[!] Cloudflare æ‹¦æˆªï¼è¯·è¿› VNC æ‰‹åŠ¨éªŒè¯ï¼")
                      print("!"*30 + "\n")
                      time.sleep(30)

                  print("[Script] è§£æä¸‹è½½é€»è¾‘...")
                  try:
                      # æ¨¡æ‹Ÿå‰ç«¯è¯·æ±‚è·å–ä¸‹è½½é…ç½®
                      js_code = """
                          async () => {
                              const formData = new FormData();
                              formData.append('data', '163,101,97,112,112,73,100,120,25,99,108,57,115,101,52,48,116,113,48,48,97,98,100,111,102,119,113,116,103,111,118,48,122,115,103,118,101,114,115,105,111,110,101,54,46,50,46,48,105,105,115,80,114,101,109,105,101,114,247');
                              const resp = await fetch('""" + base_url + """?/files', {method: 'POST', body: formData});
                              return await resp.text();
                          }
                      """
                      result = page.evaluate(js_code)
                      data_json = json.loads(result)
                      dl_list = json.loads(data_json.get("data", "[]"))
                      
                      target_path = ""
                      for item in dl_list:
                          if isinstance(item, str) and len(item) == 21:
                              target_path = item
                              break
                      
                      if not target_path and "gofile.io" in dl_list:
                           idx = dl_list.index("gofile.io")
                           target_path = dl_list[idx-3]

                      if not target_path:
                          print("[Script] æœªæ‰¾åˆ°è·¯å¾„ï¼Œè¯·æ‰‹åŠ¨æ“ä½œã€‚")
                      else:
                          dl_url = f"{base_url}/dl/{target_path}"
                          print(f"[Script] ä¸‹è½½é¡µ: {dl_url}")
                          dl_page = context.new_page()
                          dl_page.goto(dl_url, referer=base_url)
                          
                          print("[Script] ç‚¹å‡» 'Get download link'...")
                          dl_page.locator("button.btn-download").filter(has_text="Get download link").click()
                          time.sleep(3)
                          
                          print("[Script] ç‚¹å‡» 'Download'...")
                          with dl_page.expect_download(timeout=60000) as download_info:
                              dl_page.locator("button.btn-download").filter(has_text="Download").click()
                          
                          download = download_info.value
                          print(f"[Script] ä¸‹è½½å¼€å§‹: {download.suggested_filename}")
                          final_path = os.path.join("/home/appuser/Downloads", download.suggested_filename)
                          download.save_as(final_path)
                          print(f"[Script] âœ… ä¿å­˜æˆåŠŸ: {final_path}")

                  except Exception as e:
                      print(f"[Script] æµç¨‹é”™è¯¯: {e}")
                      import traceback
                      traceback.print_exc()

                  print("[Script] æµè§ˆå™¨ä¿æŒå¼€å¯ï¼Œç­‰å¾… Action ç»“æŸ...")
                  while True:
                      time.sleep(10)

          if __name__ == "__main__":
              run()
          EOF

          chown appuser:appuser /home/appuser/get_ipa.py
          chmod +x /home/appuser/get_ipa.py

      # 3. å¯åŠ¨ XFCE4 æ¡Œé¢
      - name: Start XFCE Desktop
        run: |
          service dbus start || true
          
          cat <<EOF > /home/appuser/run_desktop.sh
          #!/bin/bash
          export DISPLAY=:99
          export HOME=/home/appuser
          
          Xvfb :99 -screen 0 1280x800x24 &
          sleep 2
          dbus-launch --exit-with-session xfce4-session &
          x11vnc -display :99 -forever -passwd secret -bg -noxdamage
          /opt/noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
          EOF
          
          chmod +x /home/appuser/run_desktop.sh
          su appuser -c "/home/appuser/run_desktop.sh"
          echo "âœ… Desktop Started"

      # 4. å¯åŠ¨ Tunnel
      - name: Start Network Tunnel
        run: |
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          dpkg -i cloudflared.deb
          
          cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          echo "Waiting for Tunnel..."
          sleep 10
          
          TUNNEL_URL=$(grep -oE "https://[a-zA-Z0-9-]+\.trycloudflare\.com" tunnel.log | head -1)
          
          echo "=========================================================="
          echo "ğŸ”— VNC é“¾æ¥: $TUNNEL_URL/vnc.html?autoconnect=true&password=secret"
          echo "ğŸ’¡ å·²é…ç½®å…è®¸å¹¿å‘Šå’Œè¿½è¸ªï¼Œä¿®å¤ AdBlock æ£€æµ‹é—®é¢˜ã€‚"
          echo "=========================================================="

      # 5. è¿è¡Œ Python è„šæœ¬
      - name: Run Playwright Script
        run: |
          touch /home/appuser/bot.log
          chmod 666 /home/appuser/bot.log

          cat <<EOF > /home/appuser/run_bot.sh
          #!/bin/bash
          export DISPLAY=:99
          export HOME=/home/appuser
          export LIBGL_ALWAYS_SOFTWARE=1
          
          nohup python3 -u /home/appuser/get_ipa.py > /home/appuser/bot.log 2>&1 &
          EOF
          
          chmod +x /home/appuser/run_bot.sh
          su appuser -c "/home/appuser/run_bot.sh"
          
          echo "ğŸ¤– Script running..."

      # 6. ç›‘æ§
      - name: Monitor & Logs
        run: |
          TARGET_DIR="/home/appuser/Downloads"
          LOG_FILE="/home/appuser/bot.log"
          START_TIME=$(date +%s)
          TIMEOUT=1800 
          
          echo "ğŸ“ Streaming logs..."
          tail -f "$LOG_FILE" &
          TAIL_PID=$!
          
          while true; do
            NOW=$(date +%s)
            if [ $((NOW - START_TIME)) -ge "$TIMEOUT" ]; then
               echo "âŒ Timeout"
               kill $TAIL_PID || true
               exit 1
            fi
            
            FILE=$(find "$TARGET_DIR" -name "*.ipa" -print -quit)
            if [ -n "$FILE" ]; then
               if [ ! -f "${FILE}.part" ] && [ ! -f "${FILE}.partjs" ]; then
                  SIZE_MB=$(du -m "$FILE" | cut -f1)
                  if [ "$SIZE_MB" -gt 5 ]; then
                     echo "âœ… Success: $FILE ($SIZE_MB MB)"
                     break
                  fi
               fi
            fi
            sleep 3
          done
          kill $TAIL_PID || true

      # 7. ä¸Šä¼ 
      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: decrypted-app
          path: /home/appuser/Downloads/*.ipa
