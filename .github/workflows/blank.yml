name: Firefox Stealth VNC
on: 
  workflow_dispatch:

jobs:
  firefox-desktop:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:22.04
      # Firefox éœ€è¦ shm-size é˜²æ­¢å´©æºƒ
      options: --privileged --shm-size=2gb
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. å®‰è£…åŸºç¡€å·¥å…· & æ·»åŠ  Firefox PPA æº (é¿å¼€ Snap å‘)
      - name: Install Firefox & GUI
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          apt-get update
          apt-get install -y software-properties-common wget curl git net-tools sudo debconf-utils
          
          # æ·»åŠ  Mozilla PPA ä»¥è·å–åŸç”Ÿ .deb åŒ…
          add-apt-repository -y ppa:mozillateam/ppa
          
          # è®¾ç½®ä¼˜å…ˆçº§ï¼Œç¡®ä¿ä¸å®‰è£… Snap ç‰ˆæœ¬
          echo '
          Package: *
          Pin: release o=LP-PPA-mozillateam
          Pin-Priority: 1001
          ' | tee /etc/apt/preferences.d/mozilla-firefox
          
          apt-get update
          # å®‰è£… Firefox å’Œ å¸¸ç”¨ä¸­æ–‡å­—ä½“/å¾®è½¯å­—ä½“
          apt-get install -y firefox fonts-liberation fonts-noto-color-emoji fontconfig ttf-mscorefonts-installer
          
          # å®‰è£… VNC ç¯å¢ƒ
          apt-get install -y xvfb fluxbox x11vnc python3
          
          # æ¥å—å¾®è½¯å­—ä½“åè®® (é˜²æ­¢æŠ¥é”™)
          echo "ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true" | debconf-set-selections
          # é‡æ–°é…ç½®å­—ä½“
          fc-cache -f -v

      # 2. å®‰è£… noVNC
      - name: Install noVNC
        run: |
          git clone https://github.com/novnc/noVNC.git /opt/noVNC
          git clone https://github.com/novnc/websockify /opt/noVNC/utils/websockify
          ln -s /opt/noVNC/vnc.html /opt/noVNC/index.html

      # 3. é…ç½® Firefox éšèº« Profile (æ ¸å¿ƒåçˆ¬)
      - name: Configure Firefox Profile
        run: |
          # åˆ›å»º Profile æ–‡ä»¶å¤¹
          mkdir -p /root/.mozilla/firefox/stealth.default
          
          # åˆ›å»º profiles.ini å‘Šè¯‰ Firefox ä½¿ç”¨è¿™ä¸ªç›®å½•
          cat <<EOF > /root/.mozilla/firefox/profiles.ini
          [Profile0]
          Name=default
          IsRelative=1
          Path=stealth.default
          Default=1
          
          [General]
          StartWithLastProfile=1
          Version=2
          EOF
          
          # å†™å…¥ user.js (Firefox çš„é«˜çº§é…ç½®)
          # è¿™é‡Œçš„è®¾ç½®å¯¹åº”äº† about:config ä¸­çš„å¼€å…³
          cat <<EOF > /root/.mozilla/firefox/stealth.default/user.js
          // === æ ¸å¿ƒåçˆ¬è®¾ç½® ===
          user_pref("dom.webdriver.enabled", false);           // å½»åº•å…³é—­ WebDriver æ ‡è®°
          user_pref("use_automation_extension", false);        // ç¦ç”¨è‡ªåŠ¨åŒ–æ‰©å±•æ”¯æŒ
          user_pref("general.useragent.override", "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:120.0) Gecko/20100101 Firefox/120.0"); // ä¼ªè£… Win10
          
          // === éšç§ä¸æŒ‡çº¹ ===
          user_pref("media.peerconnection.enabled", false);    // ç¦ç”¨ WebRTCï¼Œé˜²æ­¢ IP æ³„éœ²
          user_pref("privacy.resistFingerprinting", false);    // æ³¨æ„ï¼šæœ‰æ—¶å€™å¼€å¯è¿™ä¸ªåè€Œä¼šè¢« CF æ ‡è®°ï¼Œå…ˆä¿æŒ false æ¨¡æ‹Ÿæ™®é€šäºº
          user_pref("network.http.sendRefererHeader", 2);      // æ­£å¸¸å‘é€ Referer
          
          // === æ€§èƒ½ä¸æ˜¾ç¤º ===
          user_pref("browser.tabs.remote.autostart", true);
          user_pref("gfx.webrender.all", false);               // å®¹å™¨å†…ç¦ç”¨éƒ¨åˆ†ç¡¬ä»¶åŠ é€Ÿé˜²æ­¢é»‘å±
          EOF

      # 4. å¯åŠ¨æ¡Œé¢ç¯å¢ƒ
      - name: Start Virtual Desktop
        run: |
          # å¯åŠ¨ DBUS (Firefox éœ€è¦)
          mkdir -p /var/run/dbus
          dbus-daemon --system --fork
          
          Xvfb :99 -screen 0 1280x800x24 &
          export DISPLAY=:99
          fluxbox &
          x11vnc -display :99 -forever -passwd secret -bg -noxdamage
          /opt/noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
          sleep 3

      # 5. å¯åŠ¨ Firefox å¹¶å»ºç«‹éš§é“
      - name: Launch Firefox & Tunnel
        run: |
          export DISPLAY=:99
          
          # å¯åŠ¨ Firefox (åå°è¿è¡Œ)
          # --no-remote: å…è®¸åŒæ—¶è¿è¡Œå¤šä¸ªå®ä¾‹
          # --new-instance: ç¡®ä¿å¯åŠ¨æ–°è¿›ç¨‹
          nohup firefox --no-remote --new-instance "https://nowsecure.nl" > firefox.log 2>&1 &
          
          echo "Firefox launching..."
          sleep 5
          
          # å¯åŠ¨ Cloudflare Tunnel
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          dpkg -i cloudflared.deb
          cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          echo "Waiting for Tunnel..."
          sleep 10
          
          TUNNEL_URL=$(grep -oE "https://[a-zA-Z0-9-]+\.trycloudflare\.com" tunnel.log | head -1)
          
          echo "=========================================================="
          echo "ğŸ¦Š Firefox éšèº«ç‰ˆå·²å°±ç»ª"
          echo "ğŸ‘‰ è¿™ä¸ªç‰ˆæœ¬å¼ºåˆ¶å…³é—­äº† webdriver æ ‡è®°å¹¶ä¼ªè£…ä¸º Windows"
          echo "ğŸ”— VNC é“¾æ¥: $TUNNEL_URL/vnc.html?autoconnect=true&password=secret"
          echo "=========================================================="
          
          # ä¿æŒè¿è¡Œ
          tail -f firefox.log
