name: Playwright Web VNC (Stable)
on: 
  workflow_dispatch:

jobs:
  browser-gui:
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.40.0-jammy
      options: --shm-size=2gb
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install GUI & VNC Tools
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          apt-get update
          apt-get install -y --no-install-recommends xvfb fluxbox x11vnc python3 python3-pip git net-tools curl ca-certificates
          
          git clone https://github.com/novnc/noVNC.git /opt/noVNC
          git clone https://github.com/novnc/websockify /opt/noVNC/utils/websockify
          ln -s /opt/noVNC/vnc.html /opt/noVNC/index.html

      - name: Start Desktop Environment
        run: |
          # 1. å¯åŠ¨è™šæ‹Ÿå±å¹•
          Xvfb :99 -screen 0 1280x720x24 &
          export DISPLAY=:99
          
          # 2. å¯åŠ¨çª—å£ç®¡ç†å™¨
          fluxbox &
          
          # 3. å¯åŠ¨ VNC Server
          x11vnc -display :99 -forever -passwd secret -bg
          
          # 4. å¯åŠ¨ noVNC (åå°è¿è¡Œ)
          /opt/noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
          
          # å…³é”®ï¼šç­‰å¾…ç«¯å£ 6080 å¯åŠ¨æˆåŠŸï¼Œé¿å…éš§é“è¿ä¸ä¸Š
          echo "Waiting for noVNC to be ready..."
          for i in {1..10}; do
            if netstat -tuln | grep 6080; then
              echo "noVNC is ready!"
              break
            fi
            sleep 1
          done

      - name: Launch Browser
        run: |
          export DISPLAY=:99
          nohup npx playwright codegen wikipedia.org &

      - name: Start Cloudflare Tunnel
        run: |
          # ä¸‹è½½ Cloudflare Tunnel å®¢æˆ·ç«¯
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          dpkg -i cloudflared.deb

          # å¯åŠ¨éš§é“ (æ— éœ€ç™»å½•ï¼Œä½¿ç”¨ä¸´æ—¶éš§é“)
          # å°†æ—¥å¿—è¾“å‡ºåˆ°æ–‡ä»¶ä»¥ä¾¿æå– URL
          cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          echo "Starting tunnel..."
          sleep 5
          
          # æå– trycloudflare.com çš„ URL
          TUNNEL_URL=$(grep -oE "https://[a-zA-Z0-9-]+\.trycloudflare\.com" tunnel.log | head -1)
          
          if [ -z "$TUNNEL_URL" ]; then
            echo "Error: Failed to get tunnel URL. Logs:"
            cat tunnel.log
            exit 1
          fi

          # æ‹¼æ¥ VNC è·¯å¾„
          VNC_URL="$TUNNEL_URL/vnc.html?autoconnect=true&password=secret"

          echo "=========================================================="
          echo "ğŸš€ è¿œç¨‹æ¡Œé¢å·²å°±ç»ª (Cloudflare ç‰ˆ - æ›´ç¨³å®š)"
          echo ""
          echo "ğŸ”— è®¿é—®åœ°å€ (ç›´æ¥ç‚¹å‡»):"
          echo "$VNC_URL"
          echo ""
          echo "ğŸ’¡ æç¤º: æ— éœ€éªŒè¯ IPï¼Œç›´æ¥è®¿é—®å³å¯ã€‚"
          echo "=========================================================="

      - name: Keep Alive (20 min)
        run: sleep 1200
