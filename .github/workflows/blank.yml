name: Nested MacOS Virtualization (Tart)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  run-vm:
    # å¿…é¡»ä½¿ç”¨ macos-14 æˆ– macos-15 (Apple Silicon èŠ¯ç‰‡)
    runs-on: macos-15

    steps:
      - name: Free Disk Space (Crucial!)
        run: |
          echo "Before cleanup:"
          df -h
          # åˆ é™¤ä¸éœ€è¦çš„åºå¤§ç»„ä»¶ä»¥è…¾å‡ºç©ºé—´ (çº¦èƒ½è…¾å‡º 10GB+)
          sudo rm -rf /Users/runner/Library/Android/sdk
          sudo rm -rf /usr/local/lib/node_modules
          echo "After cleanup:"
          df -h
        
      - name: Install Tart
        run: brew install cirruslabs/cli/tart

      - name: Pull pre-built macOS Image
        # è·å–ä¸€ä¸ªå·²ç»é…ç½®å¥½çš„è½»é‡çº§ macOS é•œåƒ (Sequoia)
        run: tart pull ghcr.io/cirruslabs/macos-sonoma-vanilla:latest

      - name: Run Script inside VM
        run: |
          # åˆ›å»ºä¸€ä¸ªæœ¬åœ°è¿è¡Œè„šæœ¬
          cat << 'EOF' > guest_script.sh
          echo "-------------------------------"
          echo "ğŸš€ Hello from INSIDE the VM!"
          sw_vers
          whoami
          echo "-------------------------------"
          EOF
          
          chmod +x guest_script.sh

          # ä½¿ç”¨ tart è¿è¡Œè™šæ‹Ÿæœºå¹¶æ‰§è¡Œè„šæœ¬
          # æ³¨æ„ï¼šåœ¨ CI ä¸­è¿è¡Œ VM éå¸¸æ¶ˆè€—èµ„æºï¼Œå¯èƒ½ä¼šå¾ˆæ…¢
          tart run ghcr.io/cirruslabs/macos-sonoma-vanilla:latest --command "bash" < guest_script.sh
