name: Manual IPA Download & Artifact
on: 
  workflow_dispatch:

jobs:
  ipa-downloader:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:22.04
      options: --privileged --shm-size=2gb
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. å®‰è£… Firefox, VNC, å’Œ zip å·¥å…·
      - name: Install Environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          apt-get update
          apt-get install -y software-properties-common wget curl git net-tools sudo debconf-utils vim unzip
          
          add-apt-repository -y ppa:mozillateam/ppa
          
          echo '
          Package: *
          Pin: release o=LP-PPA-mozillateam
          Pin-Priority: 1001
          ' | tee /etc/apt/preferences.d/mozilla-firefox
          
          apt-get update
          apt-get install -y firefox fonts-liberation fonts-noto-color-emoji fontconfig ttf-mscorefonts-installer xvfb fluxbox x11vnc python3 pulseaudio dbus-x11
          
          echo "ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true" | debconf-set-selections
          fc-cache -f -v
          
          git clone https://github.com/novnc/noVNC.git /opt/noVNC
          git clone https://github.com/novnc/websockify /opt/noVNC/utils/websockify
          ln -s /opt/noVNC/vnc.html /opt/noVNC/index.html
          chmod -R 777 /opt/noVNC

      # 2. åˆ›å»ºæ™®é€šç”¨æˆ·å¹¶é…ç½® Firefox
      - name: Setup User & Firefox Profile
        run: |
          useradd -m -s /bin/bash appuser
          
          su appuser -c "mkdir -p /home/appuser/.mozilla/firefox/stealth.default"
          
          su appuser -c "cat <<EOF > /home/appuser/.mozilla/firefox/profiles.ini
          [Profile0]
          Name=default
          IsRelative=1
          Path=stealth.default
          Default=1
          [General]
          StartWithLastProfile=1
          Version=2
          EOF"
          
          # å†™å…¥å…è®¸å¹¿å‘Šå’Œè¿½è¸ªçš„ user.js
          su appuser -c "cat <<EOF > /home/appuser/.mozilla/firefox/stealth.default/user.js
          user_pref(\"dom.webdriver.enabled\", false);
          user_pref(\"general.useragent.override\", \"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:120.0) Gecko/20100101 Firefox/120.0\");
          user_pref(\"privacy.trackingprotection.enabled\", false);
          user_pref(\"network.cookie.cookieBehavior\", 0);
          user_pref(\"media.peerconnection.enabled\", false);
          EOF"
          
          # åˆ›å»ºä¸‹è½½ç›®å½•
          su appuser -c "mkdir -p /home/appuser/Downloads"

      # 3. å¯åŠ¨æ¡Œé¢å’Œ Firefox
      - name: Start Desktop & Firefox
        run: |
          # å¯åŠ¨ç³»ç»ŸæœåŠ¡
          service dbus start || true
          
          # åˆ›å»ºå¹¶è¿è¡Œæ¡Œé¢å¯åŠ¨è„šæœ¬
          cat <<EOF > /home/appuser/run_desktop.sh
          #!/bin/bash
          export DISPLAY=:99
          export HOME=/home/appuser
          Xvfb :99 -screen 0 1280x800x24 &
          sleep 2
          fluxbox &
          x11vnc -display :99 -forever -passwd secret -bg -noxdamage
          /opt/noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
          EOF
          chmod +x /home/appuser/run_desktop.sh
          su appuser -c "/home/appuser/run_desktop.sh"
          
          # åˆ›å»ºå¹¶è¿è¡Œæµè§ˆå™¨å¯åŠ¨è„šæœ¬
          cat <<EOF > /home/appuser/run_firefox.sh
          #!/bin/bash
          export DISPLAY=:99
          export HOME=/home/appuser
          # æ‰“å¼€ç›®æ ‡ URL
          firefox --no-remote --new-instance "https://decrypt.day/app/id1489932710" &
          EOF
          chmod +x /home/appuser/run_firefox.sh
          su appuser -c "/home/appuser/run_firefox.sh"

      # 4. å¯åŠ¨éš§é“å¹¶æ˜¾ç¤ºé“¾æ¥
      - name: Start Tunnel & Show Link
        run: |
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          dpkg -i cloudflared.deb
          cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          echo "Waiting for Tunnel..."
          sleep 10
          
          TUNNEL_URL=$(grep -oE "https://[a-zA-Z0.9-]+\.trycloudflare\.com" tunnel.log | head -1)
          
          echo "=========================================================="
          echo "âœ… ç¯å¢ƒå°±ç»ª, è¯·å¼€å§‹æ‰‹åŠ¨æ“ä½œ"
          echo "ğŸ”— VNC é“¾æ¥: $TUNNEL_URL/vnc.html?autoconnect=true&password=secret"
          echo "â³ ç­‰å¾…ä¸‹è½½ IPA æ–‡ä»¶ä¸­... (è¶…æ—¶æ—¶é—´ 15 åˆ†é’Ÿ)"
          echo "=========================================================="
          
      # 5. [æ ¸å¿ƒ] ç›‘æ§ä¸‹è½½å¹¶éªŒè¯
      - name: Monitor for IPA Download
        id: monitor_download # ç»™è¿™ä¸€æ­¥ä¸€ä¸ªIDï¼Œæ–¹ä¾¿åé¢å¼•ç”¨å®ƒçš„è¾“å‡º
        run: |
          # è®¾ç½®è¶…æ—¶æ—¶é—´ (180 æ¬¡ * 5 ç§’ = 900 ç§’ = 15 åˆ†é’Ÿ)
          TIMEOUT=180
          COUNT=0
          
          echo "Monitoring /home/appuser/Downloads for an IPA file..."
          
          while [ $COUNT -lt $TIMEOUT ]; do
            # ä»¥ appuser èº«ä»½æŸ¥æ‰¾æ–‡ä»¶
            # -maxdepth 1: åªåœ¨å½“å‰ç›®å½•æŸ¥æ‰¾
            # -size -100M: å°äº 100MB
            IPA_FILE=$(su appuser -c 'find /home/appuser/Downloads -maxdepth 1 -type f -name "*.ipa" -size -100M' | head -n 1)
            
            if [ -n "$IPA_FILE" ]; then
              echo "âœ… Found potential IPA file: $IPA_FILE"
              echo "Checking file integrity..."
              
              # IPA æ˜¯ zip æ ¼å¼ï¼Œç”¨ unzip -t æµ‹è¯•å®Œæ•´æ€§
              # -t: test, -qq: quiet quiet (æ— è¾“å‡ºé™¤éæŠ¥é”™)
              if unzip -tqq "$IPA_FILE"; then
                echo "âœ… File integrity confirmed. Download complete."
                # å°†æ–‡ä»¶è·¯å¾„è¾“å‡ºï¼Œä¾›ä¸‹ä¸€æ­¥ä½¿ç”¨
                echo "ipa_path=$IPA_FILE" >> $GITHUB_OUTPUT
                exit 0
              else
                echo "âŒ File is corrupted or still downloading. Retrying..."
              fi
            fi
            
            sleep 5
            COUNT=$((COUNT + 1))
          done
          
          echo "âŒ Timed out after 15 minutes. No valid IPA file was downloaded."
          exit 1
          
      # 6. ä¸Šä¼ äº§ç‰©
      - name: Upload IPA Artifact
        if: success() # åªæœ‰åœ¨ monitor æˆåŠŸæ—¶æ‰è¿è¡Œ
        uses: actions/upload-artifact@v4
        with:
          name: downloaded-ipa # äº§ç‰©çš„åå­—
          path: ${{ steps.monitor_download.outputs.ipa_path }} # ä½¿ç”¨ä¸Šä¸€æ­¥è¾“å‡ºçš„æ–‡ä»¶è·¯å¾„
          retention-days: 1 # äº§ç‰©ä¿ç•™1å¤©

      # 7. æ¸…ç† (æ— è®ºæˆåŠŸå¤±è´¥éƒ½æ‰§è¡Œ)
      - name: Cleanup Processes
        if: always()
        run: |
          echo "Cleaning up background processes..."
          # å¼ºåˆ¶æ€æ­»æ‰€æœ‰ç›¸å…³è¿›ç¨‹
          pkill -f firefox || true
          pkill -f x11vnc || true
          pkill -f Xvfb || true
          pkill -f fluxbox || true
          echo "Cleanup complete."
