name: Windows RDP Crawler (Fixed)
on: 
  workflow_dispatch:

jobs:
  win-rdp:
    runs-on: windows-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set User Password
        shell: powershell
        run: |
          $password = "SecretPass123!"
          net user runneradmin $password
          echo "Password set successfully."

      - name: Install Python & Playwright
        shell: powershell
        run: |
          pip install playwright
          playwright install chromium
          python -m playwright install chromium

      - name: Create Python Script
        shell: powershell
        run: |
          $scriptContent = @"
          import time
          from playwright.sync_api import sync_playwright

          print('--- Starting Windows Chrome ---')
          try:
              with sync_playwright() as p:
                  # å¯åŠ¨ Chrome
                  browser = p.chromium.launch(headless=False, args=["--start-maximized"])
                  context = browser.new_context(viewport=None)
                  page = context.new_page()
                  
                  print('--- Navigating to Google... ---')
                  try:
                      page.goto("https://www.google.com")
                  except:
                      pass
                  
                  print('--- Browser Ready. Keep Alive... ---')
                  while True:
                      time.sleep(10)
          except Exception as e:
              print(f"Error: {e}")
              while True:
                   time.sleep(10)
          "@
          Set-Content -Path run_win.py -Value $scriptContent

      - name: Enable RDP Access
        shell: powershell
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -value 1

      # --- å…³é”®ä¿®å¤éƒ¨åˆ†å¼€å§‹ ---
      - name: Start Ngrok Tunnel (With Retry)
        shell: powershell
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          if ($env:NGROK_AUTH_TOKEN -eq "") {
            Write-Error "âŒ é”™è¯¯: è¯·å…ˆåœ¨ GitHub Secrets ä¸­é…ç½® NGROK_AUTH_TOKEN"
            exit 1
          }
          
          # ä¸‹è½½ Ngrok
          Invoke-WebRequest -Uri https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip
          Expand-Archive ngrok.zip -DestinationPath . -Force
          
          # é…ç½® Token
          .\ngrok.exe config add-authtoken $env:NGROK_AUTH_TOKEN
          
          # å¯åŠ¨ Ngrok å¹¶å°†æ—¥å¿—è¾“å‡ºåˆ°æ–‡ä»¶
          # ä½¿ç”¨ --log=stdout ç¡®ä¿æ—¥å¿—è¢«å†™å…¥æ–‡ä»¶
          Start-Process -FilePath ".\ngrok.exe" -ArgumentList "tcp 3389 --log=stdout" -RedirectStandardOutput ngrok.log -RedirectStandardError ngrok.log -WindowStyle Hidden -PassThru
          
          Write-Host "Waiting for Ngrok tunnel to initialize..."
          
          # å¾ªç¯é‡è¯•è·å– URL (æœ€å¤šå°è¯• 20 æ¬¡ï¼Œæ¯æ¬¡ 1 ç§’)
          $url = $null
          for ($i=1; $i -le 20; $i++) {
            try {
              $response = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -ErrorAction Stop
              $url = $response.tunnels[0].public_url
              if ($url) { break }
            } catch {
              Write-Host "Attempt $i: Ngrok API not ready yet..."
              Start-Sleep -Seconds 1
            }
          }

          if (-not $url) {
            Write-Error "âŒ æ— æ³•è·å–éš§é“ URLã€‚Ngrok å¯èƒ½å¯åŠ¨å¤±è´¥ã€‚"
            Write-Host "=== Ngrok Log Content ==="
            Get-Content ngrok.log
            exit 1
          }
          
          # æ¸…ç† URL å‰ç¼€
          $cleanUrl = $url -replace "tcp://", ""
          
          Write-Host "======================================================"
          Write-Host "âœ… Windows RDP å¯åŠ¨æˆåŠŸï¼"
          Write-Host ""
          Write-Host "ğŸ‘‰ è¿æ¥åœ°å€ (Computer): $cleanUrl"
          Write-Host "ğŸ‘‰ ç”¨æˆ·å (User): runneradmin"
          Write-Host "ğŸ‘‰ å¯†ç  (Password): SecretPass123!"
          Write-Host ""
          Write-Host "âš ï¸ æ³¨æ„: å¦‚æœè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä½ çš„ Ngrok è´¦å·æ˜¯å¦å·²éªŒè¯é‚®ç®± (TCPéš§é“éœ€è¦éªŒè¯)ã€‚"
          Write-Host "======================================================"
      # --- å…³é”®ä¿®å¤éƒ¨åˆ†ç»“æŸ ---

      - name: Run Browser & Keep Alive
        shell: powershell
        run: |
          python run_win.py
