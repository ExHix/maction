name: Native Chrome Stealth VNC
on: 
  workflow_dispatch:

jobs:
  chrome-desktop:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:22.04 # ‰ΩøÁî®Á∫ØÂáÄÁöÑ Ubuntu ÈïúÂÉè
      options: --shm-size=2gb --security-opt seccomp=unconfined
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Desktop & Chrome (Native)
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          apt-get update
          # 1. ÂÆâË£ÖÂü∫Á°ÄÂ∑•ÂÖ∑ÂíåÊ°åÈù¢ÁéØÂ¢É
          apt-get install -y wget curl git net-tools xvfb fluxbox x11vnc python3 python3-pip sudo pulseaudio
          
          # 2. [ÂÖ≥ÈîÆ] ÂÆâË£ÖÂæÆËΩØÂ∏∏Áî®Â≠ó‰Ωì (ÁªïËøáÂ≠ó‰ΩìÊåáÁ∫πÊ£ÄÊµã)
          apt-get install -y --no-install-recommends software-properties-common
          echo "ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true" | debconf-set-selections
          apt-get install -y --no-install-recommends ttf-mscorefonts-installer fonts-liberation fonts-noto-color-emoji
          
          # 3. ‰∏ãËΩΩÂπ∂ÂÆâË£ÖÂÆòÊñπ Google Chrome Stable (Èùû Chromium)
          wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          apt-get install -y ./google-chrome-stable_current_amd64.deb
          
          # 4. ÂÆâË£Ö noVNC
          git clone https://github.com/novnc/noVNC.git /opt/noVNC
          git clone https://github.com/novnc/websockify /opt/noVNC/utils/websockify
          ln -s /opt/noVNC/vnc.html /opt/noVNC/index.html
          
          # Âà∑Êñ∞Â≠ó‰ΩìÁºìÂ≠ò
          fc-cache -f -v

      - name: Start Desktop Environment
        run: |
          # ÂêØÂä®ËôöÊãüÊòæÁ§∫Âô®
          Xvfb :99 -screen 0 1280x800x24 &
          export DISPLAY=:99
          
          # ÂêØÂä®Á™óÂè£ÁÆ°ÁêÜÂô®
          fluxbox &
          
          # ÂêØÂä® VNC Server
          x11vnc -display :99 -forever -passwd secret -bg -noxdamage
          
          # ÂêØÂä® noVNC (ËΩ¨ Web ËÆøÈóÆ)
          /opt/noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
          
          echo "Waiting for Desktop..."
          sleep 5

      - name: Launch Native Chrome (Stealth Mode)
        run: |
          export DISPLAY=:99
          
          # ÂÆö‰πâ‰º™Ë£ÖÊàê Windows 10 ÁöÑ User Agent
          WIN_UA="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
          
          # ÂêØÂä® Chrome
          # --no-sandbox: Docker ÂøÖÈ°ª
          # --disable-blink-features=AutomationControlled: Ê†∏ÂøÉÂèçÁà¨ÔºåÈöêËóèËá™Âä®ÂåñÁâπÂæÅ
          # --start-maximized: ÂÖ®Â±è
          # --user-agent: ‰º™Ë£ÖË∫´‰ªΩ
          
          nohup google-chrome-stable \
            --no-sandbox \
            --disable-dev-shm-usage \
            --start-maximized \
            --disable-infobars \
            --disable-blink-features=AutomationControlled \
            --user-agent="$WIN_UA" \
            --user-data-dir=/tmp/chrome_profile \
            "https://bot.sannysoft.com/" > chrome.log 2>&1 &
            
          echo "Chrome launched via command line."

      - name: Start Cloudflare Tunnel
        run: |
          # ‰ΩøÁî® Cloudflare Á©øÈÄèÔºåÊó†ÈúÄÈ™åËØÅ IPÔºåÊó†ÈúÄÈÖçÁΩÆ
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          dpkg -i cloudflared.deb
          
          cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          echo "Starting Tunnel..."
          sleep 10
          
          TUNNEL_URL=$(grep -oE "https://[a-zA-Z0-9-]+\.trycloudflare\.com" tunnel.log | head -1)
          
          if [ -z "$TUNNEL_URL" ]; then
            echo "‚ùå Failed to get tunnel URL."
            cat tunnel.log
            exit 1
          fi

          echo "=========================================================="
          echo "üïµÔ∏è‚Äç‚ôÇÔ∏è ÂéüÁîü Chrome ËøúÁ®ãÊ°åÈù¢Â∑≤Â∞±Áª™"
          echo ""
          echo "üîó ËÆøÈóÆÂú∞ÂùÄ (ÁÇπÂáªÂç≥Áî®):"
          echo "$TUNNEL_URL/vnc.html?autoconnect=true&password=secret"
          echo ""
          echo "üí° Â∑≤Ëá™Âä®ÊâìÂºÄ bot.sannysoft.com ËøõË°åÊåáÁ∫πËá™Êµã"
          echo "=========================================================="

      - name: Keep Alive (Check Chrome)
        run: |
          echo "Checking if Chrome is running..."
          sleep 5
          if pgrep chrome > /dev/null; then
            echo "‚úÖ Chrome is running. Keeping session alive for 20 mins..."
            sleep 1200
          else
            echo "‚ùå Chrome crashed. Showing logs:"
            cat chrome.log
            exit 1
          fi
