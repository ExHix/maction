name: Debug Playwright VNC (Fixed)
on: 
  workflow_dispatch:

jobs:
  debug-browser:
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.40.0-jammy
      options: --shm-size=2gb --security-opt seccomp=unconfined
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Dependencies & Python Playwright
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          apt-get update
          # å®‰è£…ç³»ç»Ÿå·¥å…·
          apt-get install -y xvfb fluxbox x11vnc python3 python3-pip git net-tools curl ca-certificates procps
          
          # å…³é”®ä¿®å¤ï¼šå®‰è£… Python ç‰ˆ Playwright
          pip3 install playwright
          
          # ç¡®ä¿å®‰è£…äº†åŒ¹é…çš„æµè§ˆå™¨å†…æ ¸ (é˜²æ­¢ç‰ˆæœ¬ä¸åŒ¹é…æŠ¥é”™)
          python3 -m playwright install chromium
          
          # å®‰è£… noVNC
          git clone https://github.com/novnc/noVNC.git /opt/noVNC
          git clone https://github.com/novnc/websockify /opt/noVNC/utils/websockify
          ln -s /opt/noVNC/vnc.html /opt/noVNC/index.html

      - name: Setup Python Script
        run: |
          cat <<EOF > run_browser.py
          import sys
          import time
          from playwright.sync_api import sync_playwright

          print("--- [PYTHON] Script started ---")
          try:
              with sync_playwright() as p:
                  print("--- [PYTHON] Launching Chromium... ---")
                  # æ³¨æ„ï¼šè¿™é‡Œå»æ‰äº† executable_pathï¼Œè®©å®ƒä½¿ç”¨ playwright install ä¸‹è½½çš„ç‰ˆæœ¬ï¼Œæœ€ç¨³å¦¥
                  browser = p.chromium.launch(
                      headless=False,
                      args=[
                          "--start-maximized",
                          "--no-sandbox",
                          "--disable-setuid-sandbox",
                          "--disable-dev-shm-usage",
                          "--disable-gpu" 
                      ]
                  )
                  print("--- [PYTHON] Browser launched object created ---")
                  
                  # ä½¿ç”¨ None viewport é…åˆ start-maximized å®ç°å…¨å±
                  context = browser.new_context(viewport=None)
                  page = context.new_page()
                  
                  print("--- [PYTHON] Navigating to Google... ---")
                  page.goto("https://www.google.com")
                  print("--- [PYTHON] Page Title:", page.title())
                  
                  # æˆªå›¾éªŒè¯
                  page.screenshot(path="debug_screenshot.png")
                  print("--- [PYTHON] Screenshot taken ---")

                  print("--- [PYTHON] Entering Keep-Alive Loop ---")
                  while True:
                      time.sleep(10)
          except Exception as e:
              print(f"!!! [PYTHON ERROR] !!! : {e}")
              sys.exit(1)
          EOF

      - name: Start Environment (Xvfb & VNC)
        run: |
          # 1. å¯åŠ¨ Xvfb
          Xvfb :99 -screen 0 1280x800x24 &
          export DISPLAY=:99
          
          # 2. å¯åŠ¨ Fluxbox (çª—å£ç®¡ç†å™¨)
          fluxbox &
          
          # 3. å¯åŠ¨ VNC
          x11vnc -display :99 -forever -passwd secret -bg -noxdamage
          
          # 4. å¯åŠ¨ noVNC
          /opt/noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &

      - name: ğŸ”´ RUN BROWSER & SHOW LOGS
        run: |
          export DISPLAY=:99
          
          echo "Starting python script..."
          python3 run_browser.py > browser_output.txt 2>&1 &
          PID=$!
          
          echo "Waiting 15 seconds for browser start..."
          sleep 15
          
          echo "==================== BROWSER LOGS ===================="
          cat browser_output.txt
          echo "======================================================"
          
          if ! kill -0 $PID 2>/dev/null; then
            echo "âŒ CRITICAL: Browser script crashed again."
            exit 1
          else
            echo "âœ… Browser script is running! Process ID: $PID"
          fi

      - name: Start Cloudflare Tunnel
        run: |
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          dpkg -i cloudflared.deb
          cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          sleep 8
          TUNNEL_URL=$(grep -oE "https://[a-zA-Z0-9-]+\.trycloudflare\.com" tunnel.log | head -1)
          echo "ğŸ”— è®¿é—®åœ°å€: $TUNNEL_URL/vnc.html?autoconnect=true&password=secret"

      - name: Keep Alive
        run: sleep 1200
