name: Nested MacOS Virtualization (Tart)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  run-vm:
    # å¿…é¡»ä½¿ç”¨ macos-14 æˆ– macos-15 (Apple Silicon èŠ¯ç‰‡)
    runs-on: macos-14

    steps:
      - name: Install Tart
        run: brew install tart

      - name: Pull pre-built macOS Image
        # è·å–ä¸€ä¸ªå·²ç»é…ç½®å¥½çš„è½»é‡çº§ macOS é•œåƒ (Sequoia)
        run: tart pull ghcr.io/cirruslabs/macos-sequoia-vanilla:15.1

      - name: Run Script inside VM
        run: |
          # åˆ›å»ºä¸€ä¸ªæœ¬åœ°è¿è¡Œè„šæœ¬
          cat << 'EOF' > guest_script.sh
          echo "-------------------------------"
          echo "ğŸš€ Hello from INSIDE the VM!"
          sw_vers
          whoami
          echo "-------------------------------"
          EOF
          
          chmod +x guest_script.sh

          # ä½¿ç”¨ tart è¿è¡Œè™šæ‹Ÿæœºå¹¶æ‰§è¡Œè„šæœ¬
          # æ³¨æ„ï¼šåœ¨ CI ä¸­è¿è¡Œ VM éå¸¸æ¶ˆè€—èµ„æºï¼Œå¯èƒ½ä¼šå¾ˆæ…¢
          tart run ghcr.io/cirruslabs/macos-sequia-vanilla:latest --command "bash" < guest_script.sh
