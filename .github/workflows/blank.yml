name: Fake-Mac Crawler Desktop
on: 
  workflow_dispatch:

jobs:
  stealth-browser:
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.40.0-jammy
      options: --shm-size=2gb --security-opt seccomp=unconfined
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Fonts & Tools (åçˆ¬å…³é”®)
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          apt-get update
          # å®‰è£…å¸¸ç”¨å·¥å…·
          apt-get install -y xvfb fluxbox x11vnc python3 python3-pip git net-tools curl ca-certificates procps
          
          # [å…³é”®æ­¥éª¤] å®‰è£…å¾®è½¯æ ¸å¿ƒå­—ä½“å’Œå¸¸ç”¨å­—ä½“ï¼Œé˜²æ­¢å› å­—ä½“ç¼ºå¤±è¢«è¯†åˆ«ä¸º Linux æœºå™¨äºº
          echo "ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true" | debconf-set-selections
          apt-get install -y --no-install-recommends ttf-mscorefonts-installer fonts-liberation fonts-noto-color-emoji fonts-freefont-ttf
          
          # åˆ·æ–°å­—ä½“ç¼“å­˜
          fc-cache -f -v
          
          # å®‰è£…ç¯å¢ƒä¾èµ–
          pip3 install playwright
          python3 -m playwright install chromium
          
          # å®‰è£… Web VNC
          git clone https://github.com/novnc/noVNC.git /opt/noVNC
          git clone https://github.com/novnc/websockify /opt/noVNC/utils/websockify
          ln -s /opt/noVNC/vnc.html /opt/noVNC/index.html

      - name: Create Stealth Browser Script
        run: |
          cat <<EOF > run_stealth.py
          import sys
          import time
          from playwright.sync_api import sync_playwright

          # ä¼ªè£…æˆ macOS çš„ User Agent
          MAC_USER_AGENT = "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"

          print("--- [STEALTH] Starting Stealth Browser... ---")
          try:
              with sync_playwright() as p:
                  # ä½¿ç”¨ launch_persistent_context æ¨¡æ‹ŸçœŸå®ç”¨æˆ·æ•°æ®ç›®å½•
                  # è¿™æ¯”æ™®é€šçš„ launch æ›´éš¾è¢«æ£€æµ‹
                  user_data_dir = "/tmp/chrome_user_data"
                  
                  browser = p.chromium.launch_persistent_context(
                      user_data_dir,
                      headless=False,
                      user_agent=MAC_USER_AGENT, # 1. ä¼ªè£… UA
                      viewport=None,             # 2. ç¦ç”¨é»˜è®¤ Viewport
                      locale="en-US",            # 3. è®¾ç½®è¯­è¨€ç¯å¢ƒ
                      timezone_id="America/New_York", # 4. ä¼ªè£…æ—¶åŒº (å¯é€‰)
                      args=[
                          "--start-maximized",
                          "--no-sandbox",
                          "--disable-setuid-sandbox",
                          "--disable-dev-shm-usage",
                          "--disable-gpu",
                          # 5. [æ ¸å¿ƒåçˆ¬] ç¦ç”¨è‡ªåŠ¨åŒ–æ§åˆ¶ç‰¹æ€§
                          "--disable-blink-features=AutomationControlled", 
                          "--disable-infobars"
                      ]
                  )
                  
                  page = browser.pages[0]
                  
                  # 6. [æ ¸å¿ƒåçˆ¬] æ³¨å…¥è„šæœ¬ï¼ŒæŠ¹é™¤ WebDriver ç—•è¿¹
                  page.add_init_script("""
                      Object.defineProperty(navigator, 'webdriver', {
                          get: () => undefined
                      });
                  """)

                  print("--- [STEALTH] Navigating to Check Site... ---")
                  # è®¿é—®è¿™ä¸ªç½‘ç«™å¯ä»¥çœ‹åˆ°ä½ çš„ä¼ªè£…æ•ˆæœ
                  try:
                      page.goto("https://bot.sannysoft.com/") 
                      print("--- [STEALTH] Page Loaded. Check the VNC screen! ---")
                  except Exception as e:
                      print(f"Page load error: {e}")

                  # æˆªå›¾ç•™è¯
                  page.screenshot(path="stealth_check.png")

                  print("--- [STEALTH] Running... ---")
                  while True:
                      time.sleep(10)
          except Exception as e:
              print(f"!!! [ERROR] !!! : {e}")
              sys.exit(1)
          EOF

      - name: Start Environment (Xvfb & VNC)
        run: |
          Xvfb :99 -screen 0 1280x800x24 &
          export DISPLAY=:99
          fluxbox &
          x11vnc -display :99 -forever -passwd secret -bg -noxdamage
          /opt/noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &

      - name: ğŸ”´ RUN STEALTH BROWSER
        run: |
          export DISPLAY=:99
          echo "Launching Stealth Python Script..."
          python3 run_stealth.py > browser.log 2>&1 &
          PID=$!
          sleep 10
          cat browser.log

      - name: Start Cloudflare Tunnel
        run: |
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          dpkg -i cloudflared.deb
          cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          sleep 8
          TUNNEL_URL=$(grep -oE "https://[a-zA-Z0-9-]+\.trycloudflare\.com" tunnel.log | head -1)
          echo "=========================================================="
          echo "ğŸ•µï¸â€â™‚ï¸ ä¼ªè£…ç‰ˆæµè§ˆå™¨å·²å¯åŠ¨ (æ¨¡æ‹Ÿ macOS)"
          echo "ğŸ”— è®¿é—®åœ°å€: $TUNNEL_URL/vnc.html?autoconnect=true&password=secret"
          echo "=========================================================="

      - name: Keep Alive
        run: sleep 1200
