name: CF-Bypass Desktop (DrissionPage)
on: 
  workflow_dispatch:

jobs:
  bypass-cf:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:22.04
      # å¿…é¡»å¼€å¯ privileged æƒé™ï¼Œå¦åˆ™ DrissionPage çš„æŸäº›åº•å±‚æ“ä½œå—é™
      options: --privileged --shm-size=2gb
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          apt-get update
          # å®‰è£… Python å’Œ ä¾èµ–
          apt-get install -y python3 python3-pip wget curl net-tools xvfb fluxbox x11vnc sudo
          
          # å®‰è£… Chrome (DrissionPage éœ€è¦åŸç”Ÿ Chrome)
          wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          apt-get install -y ./google-chrome-stable_current_amd64.deb
          
          # å®‰è£… å¾®è½¯å­—ä½“ (æŒ‡çº¹ä¼ªè£…)
          apt-get install -y --no-install-recommends software-properties-common ttf-mscorefonts-installer fonts-liberation
          
          # å®‰è£… noVNC
          git clone https://github.com/novnc/noVNC.git /opt/noVNC
          git clone https://github.com/novnc/websockify /opt/noVNC/utils/websockify
          ln -s /opt/noVNC/vnc.html /opt/noVNC/index.html
          
          # å®‰è£… DrissionPage (è¿‡ç›¾ç¥å™¨)
          pip3 install DrissionPage

      - name: Start Virtual Desktop
        run: |
          Xvfb :99 -screen 0 1280x800x24 &
          export DISPLAY=:99
          fluxbox &
          x11vnc -display :99 -forever -passwd secret -bg -noxdamage
          /opt/noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
          sleep 3

      - name: Create Bypass Script
        run: |
          cat <<EOF > bypass.py
          from DrissionPage import ChromiumPage, ChromiumOptions
          import time
          
          # é…ç½® DrissionPage
          co = ChromiumOptions()
          co.set_argument('--no-sandbox')
          co.set_argument('--start-maximized')
          # å…³é”®ï¼šæŒ‡å®š user_data_dir ä½¿å¾—æµè§ˆå™¨åƒçœŸå®ç”¨æˆ·ä¸€æ ·ä¿å­˜ Cookie
          co.set_user_data_path('/tmp/drission_profile')
          
          # å°è¯•ä¼ªè£… Mac (IPå¤ªçƒ‚çš„æƒ…å†µä¸‹ï¼ŒMacæŒ‡çº¹é€šå¸¸æ¯”Winå¥½ä¸€ç‚¹ç‚¹)
          co.set_user_agent('Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36')

          print("--- Launching Browser via DrissionPage ---")
          page = ChromiumPage(addr_or_opts=co)
          
          target_url = "https://nowsecure.nl" # ä¸€ä¸ªç»å…¸çš„ CF æŒ‘æˆ˜æµ‹è¯•é¡µï¼Œæˆ–è€…æ¢æˆä½ çš„ç›®æ ‡URL
          
          print(f"--- Navigating to {target_url} ---")
          page.get(target_url)
          
          print("--- Checking for Cloudflare Challenge... ---")
          
          # ç®€å•çš„è‡ªåŠ¨è¿‡ç›¾é€»è¾‘ (DrissionPage å¹¶ä¸æ˜¯å…¨è‡ªåŠ¨é­”æ³•ï¼Œä½†å®ƒæ§åˆ¶ç‚¹å‡»çš„ç‰¹å¾éå¸¸åƒäºº)
          try:
              # å°è¯•å®šä½å¸¸è§çš„ CF iframe
              if page.ele('xpath://iframe[contains(@src, "cloudflare")]', timeout=5):
                  print("Found Cloudflare iframe!")
                  iframe = page.get_frame('xpath://iframe[contains(@src, "cloudflare")]')
                  # å°è¯•ç‚¹å‡»å¤é€‰æ¡†
                  checkbox = iframe.ele('xpath://input[@type="checkbox"] | //div[@id="challenge-stage"]', timeout=3)
                  if checkbox:
                      print("Found checkbox, attempting to click...")
                      time.sleep(1) # ç¨å¾®ç­‰å¾…ï¼Œæ¨¡æ‹Ÿäººç±»ååº”
                      checkbox.click()
                      print("Clicked!")
                  else:
                      print("Checkbox not found via simple selector.")
          except Exception as e:
              print(f"Auto-click logic info: {e}")

          print("--- Browser is Ready. Please control via VNC. ---")
          
          # ä¿æŒè¿è¡Œ
          while True:
              time.sleep(10)
          EOF

      - name: Run DrissionPage & Tunnel
        run: |
          export DISPLAY=:99
          
          # å¯åŠ¨ Python è„šæœ¬
          python3 bypass.py > browser.log 2>&1 &
          
          # å¯åŠ¨ Cloudflare Tunnel
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          dpkg -i cloudflared.deb
          cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          sleep 8
          TUNNEL_URL=$(grep -oE "https://[a-zA-Z0-9-]+\.trycloudflare\.com" tunnel.log | head -1)
          
          echo "=========================================================="
          echo "ğŸ›¡ï¸ DrissionPage å¢å¼ºç‰ˆæµè§ˆå™¨å·²å¯åŠ¨"
          echo "ğŸ‘‰ è¿™ä¸ªç‰ˆæœ¬ä½¿ç”¨äº† DP åº“ï¼Œæ¯”åŸç”Ÿ Chrome æ›´å®¹æ˜“è¿‡ç›¾"
          echo "ğŸ”— VNC åœ°å€: $TUNNEL_URL/vnc.html?autoconnect=true&password=secret"
          echo "=========================================================="
          
          # å®æ—¶æ‰“å°æµè§ˆå™¨æ—¥å¿—ï¼Œæ–¹ä¾¿ä½ çœ‹ DrissionPage çš„æ“ä½œ
          tail -f browser.log
