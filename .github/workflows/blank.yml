name: iOS App Downloader (WARP Final Fix)
on: 
  workflow_dispatch:

jobs:
  warp-download:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    container:
      image: ubuntu:22.04
      options: --privileged --shm-size=2gb
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. Á≥ªÁªüÂü∫Á°ÄÁéØÂ¢ÉÂÆâË£Ö
      - name: Install System Tools
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          # ‰øÆÂ§ç policy-rc.d ÈòªÊ≠¢ÊúçÂä°ÂêØÂä®ÁöÑÈóÆÈ¢ò
          printf '#!/bin/sh\nexit 0' > /usr/sbin/policy-rc.d
          
          apt-get update
          apt-get install -y curl wget git net-tools sudo debconf-utils vim zip unzip \
            software-properties-common lsb-release gnupg ca-certificates
          
          add-apt-repository -y ppa:mozillateam/ppa
          echo '
          Package: *
          Pin: release o=LP-PPA-mozillateam
          Pin-Priority: 1001
          ' | tee /etc/apt/preferences.d/mozilla-firefox

      # 2. ÂÆâË£ÖÂπ∂ÂêØÂä® Cloudflare WARP (‰øÆÂ§çËØ≠Ê≥ï‰∏éÂêØÂä®Êä•Èîô)
      - name: Install & Configure WARP
        run: |
          curl -fsSL https://pkg.cloudflareclient.com/pubkey.gpg | gpg --yes --dearmor --output /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] https://pkg.cloudflareclient.com/ $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/cloudflare-client.list
          
          apt-get update
          apt-get install -y cloudflare-warp
          
          # ÊâãÂä®ÂêØÂä®ÂÆàÊä§ËøõÁ®ã
          nohup warp-svc > /var/log/warp.log 2>&1 &
          echo "Waiting for warp-svc to warm up..."
          sleep 10
          
          # --- ËØ≠Ê≥ï‰øÆÂ§çÁÇπÔºö--accept-tos ÂøÖÈ°ªÊîæÂú®ÂâçÈù¢ ---
          warp-cli --accept-tos registration new
          
          # ËÆæÁΩÆÊ®°Âºè‰∏∫ Proxy (SOCKS5 40000)
          warp-cli --accept-tos mode proxy
          warp-cli --accept-tos proxy port 40000
          
          # Âª∫Á´ãËøûÊé•
          warp-cli --accept-tos connect
          
          echo "Waiting for WARP connection to establish..."
          sleep 10
          
          # È™åËØÅ
          echo "Testing WARP status..."
          warp-cli --accept-tos status
          curl -x socks5://127.0.0.1:40000 -s https://www.cloudflare.com/cdn-cgi/trace | grep "warp=" || true

      # 3. ÂÆâË£Ö Firefox & GUI
      - name: Install Firefox & GUI
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          apt-get install -y firefox fonts-liberation fonts-noto-color-emoji fontconfig ttf-mscorefonts-installer \
            xvfb fluxbox x11vnc python3 pulseaudio dbus-x11
          
          echo "ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true" | debconf-set-selections
          fc-cache -f -v
          
          git clone https://github.com/novnc/noVNC.git /opt/noVNC
          git clone https://github.com/novnc/websockify /opt/noVNC/utils/websockify
          ln -s /opt/noVNC/vnc.html /opt/noVNC/index.html
          chmod -R 777 /opt/noVNC

      # 4. ÈÖçÁΩÆÁî®Êà∑‰∏é Firefox Profile
      - name: Setup Firefox Profile
        run: |
          useradd -m -s /bin/bash appuser
          su appuser -c "mkdir -p /home/appuser/Downloads"
          su appuser -c "mkdir -p /home/appuser/.mozilla/firefox/stealth.default"
          
          su appuser -c "cat <<EOF > /home/appuser/.mozilla/firefox/profiles.ini
          [Profile0]
          Name=default
          IsRelative=1
          Path=stealth.default
          Default=1
          [General]
          StartWithLastProfile=1
          Version=2
          EOF"
          
          su appuser -c "cat <<EOF > /home/appuser/.mozilla/firefox/stealth.default/user.js
          user_pref(\"network.proxy.type\", 1);
          user_pref(\"network.proxy.socks\", \"127.0.0.1\");
          user_pref(\"network.proxy.socks_port\", 40000);
          user_pref(\"network.proxy.socks_version\", 5);
          user_pref(\"network.proxy.socks_remote_dns\", true);
          user_pref(\"dom.webdriver.enabled\", false);
          user_pref(\"use_automation_extension\", false);
          user_pref(\"general.useragent.override\", \"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:120.0) Gecko/20100101 Firefox/120.0\");
          user_pref(\"privacy.trackingprotection.enabled\", false);
          user_pref(\"network.cookie.cookieBehavior\", 0);
          user_pref(\"dom.disable_open_during_load\", false);
          user_pref(\"browser.download.folderList\", 2);
          user_pref(\"browser.download.dir\", \"/home/appuser/Downloads\");
          user_pref(\"browser.download.useDownloadDir\", true);
          user_pref(\"browser.download.manager.showWhenStarting\", false);
          EOF"

      # 5. ÂêØÂä®Ê°åÈù¢
      - name: Start Desktop
        run: |
          service dbus start || true
          cat <<EOF > /home/appuser/run_desktop.sh
          #!/bin/bash
          export DISPLAY=:99
          export HOME=/home/appuser
          Xvfb :99 -screen 0 1280x800x24 &
          sleep 2
          fluxbox &
          x11vnc -display :99 -forever -passwd secret -bg -noxdamage
          /opt/noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
          EOF
          chmod +x /home/appuser/run_desktop.sh
          su appuser -c "/home/appuser/run_desktop.sh"

      # 6. ÂêØÂä® Firefox & ÈößÈÅì
      - name: Launch Firefox
        run: |
          cat <<EOF > /home/appuser/run_firefox.sh
          #!/bin/bash
          export DISPLAY=:99
          export HOME=/home/appuser
          nohup firefox --no-remote --new-instance "https://decrypt.day/app/id1489932710" > /home/appuser/firefox.log 2>&1 &
          EOF
          chmod +x /home/appuser/run_firefox.sh
          su appuser -c "/home/appuser/run_firefox.sh"
          
          sleep 5
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          dpkg -i cloudflared.deb
          cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          sleep 10
          TUNNEL_URL=$(grep -oE "https://[a-zA-Z0-9-]+\.trycloudflare\.com" tunnel.log | head -1)
          echo "=========================================================="
          echo "üöÄ WARP Accelerated Environment Ready"
          echo "üîó VNC: $TUNNEL_URL/vnc.html?autoconnect=true&password=secret"
          echo "=========================================================="

      # 7. Êô∫ËÉΩÁõëÊéß‰∏ãËΩΩ (Ëá™Âä®ÈÄÄÂá∫)
      - name: Monitor Download
        run: |
          echo "Monitoring /home/appuser/Downloads for IPA..."
          while true; do
            FILE=$(find "/home/appuser/Downloads" -name "*.ipa" -print -quit)
            if [ -n "$FILE" ]; then
              if [ -f "${FILE}.part" ] || [ -f "${FILE}.partjs" ]; then
                 echo "‚è≥ Downloading..."
              else
                 echo "‚úÖ Found IPA. Checking integrity..."
                 if zip -T "$FILE" > /dev/null 2>&1; then
                   echo "üéâ Verified!"
                   echo "IPA_FINAL_PATH=$FILE" >> $GITHUB_ENV
                   break
                 else
                   echo "‚ùå Integrity failed, still waiting..."
                 fi
              fi
            fi
            sleep 5
          done

      # 8. ‰øùÂ≠ò‰∫ßÁâ©
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa-package
          path: ${{ env.IPA_FINAL_PATH }}
          retention-days: 1
