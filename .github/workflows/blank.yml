name: CF-Bypass Desktop (Final Fix)
on: 
  workflow_dispatch:

jobs:
  bypass-cf:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:22.04
      options: --privileged --shm-size=2gb
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. è¡¥å…¨æ‰€æœ‰ç¼ºå¤±çš„ç³»ç»Ÿç»„ä»¶
      - name: Install System Dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          apt-get update
          # å®‰è£…åŸºç¡€å·¥å…·ã€debconfã€fontconfig(æä¾›fc-cache)ã€ä»¥åŠChromeéœ€è¦çš„dbusç­‰
          apt-get install -y \
            debconf-utils \
            git \
            wget \
            curl \
            net-tools \
            python3 \
            python3-pip \
            sudo \
            software-properties-common \
            fontconfig \
            dbus-x11 \
            libnss3 \
            libasound2 \
            libgbm1 \
            ca-certificates

      # 2. å®‰è£…å­—ä½“ (ç‹¬ç«‹æ­¥éª¤)
      - name: Install Fonts (Anti-Detect)
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          # é¢„å…ˆåŒæ„å¾®è½¯å­—ä½“åè®®
          echo "ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true" | debconf-set-selections
          
          # å®‰è£…å­—ä½“åŒ…
          apt-get install -y ttf-mscorefonts-installer fonts-liberation fonts-noto-color-emoji || echo "Font install warning"
          
          # ç°åœ¨ fc-cache è‚¯å®šå­˜åœ¨äº†
          fc-cache -f -v

      # 3. å®‰è£… Chrome å’Œ GUI ç¯å¢ƒ
      - name: Install Chrome & GUI & DrissionPage
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          apt-get install -y xvfb fluxbox x11vnc
          
          # å®‰è£…å®˜æ–¹ Google Chrome
          wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          apt-get install -y ./google-chrome-stable_current_amd64.deb
          
          # å®‰è£… DrissionPage åŠå…¶ä¾èµ–
          pip3 install DrissionPage

      # 4. å®‰è£… noVNC
      - name: Install noVNC
        run: |
          git clone https://github.com/novnc/noVNC.git /opt/noVNC
          git clone https://github.com/novnc/websockify /opt/noVNC/utils/websockify
          ln -s /opt/noVNC/vnc.html /opt/noVNC/index.html

      - name: Start Virtual Desktop
        run: |
          # å¯åŠ¨ DBUS (æœ‰äº›ç‰ˆæœ¬çš„ Chrome éœ€è¦å®ƒæ¥ä¿å­˜è®¾ç½®)
          service dbus start || true
          
          Xvfb :99 -screen 0 1280x800x24 &
          export DISPLAY=:99
          fluxbox &
          x11vnc -display :99 -forever -passwd secret -bg -noxdamage
          /opt/noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
          sleep 3

      - name: Create Bypass Script
        run: |
          cat <<EOF > bypass.py
          from DrissionPage import ChromiumPage, ChromiumOptions
          import time
          
          co = ChromiumOptions()
          co.set_browser_path('/usr/bin/google-chrome') 
          co.set_argument('--no-sandbox')
          co.set_argument('--start-maximized')
          co.set_argument('--disable-gpu')
          co.set_user_data_path('/tmp/drission_profile')
          
          # æ¨¡æ‹Ÿæœ€æ–°ç‰ˆ Mac Chrome
          co.set_user_agent('Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36')

          try:
              page = ChromiumPage(addr_or_opts=co)
              # æ›¿æ¢æˆä½ çš„ç›®æ ‡ URL
              target_url = "https://nowsecure.nl" 
              print(f"--- Navigating to {target_url} ---")
              page.get(target_url)
              
              print("--- Ready. Please control via VNC. ---")
              while True:
                  time.sleep(10)
          except Exception as e:
              print(f"Error: {e}")
              while True:
                  time.sleep(10)
          EOF

      - name: Run DrissionPage & Tunnel
        run: |
          export DISPLAY=:99
          
          # å¯åŠ¨æµè§ˆå™¨è„šæœ¬
          python3 bypass.py > browser.log 2>&1 &
          
          # å¯åŠ¨éš§é“
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          dpkg -i cloudflared.deb
          cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          echo "Starting Tunnel..."
          sleep 10
          
          TUNNEL_URL=$(grep -oE "https://[a-zA-Z0-9-]+\.trycloudflare\.com" tunnel.log | head -1)
          
          echo "=========================================================="
          echo "ğŸ”— VNC åœ°å€: $TUNNEL_URL/vnc.html?autoconnect=true&password=secret"
          echo "=========================================================="
          
          tail -f browser.log
