name: Firefox Non-Root VNC
on: 
  workflow_dispatch:

jobs:
  firefox-user:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:22.04
      # å¿…é¡»å¼€å¯ privileged ä»¥æ”¯æŒ fuse (è™½ç„¶ä¸ç”¨ snapï¼Œä½†ä¸ºäº†åº•å±‚åº“ç¨³å®š)
      options: --privileged --shm-size=2gb
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. å®‰è£…åŸºç¡€ç¯å¢ƒ (root æ“ä½œ)
      - name: Install System & Firefox
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          apt-get update
          apt-get install -y software-properties-common wget curl git net-tools sudo debconf-utils vim
          
          # æ·»åŠ  Mozilla PPA
          add-apt-repository -y ppa:mozillateam/ppa
          
          # é˜»æ­¢ Snap ç‰ˆæœ¬
          echo '
          Package: *
          Pin: release o=LP-PPA-mozillateam
          Pin-Priority: 1001
          ' | tee /etc/apt/preferences.d/mozilla-firefox
          
          apt-get update
          # å®‰è£… Firefox, VNC, å­—ä½“, PulseAudio(è§£å†³å£°éŸ³æŠ¥é”™)
          apt-get install -y firefox fonts-liberation fonts-noto-color-emoji fontconfig ttf-mscorefonts-installer xvfb fluxbox x11vnc python3 pulseaudio dbus-x11
          
          # åŒæ„å­—ä½“åè®®
          echo "ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true" | debconf-set-selections
          fc-cache -f -v
          
          # å®‰è£… noVNC
          git clone https://github.com/novnc/noVNC.git /opt/noVNC
          git clone https://github.com/novnc/websockify /opt/noVNC/utils/websockify
          ln -s /opt/noVNC/vnc.html /opt/noVNC/index.html
          
          # èµ‹äºˆ noVNC ç›®å½•æƒé™ï¼Œä»¥ä¾¿æ™®é€šç”¨æˆ·è®¿é—®
          chmod -R 777 /opt/noVNC

      # 2. åˆ›å»ºæ™®é€šç”¨æˆ·å¹¶é…ç½® Firefox (å…³é”®ä¿®å¤æ­¥éª¤)
      - name: Setup User & Firefox Profile
        run: |
          # åˆ›å»ºä¸€ä¸ªå« appuser çš„ç”¨æˆ·ï¼Œä¸»ç›®å½•åœ¨ /home/appuser
          useradd -m -s /bin/bash appuser
          
          # èµ‹äºˆ sudo æƒé™ (å¯é€‰ï¼Œè°ƒè¯•ç”¨)
          usermod -aG sudo appuser
          echo "appuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers
          
          # ä»¥ appuser èº«ä»½åˆ›å»ºé…ç½®ç›®å½•
          # ä½¿ç”¨ su -c ç¡®ä¿æ–‡ä»¶å½’å±æ­£ç¡®
          su appuser -c "mkdir -p /home/appuser/.mozilla/firefox/stealth.default"
          
          # å†™å…¥ profiles.ini
          su appuser -c "cat <<EOF > /home/appuser/.mozilla/firefox/profiles.ini
          [Profile0]
          Name=default
          IsRelative=1
          Path=stealth.default
          Default=1
          
          [General]
          StartWithLastProfile=1
          Version=2
          EOF"
          
          # å†™å…¥ user.js (åçˆ¬é…ç½®)
          su appuser -c "cat <<EOF > /home/appuser/.mozilla/firefox/stealth.default/user.js
          user_pref(\"dom.webdriver.enabled\", false);
          user_pref(\"use_automation_extension\", false);
          user_pref(\"general.useragent.override\", \"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:120.0) Gecko/20100101 Firefox/120.0\");
          user_pref(\"media.peerconnection.enabled\", false);
          user_pref(\"privacy.resistFingerprinting\", false);
          user_pref(\"gfx.webrender.all\", false);
          EOF"

      # 3. å¯åŠ¨ VNC å’Œ æ¡Œé¢ç¯å¢ƒ (ä»¥ appuser èº«ä»½)
      - name: Start Desktop (As User)
        run: |
          # å¯åŠ¨ç³»ç»Ÿçº§ DBus (rootè¿è¡Œ)
          service dbus start || true
          
          # åˆ›å»ºå¯åŠ¨è„šæœ¬ run_desktop.sh
          cat <<EOF > /home/appuser/run_desktop.sh
          #!/bin/bash
          export DISPLAY=:99
          export HOME=/home/appuser
          
          # å¯åŠ¨ Xvfb
          Xvfb :99 -screen 0 1280x800x24 &
          sleep 2
          
          # å¯åŠ¨ Fluxbox
          fluxbox &
          
          # å¯åŠ¨ VNC Server
          x11vnc -display :99 -forever -passwd secret -bg -noxdamage
          
          # å¯åŠ¨ noVNC
          /opt/noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
          EOF
          
          # èµ‹äºˆè„šæœ¬æ‰§è¡Œæƒé™
          chmod +x /home/appuser/run_desktop.sh
          
          # ä»¥ appuser èº«ä»½è¿è¡Œæ¡Œé¢
          su appuser -c "/home/appuser/run_desktop.sh"
          
          echo "Desktop started as appuser."
          sleep 3

      # 4. å¯åŠ¨ Firefox (ä»¥ appuser èº«ä»½)
      - name: Launch Firefox & Tunnel
        run: |
          # åˆ›å»ºæµè§ˆå™¨å¯åŠ¨è„šæœ¬
          cat <<EOF > /home/appuser/run_firefox.sh
          #!/bin/bash
          export DISPLAY=:99
          export HOME=/home/appuser
          
          # å¯åŠ¨ Firefox
          nohup firefox --no-remote --new-instance "https://nowsecure.nl" > /home/appuser/firefox.log 2>&1 &
          EOF
          
          chmod +x /home/appuser/run_firefox.sh
          
          # ä»¥ appuser èº«ä»½è¿è¡Œ
          su appuser -c "/home/appuser/run_firefox.sh"
          
          echo "Firefox launching..."
          sleep 5
          
          # å¯åŠ¨ Tunnel (Tunnel å¯ä»¥ç”¨ root è·‘ï¼Œåªè¦å®ƒèƒ½è®¿é—® localhost:6080)
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          dpkg -i cloudflared.deb
          cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          echo "Waiting for Tunnel..."
          sleep 10
          
          TUNNEL_URL=$(grep -oE "https://[a-zA-Z0-9-]+\.trycloudflare\.com" tunnel.log | head -1)
          
          echo "=========================================================="
          echo "ğŸ¦Š Firefox (User Mode) å·²å¯åŠ¨"
          echo "ğŸ”— VNC é“¾æ¥: $TUNNEL_URL/vnc.html?autoconnect=true&password=secret"
          echo "=========================================================="
          
          # ç›‘æ§æ—¥å¿—
          tail -f /home/appuser/firefox.log
