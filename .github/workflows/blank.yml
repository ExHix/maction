name: Playwright Remote Debugging
on: 
  workflow_dispatch: # ä»…æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  debug-session:
    runs-on: ubuntu-latest
    # ä½¿ç”¨å®˜æ–¹ Playwright Docker é•œåƒ
    container:
      image: mcr.microsoft.com/playwright:v1.40.0-jammy
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Utilities
        run: apt-get update && apt-get install -y curl

      # 1. è·å–å…¬ç½‘ IP (Localtunnel å®‰å…¨éªŒè¯éœ€è¦ç”¨åˆ°)
      - name: Get Public IP
        id: public_ip
        run: |
          IP=$(curl -s https://api.ipify.org)
          echo "Runer Public IP: $IP"
          echo "ip=$IP" >> $GITHUB_OUTPUT

      # 2. å¯åŠ¨ Playwright Server (åå°è¿è¡Œ)
      - name: Start Playwright Server
        run: |
          # å¯åŠ¨ Playwright Server ç›‘å¬ 9222 ç«¯å£
          # --host 0.0.0.0 å…è®¸å¤–éƒ¨å®¹å™¨è®¿é—®
          nohup npx playwright launch-server --port 9222 --host 0.0.0.0 &
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          sleep 3
          echo "Playwright Server started on port 9222"

      # 3. å¼€å¯å†…ç½‘ç©¿é€å¹¶æ‰“å°è¿æ¥å‘½ä»¤
      - name: Start Tunnel & Print Connection Command
        env:
          RUNNER_IP: ${{ steps.public_ip.outputs.ip }}
        run: |
          # å®‰è£… localtunnel
          npm install -g localtunnel

          # å¯åŠ¨ tunnel (åå°è¿è¡Œ) å¹¶å°†æ—¥å¿—è¾“å‡ºåˆ°æ–‡ä»¶ä»¥ä¾¿æå– URL
          lt --port 9222 > tunnel.log 2>&1 &
          
          echo "Waiting for tunnel URL..."
          sleep 5
          
          # æå– URL
          TUNNEL_URL=$(grep -oE "https://[a-zA-Z0-9-]+\.loca\.lt" tunnel.log | head -1)
          
          # å°† https æ›¿æ¢ä¸º wss (Playwright è¿æ¥é€šå¸¸ä½¿ç”¨ ws/wss)
          WS_ENDPOINT="${TUNNEL_URL/https/wss}/ws"

          echo "=========================================================="
          echo "ğŸ‰ è¿œç¨‹è°ƒè¯•ç¯å¢ƒå·²å°±ç»ªï¼"
          echo ""
          echo "âš ï¸  æ³¨æ„: ç”±äº Localtunnel çš„å®‰å…¨æœºåˆ¶ï¼Œä½ é¦–æ¬¡è®¿é—®å¯èƒ½éœ€è¦éªŒè¯ IPã€‚"
          echo "ğŸ‘‰  GitHub Runner å…¬ç½‘ IP: $RUNNER_IP"
          echo "ğŸ‘‰  éªŒè¯é¡µé¢ (æµè§ˆå™¨æ‰“å¼€): $TUNNEL_URL"
          echo ""
          echo "ğŸ’»  åœ¨æœ¬åœ°ç»ˆç«¯è¿è¡Œä»¥ä¸‹å‘½ä»¤è¿æ¥è°ƒè¯•:"
          echo "----------------------------------------------------------"
          echo "npx playwright connect --ws-endpoint=\"$WS_ENDPOINT\""
          echo "----------------------------------------------------------"
          echo "=========================================================="

      # 4. ä¿æŒè¿è¡Œ 10 åˆ†é’Ÿ
      - name: Keep Alive for 10 Minutes
        run: |
          echo "Session will close in 10 minutes..."
          sleep 600
