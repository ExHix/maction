name: Playwright Remote Debugging
on: 
  workflow_dispatch:

jobs:
  debug-session:
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.40.0-jammy
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Utilities
        run: apt-get update && apt-get install -y curl

      - name: Get Public IP
        id: public_ip
        run: |
          IP=$(curl -s https://api.ipify.org)
          echo "Runer Public IP: $IP"
          echo "ip=$IP" >> $GITHUB_OUTPUT

      - name: Start Playwright Server
        run: |
          # å¯åŠ¨ Playwright Server ç›‘å¬ 9222 ç«¯å£
          nohup npx playwright launch-server --port 9222 --host 0.0.0.0 &
          sleep 3
          echo "Playwright Server started on port 9222"

      - name: Start Tunnel & Print Connection Command
        env:
          RUNNER_IP: ${{ steps.public_ip.outputs.ip }}
        run: |
          npm install -g localtunnel

          # å¯åŠ¨ tunnel å¹¶è¾“å‡ºæ—¥å¿—åˆ°æ–‡ä»¶
          lt --port 9222 > tunnel.log 2>&1 &
          
          echo "Waiting for tunnel URL..."
          sleep 5
          
          # æå– URL
          TUNNEL_URL=$(grep -oE "https://[a-zA-Z0-9-]+\.loca\.lt" tunnel.log | head -1)
          
          if [ -z "$TUNNEL_URL" ]; then
            echo "Error: Failed to get tunnel URL. Printing log:"
            cat tunnel.log
            exit 1
          fi

          # --- ä¿®å¤ç‚¹åœ¨è¿™é‡Œ ---
          # ä½¿ç”¨ sed æ›¿æ¢ https ä¸º wssï¼Œå…¼å®¹ sh/dash shell
          WS_BASE=$(echo "$TUNNEL_URL" | sed 's/https/wss/')
          WS_ENDPOINT="${WS_BASE}/ws"
          # ------------------

          echo "=========================================================="
          echo "ğŸ‰ è¿œç¨‹è°ƒè¯•ç¯å¢ƒå·²å°±ç»ªï¼"
          echo ""
          echo "âš ï¸  æ³¨æ„: å¿…é¡»å…ˆåœ¨æµè§ˆå™¨æ‰“å¼€ä¸‹æ–¹é“¾æ¥å¹¶è¾“å…¥ IP è¿›è¡ŒéªŒè¯ï¼"
          echo "ğŸ‘‰  GitHub Runner å…¬ç½‘ IP: $RUNNER_IP"
          echo "ğŸ‘‰  éªŒè¯é¡µé¢ (æµè§ˆå™¨æ‰“å¼€): $TUNNEL_URL"
          echo ""
          echo "ğŸ’»  æœ¬åœ°è¿æ¥å‘½ä»¤:"
          echo "----------------------------------------------------------"
          echo "npx playwright connect --ws-endpoint=\"$WS_ENDPOINT\""
          echo "----------------------------------------------------------"
          echo "=========================================================="

      - name: Keep Alive for 10 Minutes
        run: |
          echo "Session will close in 10 minutes..."
          sleep 600
