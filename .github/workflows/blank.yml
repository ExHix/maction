name: Playwright Web VNC (Browser Remote Control)
on: 
  workflow_dispatch:

jobs:
  browser-gui:
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.40.0-jammy
      options: --shm-size=2gb
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install GUI & VNC Tools
        env:
          DEBIAN_FRONTEND: noninteractive # ä¿®å¤ tzdata å¡ä½çš„é—®é¢˜
        run: |
          apt-get update
          # å®‰è£… X11, çª—å£ç®¡ç†å™¨, VNC server
          apt-get install -y --no-install-recommends xvfb fluxbox x11vnc python3 python3-pip git net-tools curl ca-certificates
          
          # ä¸‹è½½ noVNC
          git clone https://github.com/novnc/noVNC.git /opt/noVNC
          git clone https://github.com/novnc/websockify /opt/noVNC/utils/websockify
          ln -s /opt/noVNC/vnc.html /opt/noVNC/index.html

      - name: Get Public IP
        id: public_ip
        run: |
          IP=$(curl -s https://api.ipify.org)
          echo "Runner Public IP: $IP"
          echo "ip=$IP" >> $GITHUB_OUTPUT

      - name: Start Desktop Environment
        run: |
          # 1. å¯åŠ¨è™šæ‹Ÿå±å¹• :99
          Xvfb :99 -screen 0 1280x720x24 &
          export DISPLAY=:99
          
          # 2. å¯åŠ¨çª—å£ç®¡ç†å™¨
          fluxbox &
          
          # 3. å¯åŠ¨ VNC Server (å¯†ç è®¾ä¸º secret)
          x11vnc -display :99 -forever -passwd secret -bg
          
          # 4. å¯åŠ¨ noVNC (6080 è½¬ 5900)
          /opt/noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
          
          echo "Desktop environment started."

      - name: Launch Browser
        run: |
          export DISPLAY=:99
          # å¯åŠ¨ Playwright Codegen (å¸¦ç•Œé¢çš„æµè§ˆå™¨)
          nohup npx playwright codegen wikipedia.org &
          
      - name: Start Tunnel & Show Link
        env:
          RUNNER_IP: ${{ steps.public_ip.outputs.ip }}
        run: |
          npm install -g localtunnel

          # å¯åŠ¨ç©¿é€
          lt --port 6080 > tunnel.log 2>&1 &
          
          echo "Waiting for tunnel URL..."
          sleep 5
          
          # æå– URL
          TUNNEL_URL=$(grep -oE "https://[a-zA-Z0-9-]+\.loca\.lt" tunnel.log | head -1)
          
          if [ -z "$TUNNEL_URL" ]; then
            echo "Error: Failed to get tunnel URL."
            cat tunnel.log
            exit 1
          fi

          # æž„å»ºç›´è¾¾é“¾æŽ¥
          VNC_URL="$TUNNEL_URL/vnc.html?autoconnect=true&password=secret"

          echo "=========================================================="
          echo "ðŸ–¥ï¸  æµè§ˆå™¨è¿œç¨‹æ¡Œé¢å·²å°±ç»ªï¼"
          echo ""
          echo "1ï¸âƒ£  ã€å¿…é¡»ã€‘éªŒè¯ IP: ç‚¹å‡»é“¾æŽ¥è¾“å…¥ä¸‹æ–¹ IP"
          echo "ðŸ‘‰  GitHub Runner IP: $RUNNER_IP"
          echo ""
          echo "2ï¸âƒ£  è®¿é—®åœ°å€: $VNC_URL"
          echo "    (å¦‚æžœç‚¹å‡»åŽç™½å±ï¼Œè¯·ç‚¹å‡»å·¦ä¾§ä¾§è¾¹æ  -> Settings -> Scaling Mode -> Local Scaling)"
          echo "=========================================================="

      - name: Keep Alive (20 min)
        run: sleep 1200
