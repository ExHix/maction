name: QEMU Brute Force Emulation

on:
  workflow_dispatch:

jobs:
  qemu-force:
    runs-on: macos-15

    steps:
      - name: Install UTM
        run: brew install --cask utm

      - name: Locate QEMU and Force Run
        run: |
          # 1. 动态寻找 QEMU 路径 (UTM 内部路径可能随版本变化)
          QEMU_PATH=$(find /Applications/UTM.app -name "qemu-system-aarch64" -type f | head -n 1)
          
          if [ -z "$QEMU_PATH" ]; then
            echo "❌ 未找到 QEMU 引擎，尝试使用系统自带 QEMU"
            brew install qemu
            QEMU_PATH=$(which qemu-system-aarch64)
          fi
          
          echo "✅ 使用 QEMU 路径: $QEMU_PATH"

          # 2. 尝试启动模拟
          # 我们使用 -accel tcg (软件模拟) 而不是 hvf (硬件加速)
          # 注意：这里我们不加载 13GB 的 macOS，因为磁盘会爆炸。
          # 我们让 QEMU 启动并打印其支持的模拟硬件列表，证明它具备“强行模拟”的能力。
          $QEMU_PATH \
            -machine virt \
            -cpu max \
            -accel tcg \
            -display none \
            -monitor stdio << 'EOF'
          info status
          info version
          quit
          EOF

      - name: Why macOS Guest Fails
        run: |
          echo "=================================================="
          echo "💡 为什么无法直接在这里‘拉取并安装’ macOS？"
          echo "1. 空间限制：macOS 镜像 (13GB) + 解压 (30GB) > Runner 空间 (14GB)。"
          echo "2. 交互限制：macOS 安装需要鼠标点击，UTM 命令行无法自动化点击‘同意条款’。"
          echo "3. 速度限制：TCG 模式下，macOS 开机需要约 4-8 小时。"
          echo "=================================================="
