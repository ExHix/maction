name: CF-Bypass Desktop (Fix Install)
on: 
  workflow_dispatch:

jobs:
  bypass-cf:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:22.04
      # å¿…é¡»å¼€å¯ privileged æƒé™
      options: --privileged --shm-size=2gb
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. å…ˆå®‰è£…åŸºç¡€å·¥å…· (ç¡®ä¿ git, python, debconf è‚¯å®šèƒ½è£…ä¸Š)
      - name: Install Basic Tools
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          apt-get update
          # å…³é”®ï¼šå…ˆå®‰è£… debconf-utils æ‰èƒ½æ‰§è¡Œåé¢çš„åè®®åŒæ„å‘½ä»¤
          apt-get install -y debconf-utils git wget curl net-tools python3 python3-pip sudo software-properties-common

      # 2. å®‰è£…å­—ä½“ (ç‹¬ç«‹æ­¥éª¤ï¼Œé˜²æ­¢å¡ä½å…¶ä»–åŒ…)
      - name: Install Fonts (Anti-Detect)
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          # é¢„å…ˆåŒæ„å¾®è½¯å­—ä½“åè®®
          echo "ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true" | debconf-set-selections
          
          # å®‰è£…å­—ä½“ (å¦‚æœå¤±è´¥ä¸é˜»æ–­æµç¨‹ï¼ŒåŠ ä¸Š || true)
          apt-get install -y ttf-mscorefonts-installer fonts-liberation || echo "Fonts warning (ignored)"
          
          # åˆ·æ–°ç¼“å­˜
          fc-cache -f -v

      # 3. å®‰è£… Chrome å’Œ GUI ç¯å¢ƒ
      - name: Install Chrome & GUI
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          apt-get install -y xvfb fluxbox x11vnc
          
          # ä¸‹è½½å¹¶å®‰è£… Chrome
          wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          apt-get install -y ./google-chrome-stable_current_amd64.deb
          
          # å®‰è£… DrissionPage
          pip3 install DrissionPage

      # 4. å®‰è£… noVNC (ç°åœ¨ git è‚¯å®šå¥½äº†)
      - name: Install noVNC
        run: |
          git clone https://github.com/novnc/noVNC.git /opt/noVNC
          git clone https://github.com/novnc/websockify /opt/noVNC/utils/websockify
          ln -s /opt/noVNC/vnc.html /opt/noVNC/index.html

      - name: Start Virtual Desktop
        run: |
          Xvfb :99 -screen 0 1280x800x24 &
          export DISPLAY=:99
          fluxbox &
          x11vnc -display :99 -forever -passwd secret -bg -noxdamage
          /opt/noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
          sleep 3

      - name: Create Bypass Script
        run: |
          cat <<EOF > bypass.py
          from DrissionPage import ChromiumPage, ChromiumOptions
          import time
          import os
          
          print("--- Initializing DrissionPage ---")
          
          co = ChromiumOptions()
          # å…³é”®å‚æ•°ï¼šæŒ‡å‘åˆšå®‰è£…çš„å®˜æ–¹ Chrome
          co.set_browser_path('/usr/bin/google-chrome') 
          co.set_argument('--no-sandbox')
          co.set_argument('--start-maximized')
          co.set_argument('--disable-gpu')
          co.set_user_data_path('/tmp/drission_profile')
          
          # ä¼ªè£… Mac UA
          co.set_user_agent('Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36')

          try:
              page = ChromiumPage(addr_or_opts=co)
              
              target_url = "https://nowsecure.nl" 
              print(f"--- Navigating to {target_url} ---")
              page.get(target_url)
              
              print("--- Page Loaded. Waiting for user interaction via VNC ---")
              
              # è¿™é‡Œä¸å†™å¤æ‚çš„è‡ªåŠ¨ç‚¹å‡»ï¼Œé¿å…æŠ¥é”™é€€å‡ºï¼Œç›´æ¥ç”±ä½ åœ¨ VNC æ“ä½œ
              while True:
                  time.sleep(10)
                  
          except Exception as e:
              print(f"Error: {e}")
              # å³ä½¿æŠ¥é”™ä¹Ÿä¸é€€å‡ºï¼Œä¿æŒ VNC æ´»ç€æ–¹ä¾¿æŸ¥çœ‹
              while True:
                  time.sleep(10)
          EOF

      - name: Run DrissionPage & Tunnel
        run: |
          export DISPLAY=:99
          
          # å¯åŠ¨ Python è„šæœ¬
          python3 bypass.py > browser.log 2>&1 &
          
          # å¯åŠ¨ Cloudflare Tunnel
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          dpkg -i cloudflared.deb
          cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          echo "Starting Tunnel..."
          sleep 10
          
          TUNNEL_URL=$(grep -oE "https://[a-zA-Z0-9-]+\.trycloudflare\.com" tunnel.log | head -1)
          
          if [ -z "$TUNNEL_URL" ]; then
             echo "Tunnel URL not found. Logs:"
             cat tunnel.log
          fi

          echo "=========================================================="
          echo "ğŸ›¡ï¸ DrissionPage æµè§ˆå™¨ç¯å¢ƒå·²ä¿®å¤"
          echo "ğŸ”— VNC åœ°å€: $TUNNEL_URL/vnc.html?autoconnect=true&password=secret"
          echo "=========================================================="
          
          # ç›‘æ§æ—¥å¿—
          tail -f browser.log
