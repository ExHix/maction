name: Windows RDP Crawler (Native)
on: 
  workflow_dispatch:

jobs:
  win-rdp:
    runs-on: windows-latest # ä½¿ç”¨åŸç”Ÿ Windows Server 2022
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1. è®¾ç½®ç”¨æˆ·å¯†ç  (RDP ç™»å½•éœ€è¦)
      - name: Set User Password
        id: reset-pass
        shell: powershell
        run: |
          $password = "SecretPass123!" # <--- ä½ çš„ RDP å¯†ç 
          net user runneradmin $password
          echo "Password set successfully."

      # 2. å®‰è£… Playwright å’Œ Python
      - name: Install Python & Playwright
        shell: powershell
        run: |
          pip install playwright
          playwright install chromium
          # ä¹Ÿæ˜¯ä¸ºäº†é˜²æ­¢æ‰¾ä¸åˆ°æµè§ˆå™¨ï¼Œå®‰è£…ä¸€ä¸‹
          python -m playwright install chromium

      # 3. åˆ›å»ºå¯åŠ¨è„šæœ¬ (è‡ªåŠ¨æ‰“å¼€ Chrome)
      - name: Create Python Script
        shell: powershell
        run: |
          $scriptContent = @"
          import time
          from playwright.sync_api import sync_playwright

          print('--- Starting Windows Chrome ---')
          with sync_playwright() as p:
              # Windows ä¸Šä¸éœ€è¦ sandbox å‚æ•°ï¼Œç¯å¢ƒæ›´çœŸå®
              browser = p.chromium.launch(
                  headless=False,
                  channel="chrome", # å°è¯•è°ƒç”¨ç³»ç»Ÿ Chrome (å¦‚æœæœ‰) æˆ– bundled chromium
                  args=["--start-maximized"]
              )
              context = browser.new_context(viewport=None)
              page = context.new_page()
              
              print('--- Navigating... ---')
              try:
                  page.goto("https://www.google.com")
              except:
                  pass
              
              print('--- Browser Ready. Connect via RDP to control. ---')
              
              # æ­»å¾ªç¯ä¿æŒè¿è¡Œ
              while True:
                  time.sleep(10)
          "@
          Set-Content -Path run_win.py -Value $scriptContent

      # 4. å¼€å¯ RDP è®¿é—®æƒé™
      - name: Enable RDP Access
        shell: powershell
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -value 1

      # 5. å¯åŠ¨ Ngrok TCP éš§é“ (æš´éœ² 3389 ç«¯å£)
      - name: Start Ngrok Tunnel
        shell: powershell
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          if ($env:NGROK_AUTH_TOKEN -eq "") {
            Write-Error "è¯·å…ˆåœ¨ GitHub Secrets ä¸­é…ç½® NGROK_AUTH_TOKEN"
            exit 1
          }
          
          # ä¸‹è½½ Ngrok
          Invoke-WebRequest -Uri https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip
          Expand-Archive ngrok.zip -DestinationPath .
          
          # é…ç½® Token
          .\ngrok.exe config add-authtoken $env:NGROK_AUTH_TOKEN
          
          # åå°å¯åŠ¨ TCP éš§é“
          Start-Process -FilePath ".\ngrok.exe" -ArgumentList "tcp 3389" -PassThru
          
          # ç­‰å¾…å¯åŠ¨
          Start-Sleep -Seconds 5
          
          # è·å–å…¬ç½‘åœ°å€
          $tunnels = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels"
          $url = $tunnels.tunnels[0].public_url
          
          # å»æ‰ tcp:// å‰ç¼€
          $cleanUrl = $url -replace "tcp://", ""
          
          Write-Host "======================================================"
          Write-Host "ğŸ–¥ï¸ Windows è¿œç¨‹æ¡Œé¢ (RDP) å·²å°±ç»ª"
          Write-Host ""
          Write-Host "ğŸ‘‰ è¿æ¥åœ°å€: $cleanUrl"
          Write-Host "ğŸ‘‰ ç”¨æˆ·å: runneradmin"
          Write-Host "ğŸ‘‰ å¯†ç : SecretPass123!"
          Write-Host ""
          Write-Host "ğŸ’¡ ä½¿ç”¨æ–¹æ³•: ç”µè„‘/æ‰‹æœºæ‰“å¼€ 'è¿œç¨‹æ¡Œé¢' å®¢æˆ·ç«¯ï¼Œè¾“å…¥åœ°å€è¿æ¥ã€‚"
          Write-Host "======================================================"

      # 6. è¿è¡Œæµè§ˆå™¨è„šæœ¬ (ä¿æŒ Session æ´»è·ƒ)
      - name: Run Browser & Keep Alive
        shell: powershell
        run: |
          python run_win.py
