name: Firefox Allowed-Ads VNC
on: 
  workflow_dispatch:

jobs:
  firefox-user:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:22.04
      options: --privileged --shm-size=2gb
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. å®‰è£…åŸºç¡€ç¯å¢ƒ
      - name: Install System & Firefox
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          apt-get update
          apt-get install -y software-properties-common wget curl git net-tools sudo debconf-utils vim unzip procps
          
          add-apt-repository -y ppa:mozillateam/ppa
          
          echo '
          Package: *
          Pin: release o=LP-PPA-mozillateam
          Pin-Priority: 1001
          ' | tee /etc/apt/preferences.d/mozilla-firefox
          
          apt-get update
          apt-get install -y firefox fonts-liberation fonts-noto-color-emoji fontconfig ttf-mscorefonts-installer xvfb fluxbox x11vnc python3 pulseaudio dbus-x11
          
          echo "ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true" | debconf-set-selections
          fc-cache -f -v
          
          git clone https://github.com/novnc/noVNC.git /opt/noVNC
          git clone https://github.com/novnc/websockify /opt/noVNC/utils/websockify
          ln -s /opt/noVNC/vnc.html /opt/noVNC/index.html
          chmod -R 777 /opt/noVNC

      # 2. åˆ›å»ºç”¨æˆ· & é…ç½®â€œå…è®¸å¹¿å‘Šâ€çš„ Profile
      - name: Setup User & Firefox Profile
        run: |
          useradd -m -s /bin/bash appuser
          
          su appuser -c "mkdir -p /home/appuser/.mozilla/firefox/stealth.default"
          
          su appuser -c "cat <<EOF > /home/appuser/.mozilla/firefox/profiles.ini
          [Profile0]
          Name=default
          IsRelative=1
          Path=stealth.default
          Default=1
          
          [General]
          StartWithLastProfile=1
          Version=2
          EOF"
          
          # æ ¸å¿ƒä¿®æ”¹ï¼šå†™å…¥å…è®¸å¹¿å‘Šå’Œè¿½è¸ªçš„ user.js
          su appuser -c "cat <<EOF > /home/appuser/.mozilla/firefox/stealth.default/user.js
          user_pref(\"dom.webdriver.enabled\", false);
          user_pref(\"use_automation_extension\", false);
          user_pref(\"general.useragent.override\", \"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:120.0) Gecko/20100101 Firefox/120.0\");
          user_pref(\"privacy.trackingprotection.enabled\", false);
          user_pref(\"privacy.trackingprotection.pbmode.enabled\", false);
          user_pref(\"privacy.trackingprotection.socialtracking.enabled\", false);
          user_pref(\"privacy.trackingprotection.cryptomining.enabled\", false);
          user_pref(\"privacy.trackingprotection.fingerprinting.enabled\", false);
          user_pref(\"network.cookie.cookieBehavior\", 0);
          user_pref(\"network.cookie.thirdparty.sessionOnly\", false);
          user_pref(\"dom.popup_allowed_events\", \"change click dblclick mouseup notificationclick reset submit touchend\"); 
          user_pref(\"dom.disable_open_during_load\", false);
          user_pref(\"media.peerconnection.enabled\", false);
          EOF"

      # 3. å¯åŠ¨æ¡Œé¢
      - name: Start Desktop (As User)
        run: |
          service dbus start || true
          
          cat <<EOF > /home/appuser/run_desktop.sh
          #!/bin/bash
          export DISPLAY=:99
          export HOME=/home/appuser
          Xvfb :99 -screen 0 1280x800x24 &
          sleep 2
          fluxbox &
          x11vnc -display :99 -forever -passwd secret -bg -noxdamage
          /opt/noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
          EOF
          
          chmod +x /home/appuser/run_desktop.sh
          su appuser -c "/home/appuser/run_desktop.sh"
          sleep 3

      # 4. (æ–°) å¯åŠ¨åå°ç›‘æ§è„šæœ¬
      # è¯¥æ­¥éª¤ä¼šå¯åŠ¨ä¸€ä¸ªåå°è¿›ç¨‹ï¼Œç›‘æ§ Downloads ç›®å½•ã€‚
      # ä¸€æ—¦å‘ç°æœ‰æ•ˆçš„ IPA æ–‡ä»¶ï¼Œå®ƒä¼šæ€æ­»ä¸‹ä¸€æ­¥éª¤ä¸­çš„ tail è¿›ç¨‹ï¼Œä»è€Œå…è®¸ Workflow ç»§ç»­ã€‚
      - name: Start Background Monitor
        run: |
          # å°†å½“å‰ GITHUB_ENV çš„è·¯å¾„ä¿å­˜ï¼Œä»¥ä¾¿è„šæœ¬å†™å…¥ç¯å¢ƒå˜é‡
          ENV_FILE="$GITHUB_ENV"
          
          cat <<EOF > /home/appuser/monitor_download.sh
          #!/bin/bash
          TARGET_DIR="/home/appuser/Downloads"
          MAX_SIZE_MB=100
          
          echo "Starting background monitoring for *.ipa in \$TARGET_DIR..."
          
          while true; do
            # æŸ¥æ‰¾ ipa æ–‡ä»¶
            FILE=\$(find "\$TARGET_DIR" -name "*.ipa" -print -quit)
            
            if [ -n "\$FILE" ]; then
              BASENAME=\$(basename "\$FILE")
              
              # 1. æ£€æŸ¥æ˜¯å¦è¿˜åœ¨ä¸‹è½½
              if [ -f "\${FILE}.part" ] || [ -f "\${FILE}.partjs" ]; then
                 echo "â³ File \$BASENAME is still downloading..."
              else
                 # 2. æ£€æŸ¥å¤§å°
                 SIZE_MB=\$(du -m "\$FILE" | cut -f1)
                 
                 if [ "\$SIZE_MB" -ge "\$MAX_SIZE_MB" ]; then
                   echo "âš ï¸ Found \$BASENAME but size (\$SIZE_MB MB) is too large. Waiting..."
                 else
                   echo "âœ… Found candidate: \$BASENAME (\$SIZE_MB MB)"
                   
                   # 3. æ£€æŸ¥å®Œæ•´æ€§
                   if zip -T "\$FILE" > /dev/null 2>&1; then
                     echo "ğŸ‰ Integrity Check PASSED! Killing Firefox wait loop..."
                     
                     # å†™å…¥ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨ï¼ˆå¦‚æœéœ€è¦ï¼‰
                     echo "FILE_PATH=\$FILE" >> "$ENV_FILE"
                     
                     # --- æ ¸å¿ƒé€»è¾‘ï¼šæ€æ­»ä¿æŒ Firefox æ­¥éª¤è¿è¡Œçš„ tail è¿›ç¨‹ ---
                     # æŸ¥æ‰¾è¿è¡Œ 'tail -f ... firefox.log' çš„è¿›ç¨‹å¹¶ç»“æŸå®ƒ
                     pkill -f "tail -f /home/appuser/firefox.log"
                     
                     exit 0
                   else
                     echo "âŒ Integrity Check FAILED. Waiting..."
                   fi
                 fi
              fi
            fi
            sleep 3
          done
          EOF
          
          chmod +x /home/appuser/monitor_download.sh
          # åœ¨åå°è¿è¡Œç›‘æ§è„šæœ¬ï¼Œå¹¶å°†æ—¥å¿—è¾“å‡ºåˆ° monitor.log
          nohup /home/appuser/monitor_download.sh > /home/appuser/monitor.log 2>&1 &
          
          echo "Background monitor started."

      # 5. (æ–°) å¯åŠ¨ Firefox å¹¶ä¿æŒä¼šè¯
      # è¿™é‡Œä¼šä¸€ç›´è¿è¡Œï¼Œç›´åˆ°è¢«ä¸Šä¸€æ­¥çš„åå°è„šæœ¬â€œæ€æ‰â€
      - name: Launch Firefox & Tunnel
        run: |
          cat <<EOF > /home/appuser/run_firefox.sh
          #!/bin/bash
          export DISPLAY=:99
          export HOME=/home/appuser
          # æ›¿æ¢æˆä½ çš„ç›®æ ‡ç½‘å€
          nohup firefox --no-remote --new-instance "https://decrypt.day/app/id1489932710" > /home/appuser/firefox.log 2>&1 &
          EOF
          
          chmod +x /home/appuser/run_firefox.sh
          su appuser -c "/home/appuser/run_firefox.sh"
          
          echo "Firefox launching..."
          sleep 5
          
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          dpkg -i cloudflared.deb
          cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          echo "Waiting for Tunnel..."
          sleep 10
          
          TUNNEL_URL=$(grep -oE "https://[a-zA-Z0-9-]+\.trycloudflare\.com" tunnel.log | head -1)
          
          echo "=========================================================="
          echo "ğŸ¦Š Firefox (Ad-Friendly Mode) å·²å¯åŠ¨"
          echo "ğŸ”— VNC é“¾æ¥: $TUNNEL_URL/vnc.html?autoconnect=true&password=secret"
          echo "â³ ç­‰å¾…ç”¨æˆ·ä¸‹è½½å®Œæˆ (åå°ç›‘æ§è„šæœ¬è¿è¡Œä¸­)..."
          echo "=========================================================="
          
          # é˜»å¡åœ¨æ­¤å¤„ï¼Œç›´åˆ°åå°ç›‘æ§è„šæœ¬æ‰§è¡Œ pkill å‘½ä»¤
          # æ·»åŠ  || true ç¡®ä¿è¢« kill åä¸æŠ¥é”™é€€å‡º
          tail -f /home/appuser/firefox.log || true
          
          echo "ğŸ›‘ Session ended by monitor script (Download detected)."

      # 6. ä¸Šä¼ äº§ç‰©
      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: decrypted-app
          path: /home/appuser/Downloads/*.ipa
