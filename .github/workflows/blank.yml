name: Playwright VNC (FullScreen Google)
on: 
  workflow_dispatch:

jobs:
  browser-gui:
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.40.0-jammy
      options: --shm-size=2gb # é˜²æ­¢ Chrome å´©æºƒçš„å…³é”®
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install GUI & Tools
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          apt-get update
          apt-get install -y --no-install-recommends xvfb fluxbox x11vnc python3 python3-pip git net-tools curl ca-certificates
          
          # å®‰è£… noVNC
          git clone https://github.com/novnc/noVNC.git /opt/noVNC
          git clone https://github.com/novnc/websockify /opt/noVNC/utils/websockify
          ln -s /opt/noVNC/vnc.html /opt/noVNC/index.html

      - name: Create Browser Script
        run: |
          # åˆ›å»ºä¸€ä¸ª Python è„šæœ¬æ¥ç²¾å‡†æ§åˆ¶æµè§ˆå™¨å¯åŠ¨
          cat <<EOF > run_browser.py
          from playwright.sync_api import sync_playwright
          import time

          print("Starting Playwright...")
          with sync_playwright() as p:
              # å¯åŠ¨ Chromiumï¼Œå‚æ•°é’ˆå¯¹ Docker ç¯å¢ƒä¼˜åŒ–
              browser = p.chromium.launch(
                  headless=False,
                  args=[
                      "--start-maximized",      # æœ€å¤§åŒ–çª—å£
                      "--no-sandbox",           # å®¹å™¨å†…å¿…é¡»
                      "--disable-setuid-sandbox",
                      "--disable-gpu",          # è½¯ä»¶æ¸²æŸ“ï¼Œé˜²æ­¢é»‘å±
                      "--disable-dev-shm-usage" # å†…å­˜ä¼˜åŒ–
                  ]
              )
              # viewport=None é…åˆ start-maximized å®ç°çœŸæ­£å…¨å±
              context = browser.new_context(viewport=None)
              page = context.new_page()
              
              print("Navigating to Google...")
              try:
                  page.goto("https://www.google.com")
                  print("Page loaded!")
              except Exception as e:
                  print(f"Error loading page: {e}")

              # ä¿æŒæµè§ˆå™¨è¿è¡Œï¼Œä¸é€€å‡º
              while True:
                  time.sleep(10)
          EOF

      - name: Start Desktop Environment
        run: |
          # 1. å¯åŠ¨è™šæ‹Ÿå±å¹• (1280x800)
          Xvfb :99 -screen 0 1280x800x24 &
          export DISPLAY=:99
          
          # 2. å¯åŠ¨çª—å£ç®¡ç†å™¨ (Fluxbox)
          fluxbox &
          
          # 3. å¯åŠ¨ VNC Server (å¯†ç : secret)
          x11vnc -display :99 -forever -passwd secret -bg
          
          # 4. å¯åŠ¨ noVNC (6080 -> 5900)
          /opt/noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
          
          # ç­‰å¾…ç«¯å£å°±ç»ª
          echo "Waiting for noVNC..."
          for i in {1..10}; do
            if netstat -tuln | grep 6080; then break; fi
            sleep 1
          done

      - name: Launch Browser (FullScreen)
        run: |
          export DISPLAY=:99
          # åå°è¿è¡Œ Python è„šæœ¬å¯åŠ¨æµè§ˆå™¨
          nohup python3 run_browser.py > browser.log 2>&1 &
          echo "Browser launch command sent."

      - name: Start Cloudflare Tunnel
        run: |
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          dpkg -i cloudflared.deb

          # å¯åŠ¨éš§é“
          cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          echo "Starting tunnel..."
          sleep 8
          
          TUNNEL_URL=$(grep -oE "https://[a-zA-Z0-9-]+\.trycloudflare\.com" tunnel.log | head -1)
          
          if [ -z "$TUNNEL_URL" ]; then
            echo "Error: Failed to get tunnel URL. Logs:"
            cat tunnel.log
            exit 1
          fi

          VNC_URL="$TUNNEL_URL/vnc.html?autoconnect=true&password=secret"

          echo "=========================================================="
          echo "ğŸš€ è¿œç¨‹æµè§ˆå™¨å·²å…¨å±å¯åŠ¨ï¼"
          echo ""
          echo "ğŸ”— ç‚¹å‡»è¿›å…¥: $VNC_URL"
          echo "=========================================================="

      - name: Keep Alive (20 min)
        run: sleep 1200
