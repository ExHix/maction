name: Playwright Web VNC (Browser Remote Control)
on: 
  workflow_dispatch:

jobs:
  browser-gui:
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.40.0-jammy
      # éœ€è¦å…±äº«å†…å­˜ä»¥é¿å…æµè§ˆå™¨å´©æºƒ
      options: --shm-size=2gb
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install GUI & VNC Tools
        run: |
          apt-get update
          # å®‰è£… X11, çª—å£ç®¡ç†å™¨, VNC server, å’Œ Python (noVNC éœ€è¦)
          apt-get install -y xvfb fluxbox x11vnc python3 python3-pip git net-tools
          
          # ä¸‹è½½ noVNC (Webç‰ˆ VNC å®¢æˆ·ç«¯)
          git clone https://github.com/novnc/noVNC.git /opt/noVNC
          git clone https://github.com/novnc/websockify /opt/noVNC/utils/websockify
          
          # ç”Ÿæˆä¸€ä¸ªç®€å•çš„ html å…¥å£ï¼Œè‡ªåŠ¨è¿žæŽ¥
          ln -s /opt/noVNC/vnc.html /opt/noVNC/index.html

      - name: Get Public IP (For Tunnel Auth)
        id: public_ip
        run: |
          IP=$(curl -s https://api.ipify.org)
          echo "Runner Public IP: $IP"
          echo "ip=$IP" >> $GITHUB_OUTPUT

      - name: Start Desktop Environment
        run: |
          # 1. å¯åŠ¨è™šæ‹Ÿå±å¹• :99
          Xvfb :99 -screen 0 1280x720x24 &
          export DISPLAY=:99
          
          # 2. å¯åŠ¨çª—å£ç®¡ç†å™¨ (ä¸ç„¶æµè§ˆå™¨æ²¡æ³•æ‹–åŠ¨/æœ€å¤§åŒ–)
          fluxbox &
          
          # 3. å¯åŠ¨ VNC Server (è®¾ç½®å¯†ç ä¸º secret)
          x11vnc -display :99 -forever -passwd secret -bg
          
          # 4. å¯åŠ¨ noVNC (å°† VNC è½¬ä¸º Web æµé‡ï¼Œç«¯å£ 6080)
          /opt/noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
          
          echo "Desktop environment started."

      - name: Launch Browser (Visual Mode)
        run: |
          export DISPLAY=:99
          
          # è¿™é‡Œæˆ‘ä»¬å¯åŠ¨ Playwright çš„ Codegen æ¨¡å¼ï¼Œæˆ–è€…ç›´æŽ¥å¯åŠ¨ Chromium
          # Codegen æ¨¡å¼æœ€å¥½ï¼Œå› ä¸ºå®ƒä¼šåŒæ—¶æ‰“å¼€ä¸€ä¸ªæµè§ˆå™¨å’Œä¸€ä¸ªä»£ç ç”Ÿæˆçª—å£ï¼Œæ–¹ä¾¿ä½ è°ƒè¯•
          nohup npx playwright codegen wikipedia.org &
          
          echo "Browser launched in background."

      - name: Start Tunnel & Show Link
        env:
          RUNNER_IP: ${{ steps.public_ip.outputs.ip }}
        run: |
          npm install -g localtunnel

          # ç©¿é€ 6080 ç«¯å£ (noVNC çš„ Web ç«¯å£)
          lt --port 6080 > tunnel.log 2>&1 &
          
          echo "Waiting for tunnel URL..."
          sleep 5
          
          TUNNEL_URL=$(grep -oE "https://[a-zA-Z0-9-]+\.loca\.lt" tunnel.log | head -1)
          
          if [ -z "$TUNNEL_URL" ]; then
            echo "Error: Failed to get tunnel URL."
            cat tunnel.log
            exit 1
          fi

          echo "=========================================================="
          echo "ðŸ–¥ï¸  æµè§ˆå™¨è¿œç¨‹æ¡Œé¢å·²å°±ç»ªï¼"
          echo ""
          echo "1ï¸âƒ£  éªŒè¯ IP: å¿…é¡»å…ˆæ‰“å¼€é“¾æŽ¥è¾“å…¥ä¸‹æ–¹ IP"
          echo "ðŸ‘‰  GitHub Runner IP: $RUNNER_IP"
          echo ""
          echo "2ï¸âƒ£  è®¿é—®åœ°å€: $TUNNEL_URL/vnc.html?autoconnect=true&password=secret"
          echo "    (å¦‚æžœç‚¹å‡»åŽç™½å±ï¼Œè¯·ç‚¹å‡»å·¦ä¾§ä¾§è¾¹æ  -> Settings -> Scaling Mode -> Local Scaling)"
          echo "=========================================================="

      - name: Keep Alive (20 min)
        run: sleep 1200
