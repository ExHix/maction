name: Manual Download & Auto-Archive
on: 
  workflow_dispatch:

jobs:
  download-ipa:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:22.04
      options: --privileged --shm-size=2gb
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. 安装环境 (包含 zip 工具)
      - name: Install System & Firefox
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          apt-get update
          apt-get install -y software-properties-common wget curl git net-tools sudo debconf-utils vim zip
          
          add-apt-repository -y ppa:mozillateam/ppa
          
          echo '
          Package: *
          Pin: release o=LP-PPA-mozillateam
          Pin-Priority: 1001
          ' | tee /etc/apt/preferences.d/mozilla-firefox
          
          apt-get update
          apt-get install -y firefox fonts-liberation fonts-noto-color-emoji fontconfig ttf-mscorefonts-installer xvfb fluxbox x11vnc python3 pulseaudio dbus-x11
          
          echo "ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true" | debconf-set-selections
          fc-cache -f -v
          
          git clone https://github.com/novnc/noVNC.git /opt/noVNC
          git clone https://github.com/novnc/websockify /opt/noVNC/utils/websockify
          ln -s /opt/noVNC/vnc.html /opt/noVNC/index.html
          chmod -R 777 /opt/noVNC

      # 2. 配置自动下载 Profile
      - name: Setup User & Auto-Download Profile
        run: |
          useradd -m -s /bin/bash appuser
          
          su appuser -c "mkdir -p /home/appuser/Downloads"
          su appuser -c "mkdir -p /home/appuser/.mozilla/firefox/stealth.default"
          
          su appuser -c "cat <<EOF > /home/appuser/.mozilla/firefox/profiles.ini
          [Profile0]
          Name=default; IsRelative=1; Path=stealth.default; Default=1
          [General]
          StartWithLastProfile=1; Version=2
          EOF"
          
          # 核心修改：添加自动下载配置
          su appuser -c "cat <<EOF > /home/appuser/.mozilla/firefox/stealth.default/user.js
          // 反爬 & 隐私设置
          user_pref(\"dom.webdriver.enabled\", false);
          user_pref(\"general.useragent.override\", \"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:120.0) Gecko/20100101 Firefox/120.0\");
          user_pref(\"privacy.trackingprotection.enabled\", false);
          user_pref(\"network.cookie.cookieBehavior\", 0);
          
          // --- 自动下载配置 ---
          // 0=桌面, 1=系统下载, 2=自定义
          user_pref(\"browser.download.folderList\", 2);
          // 指定下载目录
          user_pref(\"browser.download.dir\", \"/home/appuser/Downloads\");
          user_pref(\"browser.download.useDownloadDir\", true);
          // 对这些类型的文件不弹窗，直接保存 (ipa本质是zip)
          user_pref(\"browser.helperApps.neverAsk.saveToDisk\", \"application/octet-stream,application/zip,application/x-zip,application/x-zip-compressed\");
          EOF"

      # 3. 启动桌面
      - name: Start Desktop
        run: |
          service dbus start || true
          
          su appuser -c 'export DISPLAY=:99 && export HOME=/home/appuser && Xvfb :99 -screen 0 1280x800x24 & sleep 2 && fluxbox &'
          x11vnc -display :99 -forever -passwd secret -bg -noxdamage
          /opt/noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
          sleep 3

      # 4. 启动 Firefox, 隧道, 和下载监控
      - name: Launch Firefox, Tunnel & Monitor
        run: |
          # 创建监控脚本
          cat <<EOF > /home/appuser/monitor.sh
          #!/bin/bash
          echo "Starting download monitor..."
          while true; do
            # 查找小于100MB的ipa文件
            IPA_FILE=\$(find /home/appuser/Downloads -name "*.ipa" -size -100M -type f -print -quit)
            
            if [ -n "\$IPA_FILE" ]; then
              echo "Detected file: \$IPA_FILE"
              # 等待5秒，确认文件大小不再变化
              SIZE1=\$(stat -c%s "\$IPA_FILE")
              sleep 5
              SIZE2=\$(stat -c%s "\$IPA_FILE")

              if [ "\$SIZE1" -eq "\$SIZE2" ]; then
                echo "Download appears complete. Verifying integrity..."
                # 校验IPA文件 (zip完整性测试)
                if zip -T "\$IPA_FILE"; then
                  echo "IPA file is valid. Signaling completion."
                  # 将文件路径写入 GITHUB_ENV 供后续步骤使用
                  echo "IPA_PATH=\$IPA_FILE" >> \$GITHUB_ENV
                  # 创建信号文件
                  touch /tmp/download_complete
                  break
                else
                  echo "Error: IPA file is corrupt. Continuing scan..."
                  rm -f "\$IPA_FILE" # 删除坏文件
                fi
              fi
            fi
            sleep 5
          done
          EOF
          
          chmod +x /home/appuser/monitor.sh
          
          # 启动所有服务
          su appuser -c 'export DISPLAY=:99 && export HOME=/home/appuser && nohup firefox --no-remote "https://decrypt.day/app/id1489932710" > /home/appuser/firefox.log 2>&1 &'
          su appuser -c '/home/appuser/monitor.sh > /home/appuser/monitor.log 2>&1 &'
          
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb && dpkg -i cloudflared.deb
          cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          sleep 8
          TUNNEL_URL=$(grep -oE "https://[a-zA-Z0-9-]+\.trycloudflare\.com" tunnel.log | head -1)
          echo "✅ VNC Ready: $TUNNEL_URL/vnc.html?autoconnect=true&password=secret"

      # 5. 等待下载或超时 (20分钟)
      - name: Wait for Download or Timeout
        id: wait_for_download
        run: |
          echo "Waiting for you to download the file... (Timeout: 20 minutes)"
          for i in {1..240}; do
            if [ -f /tmp/download_complete ]; then
              echo "✅ Download complete signal received!"
              echo "downloaded=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            sleep 5
          done
          echo "❌ Timed out after 20 minutes."
          echo "downloaded=false" >> $GITHUB_OUTPUT
          exit 1

      # 6. 关闭所有服务 (无论成功失败都执行)
      - name: Shutdown Services
        if: always()
        run: |
          echo "Shutting down all services..."
          pkill -f firefox || true
          pkill -f x11vnc || true
          pkill -f Xvfb || true
          pkill -f fluxbox || true
          pkill -f cloudflared || true

      # 7. 上传 IPA 文件
      - name: Upload IPA Artifact
        if: steps.wait_for_download.outputs.downloaded == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: downloaded-ipa
          path: ${{ env.IPA_PATH }}
          retention-days: 5```
