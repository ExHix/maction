name: Windows RDP Crawler (Fixed Logs)
on: 
  workflow_dispatch:

jobs:
  win-rdp:
    runs-on: windows-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set User Password
        shell: powershell
        run: |
          $password = "SecretPass123!"
          net user runneradmin $password
          echo "Password set successfully."

      - name: Install Python & Playwright
        shell: powershell
        run: |
          pip install playwright
          playwright install chromium
          python -m playwright install chromium

      - name: Create Python Script
        shell: powershell
        run: |
          $scriptContent = @"
          import time
          from playwright.sync_api import sync_playwright

          print('--- Starting Windows Chrome ---')
          try:
              with sync_playwright() as p:
                  # Use channel='chrome' to look more like a real user
                  browser = p.chromium.launch(headless=False, channel="chrome", args=["--start-maximized"])
                  context = browser.new_context(viewport=None)
                  page = context.new_page()
                  
                  print('--- Navigating to Google... ---')
                  try:
                      page.goto("https://www.google.com")
                  except:
                      pass
                  
                  print('--- Browser Ready. Waiting for RDP... ---')
                  while True:
                      time.sleep(10)
          except Exception as e:
              print(f"Error: {e}")
              while True:
                   time.sleep(10)
          "@
          Set-Content -Path run_win.py -Value $scriptContent

      - name: Enable RDP Access
        shell: powershell
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -value 1

      - name: Start Ngrok Tunnel
        shell: powershell
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          if ($env:NGROK_AUTH_TOKEN -eq "") {
            Write-Error "Error: NGROK_AUTH_TOKEN is missing in GitHub Secrets."
            exit 1
          }
          
          # Download Ngrok
          Invoke-WebRequest -Uri https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip
          Expand-Archive ngrok.zip -DestinationPath . -Force
          
          # Config Token
          .\ngrok.exe config add-authtoken $env:NGROK_AUTH_TOKEN
          
          # Start Tunnel (Fixed: Output to separate files)
          Start-Process -FilePath ".\ngrok.exe" -ArgumentList "tcp 3389 --log=stdout" -RedirectStandardOutput ngrok_stdout.log -RedirectStandardError ngrok_stderr.log -WindowStyle Hidden -PassThru
          
          Write-Host "Waiting for Ngrok tunnel to initialize..."
          
          $url = $null
          for ($i=1; $i -le 20; $i++) {
            try {
              $response = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -ErrorAction Stop
              $url = $response.tunnels[0].public_url
              if ($url) { break }
            } catch {
              Write-Host "Attempt ${i}: Ngrok API not ready yet..."
              Start-Sleep -Seconds 1
            }
          }

          if (-not $url) {
            Write-Error "Failed to get tunnel URL. Ngrok might have failed to start."
            
            Write-Host "=== Ngrok Stdout Log ==="
            if (Test-Path ngrok_stdout.log) { Get-Content ngrok_stdout.log }
            
            Write-Host "=== Ngrok Stderr Log ==="
            if (Test-Path ngrok_stderr.log) { Get-Content ngrok_stderr.log }
            
            exit 1
          }
          
          # Clean URL
          $cleanUrl = $url -replace "tcp://", ""
          
          Write-Host "======================================================"
          Write-Host "‚úÖ Windows RDP Ready!"
          Write-Host ""
          Write-Host "üëâ Address: $cleanUrl"
          Write-Host "üëâ Username: runneradmin"
          Write-Host "üëâ Password: SecretPass123!"
          Write-Host ""
          Write-Host "‚ö†Ô∏è Note: Make sure your Ngrok account has email verified."
          Write-Host "======================================================"

      - name: Run Browser & Keep Alive
        shell: powershell
        run: |
          python run_win.py
