name: Debug Playwright VNC
on: 
  workflow_dispatch:

jobs:
  debug-browser:
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.40.0-jammy
      options: --shm-size=2gb --security-opt seccomp=unconfined
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          apt-get update
          apt-get install -y xvfb fluxbox x11vnc python3 python3-pip git net-tools curl ca-certificates procps
          
          # ÂÆâË£Ö noVNC
          git clone https://github.com/novnc/noVNC.git /opt/noVNC
          git clone https://github.com/novnc/websockify /opt/noVNC/utils/websockify
          ln -s /opt/noVNC/vnc.html /opt/noVNC/index.html

      - name: Setup Python Script
        run: |
          cat <<EOF > run_browser.py
          import sys
          import time
          from playwright.sync_api import sync_playwright

          print("--- [PYTHON] Script started ---")
          try:
              with sync_playwright() as p:
                  print("--- [PYTHON] Launching Chromium... ---")
                  browser = p.chromium.launch(
                      headless=False,
                      args=[
                          "--start-maximized",
                          "--no-sandbox",
                          "--disable-setuid-sandbox",
                          "--disable-dev-shm-usage",
                          "--disable-gpu" 
                      ]
                  )
                  print("--- [PYTHON] Browser launched object created ---")
                  
                  context = browser.new_context(viewport=None)
                  page = context.new_page()
                  
                  print("--- [PYTHON] Navigating to Google... ---")
                  page.goto("https://www.google.com")
                  print("--- [PYTHON] Page Title:", page.title())
                  
                  # Â∞ùËØïÊà™ÂõæÈ™åËØÅ
                  page.screenshot(path="debug_screenshot.png")
                  print("--- [PYTHON] Screenshot taken (Internal check) ---")

                  print("--- [PYTHON] Entering Keep-Alive Loop ---")
                  while True:
                      time.sleep(10)
          except Exception as e:
              print(f"!!! [PYTHON ERROR] !!! : {e}")
              sys.exit(1)
          EOF

      - name: Start Environment (Xvfb & VNC)
        run: |
          # 1. ÂêØÂä® Xvfb
          Xvfb :99 -screen 0 1280x800x24 &
          export DISPLAY=:99
          echo "Xvfb started on :99"
          
          # 2. ÂêØÂä® Fluxbox
          fluxbox &
          echo "Fluxbox started"
          
          # 3. ÂêØÂä® VNC
          x11vnc -display :99 -forever -passwd secret -bg -noxdamage
          echo "VNC Server started"

          # 4. ÂêØÂä® noVNC
          /opt/noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
          echo "noVNC started"

      - name: Start Cloudflare Tunnel
        run: |
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          dpkg -i cloudflared.deb
          cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &

      - name: üî¥ RUN BROWSER & SHOW LOGS
        run: |
          export DISPLAY=:99
          
          echo "Starting python script in background..."
          # ÂÖ≥ÈîÆ‰øÆÊîπÔºöÁõ¥Êé•ËøêË°åÂπ∂ÈáçÂÆöÂêëËæìÂá∫Ôºå‰∏ç‰ΩøÁî® nohup
          python3 run_browser.py > browser_output.txt 2>&1 &
          PID=$!
          echo "Python Process ID: $PID"
          
          echo "Waiting 10 seconds for browser to initialize..."
          sleep 10
          
          echo "==================== BROWSER LOGS START ===================="
          cat browser_output.txt
          echo "==================== BROWSER LOGS END   ===================="
          
          echo "Checking active processes..."
          ps aux | grep -E "python|chrome|playwright"
          
          # Â¶ÇÊûúËøõÁ®ãÊ≠ªÊéâ‰∫ÜÔºåËÆ© Action Êä•ÈîôÈÄÄÂá∫
          if ! kill -0 $PID 2>/dev/null; then
            echo "‚ùå CRITICAL: Browser script has crashed!"
            exit 1
          else
            echo "‚úÖ Browser script is still running."
          fi

      - name: Get Tunnel URL
        run: |
          sleep 5
          TUNNEL_URL=$(grep -oE "https://[a-zA-Z0-9-]+\.trycloudflare\.com" tunnel.log | head -1)
          echo "üîó  ËÆøÈóÆÂú∞ÂùÄ: $TUNNEL_URL/vnc.html?autoconnect=true&password=secret"

      - name: Keep Alive
        run: sleep 1200
